dsl:
  name: "gentil-feedback"
  version: "0.5.0"
  description: >
    Product feedback + roadmap comms + voting + user-testing panel.
    Multi-village identity with global accounts that survive village changes.

# ---------- Tenancy & Identity ----------
tenancy:
  organisation_id: "club-med"
  villages:
    - id: "vlg-001"
      name: "La Rosière"
  identity:
    id_strategy: "global_user_id"   # never tied to village
    id_format: "usr_${ulid}"
    recovery:
      allow_email_change: true
      allow_hris_link: true
      allowed_idp: ["AzureAD", "Keycloak"]
      secondary_identifiers: ["employee_id", "phone", "personal_email"]
    attributes:
      - key: "employee_id"           # stable across villages
        unique: true
      - key: "primary_email"
        unique: true
      - key: "display_name"
      - key: "current_village_id"
      - key: "village_history"       # array of {village_id, from, to}
    privacy:
      gdpr:
        consent_required: ["research_contact", "usage_analytics", "email_updates"]
        data_retention_days:
          feedback: 1825
          research_records: 1095
          pii_backups: 30

# ---------- Roles & Permissions ----------
access_control:
  roles: ["USER", "PM", "PO", "RESEARCHER", "ADMIN", "MODERATOR"]
  # High-level policy matrix (coarse-grained; engines can enforce fine-grained rules)
  policies:
    - action: "feedback.create"
      allow: ["USER", "PM", "PO"]
    - action: "feedback.edit_own"
      allow: ["USER"]
    - action: "feedback.merge"
      allow: ["PM", "PO", "MODERATOR"]
    - action: "vote.cast"
      allow: ["USER", "PM", "PO"]
    - action: "roadmap.publish"
      allow: ["PM", "PO"]
    - action: "questionnaire.publish"
      allow: ["RESEARCHER", "PM"]
    - action: "panel.invite"
      allow: ["RESEARCHER", "PM"]
    - action: "session.schedule"
      allow: ["RESEARCHER"]
    - action: "moderation.review"
      allow: ["MODERATOR", "PM", "PO"]
    - action: "export.research"
      allow: ["RESEARCHER", "PM"]
      conditions:
        - name: "requires_consent"
          param: "research_contact"
    - action: "admin.*"
      allow: ["ADMIN"]

# ---------- Feature Catalog ----------
features:
  taxonomy:
    product_areas: ["Reservations", "Check-in", "Payments", "Housekeeping", "Backoffice"]
    tags_allowed: true
  items:
    - id: "feat-checkin-mobile"
      title: "Mobile Check-in"
      area: "Check-in"
      tags: ["rx", "guest-experience"]
      status: "generally_available"  # idea | discovery | shaping | in_progress | released | GA | deprecated

# ---------- Feedback ----------
feedback:
  schema:
    id: "fb_${ulid}"
    author_id: "usr_${ulid}"
    created_at: "iso_datetime"
    village_context: "vlg_* | null"    # UPDATED: Clarified usage (optional village ID)
    product_area: "Reservations | CheckIn | Payments | Housekeeping | Backoffice | null"  # NEW: Product taxonomy
    visibility: "public" # public | internal
    source: "app|web|kiosk|support|import"
    body:
      title_max_len: 120
      body_max_len: 5000
      attachments: true
      i18n: true
    relations:
      feature_refs: ["feat-*"]        # zero or more
      duplicate_of: "fb_* | null"
    moderation:
      status: "auto_pending|approved|rejected|needs_info"
      signals: ["toxicity", "spam", "pii", "off_topic"]
  rules:
    - name: "dedupe_title_fuzzy"
      threshold: 0.86
    - name: "rate_limit_per_user_per_day"
      limit: 10
    - name: "allow_edit_window_minutes"
      value: 15
  states:
    - "new"        # created, awaiting triage
    - "triaged"    # tagged, routed
    - "merged"     # merged into canonical
    - "in_roadmap" # accepted and linked to roadmap item
    - "closed"     # resolved / declined with reason

# ---------- Voting ----------
voting:
  model: "weighted"    # simple | weighted
  weight_sources: ["role_weight", "village_priority", "panel_member_boost"]
  constraints:
    per_user_per_item: 1
    allow_downvotes: false
    decay:
      half_life_days: 180           # votes slowly decay to favor recency
  transparency:
    show_counts: true
    show_weight_rules: true

# ---------- Roadmap & Comms ----------
roadmap:
  items:
    schema:
      id: "rmp_${ulid}"
      title: "string"
      stage: "now|next|later|under_consideration"
      links:
        features: ["feat-*"]
        canonical_feedback: ["fb-*"]
        jira: ["JIRA-123"]
        figma: ["https://figma.com/file/..."]
      comms:
        # scheduled updates visible to users (changelog-like)
        cadence: "monthly|ad_hoc"
        channels: ["in-app", "email", "inbox"]
        audience_filters:
          villages: ["vlg-*|all"]
          roles: ["USER|STAFF_ONLY"]
          languages: ["fr|en|all"]
      metrics:
        success_criteria: ["reduce_checkin_time_lt_2min", "nps_area>=+30"]
        guardrails: ["error_rate<0.5%", "perf_p95<800ms"]

# ---------- Research: Panels, Questionnaires, Sessions ----------
research:
  panels:
    schema:
      id: "pan_${ulid}"
      name: "string"
      description: "string"              # NEW: Panel description
      created_by_id: "usr_${ulid}"       # NEW: Creator tracking
      archived: "boolean"                # NEW: Soft delete support
      eligibility_rules:
        include_roles: ["USER"]
        include_villages: ["vlg-*|all"]
        attributes_predicates:
          - key: "department"
            op: "in"
            value: ["FOH", "Reception"]
        required_consents: ["research_contact"]
      size_target: 150
      quotas:
        - key: "village_id"
          distribution: "proportional"
  questionnaires:
    schema:
      id: "qnn_${ulid}"
      title: "string"
      versioning: "semver"
      question_types: ["likert", "nps", "mcq_single", "mcq_multiple", "text", "number"]  # NEW: All supported types
      questions:
        - id: "q1"
          type: "likert"     # likert | nps | mcq_single | mcq_multiple | text | number
          text: { en: "How satisfied are you with X?", fr: "Votre satisfaction pour X ?" }
          scale: 1..5
          required: true
        - id: "q2"
          type: "text"
          text: { en: "Additional comments?", fr: "Commentaires supplémentaires ?" }
          required: false
      targeting:
        panels: ["pan-*"]
        ad_hoc_filters:
          villages: ["vlg-*|all"]
          features_interacted: ["feat-*"]
      delivery:
        mode: ["in-app", "email"]
        start_at: "iso_datetime"
        end_at: "iso_datetime"
        max_responses: 500
      analytics:
        aggregate_exports: ["csv", "parquet"]
        pii_included: false
  sessions:
    schema:
      id: "ses_${ulid}"
      type: "usability|interview|prototype_walkthrough|remote_test"
      prototype_link_optional: true
      scheduled_at: "iso_datetime"
      duration_minutes: 45
      facilitators: ["usr-*"]
      participants:
        min: 1
        max: 6
        recruitment:
          from_panels: ["pan-*"]
          custom_invites: true
      consent_required: true
      recording:
        enabled: true
        storage_days: 365
      notes_secure: true

# ---------- Auth & Account Recovery ----------
auth:
  idp: ["AzureAD", "Keycloak"]
  account_recovery_flows:
    - name: "email_reclaim"
      steps: ["verify_old_email_or_phone", "set_new_email", "confirm_idp_link"]
    - name: "hris_reclaim"
      steps: ["match_employee_id+dob", "verify_sms", "confirm_idp_link"]
  session_policies:
    max_devices: 5
    enforcement: "latest_5_only"

# ---------- Moderation ----------
moderation:
  workflows:
    - name: "auto-screen"
      actions: ["pii_redact", "toxicity_score", "spam_score"]
    - name: "human-review"
      sla_hours: 48
      assignees: ["MODERATOR"]
  redaction:
    pii_fields: ["phone", "email", "room_number", "reservation_id"]
    strategy: "mask_keep_last4"

# ---------- Integrations ----------
integrations:
  trackers:
    jira:
      project_keys: ["ODYS", "PMS"]
      auto_issue_from_feedback: false
      field_mappings:
        feedback_id -> customfield_12345
  design:
    figma:
      allowed_domains: ["figma.com"]
  messaging:
    email:
      provider: "sendgrid"
    in_app:
      provider: "internal"
  analytics:
    event_bus: "kafka:feedback-topic"
    sinks: ["kibana", "bigquery"]
  identity_graph:
    hris:
      keys: ["employee_id"]
      sync: "daily"

# ---------- Events (for pipelines & automations) ----------
events:
  schema_version: 1
  types:
    - key: "feedback.created"
      payload: ["feedback_id", "author_id", "village_id?", "feature_refs[]", "source"]
    - key: "feedback.merged"
      payload: ["from_feedback_id", "to_feedback_id", "by_user_id"]
    - key: "vote.cast"
      payload: ["feedback_id", "voter_id", "weight"]
    - key: "roadmap.published"
      payload: ["roadmap_item_id", "stage"]
    - key: "questionnaire.response.recorded"
      payload: ["questionnaire_id", "respondent_id", "score_map", "free_text_redacted"]
    - key: "session.completed"
      payload: ["session_id", "participant_ids[]", "notes_uri"]

# ---------- Metrics (computed) ----------
metrics:
  feedback:
    - key: "feedback_volume_7d"
      formula: "count(feedback where created_at in last_7d)"
    - key: "vote_weight_sum"
      formula: "sum(votes.weight)"
    - key: "merge_rate"
      formula: "count(merged)/count(total)"
  research:
    - key: "questionnaire_completion_rate"
      formula: "completed / invited"
    - key: "recruitment_lead_time_days"
      formula: "avg(session.scheduled_at - invite.sent_at)"
  product:
    - key: "nps_area"
      formula: "nps(qnn where type==nps grouped by product_area)"
    - key: "idea_to_delivery_days"
      formula: "avg(release_date - first_feedback_date)"

# ---------- UI Hints (optional) ----------
ui_hints:
  feedback:
    show_duplicate_suggestions: true
    show_village_selector: true         # NEW: Show village context dropdown
    show_product_area_selector: true    # NEW: Show product area dropdown
    auto_populate_village: true         # NEW: Auto-fill with currentVillageId
    editor:
      min_title_chars: 8
      min_body_chars: 20
  roadmap:
    group_by: "stage"
    show_vote_counts_on_linked_feedback: true
  research:
    badge_consent_status: true
    panels:
      show_eligibility_preview: true    # NEW: Show eligibility preview button
      preview_sample_size: 10           # NEW: Number of sample users to show
      quota_visualization: "progress_bars"  # NEW: progress_bars | pie_chart
    questionnaires:
      show_language_toggle: true        # NEW: EN/FR toggle in builder
      default_language: "en"            # NEW: Default display language
      require_both_translations: true   # NEW: Require EN+FR before publish
      analytics:
        compute_nps: true               # NEW: Auto-compute NPS scores
        segmentation: ["village", "role", "panel"]  # NEW: Segmentation options
        export_formats: ["csv", "json", "parquet"]  # NEW: Available export formats
  navigation:
    layout: "sidebar_top_bar"          # sidebar_top_bar | top_bar_only | sidebar_only
    sidebar:
      default_state: "expanded"         # expanded | collapsed
      persist_state: true               # Remember user preference in localStorage
      collapsible: true                 # Allow user to collapse sidebar
      mobile_behavior: "drawer"         # drawer | bottom_sheet
      width_expanded: "240px"           # UPDATED: 280px -> 240px
      width_collapsed: "64px"           # UPDATED: 80px -> 64px
    breadcrumbs:
      enabled: true
      show_icons: false                 # Show icons in breadcrumb items
      max_items: 4                      # Truncate long paths (e.g., Home > ... > Page)
      separator: "chevron"              # chevron | slash | dot
    mobile:
      breakpoint: "lg"                  # sm | md | lg | xl (Tailwind breakpoint)
      hamburger_position: "left"        # left | right
    active_link:
      indicator: "border_and_color"     # border_and_color | background | underline
      show_icon_highlight: true
    user_menu:
      show_profile_link: false          # NEW: Profile removed (redundant with Settings)
      show_settings_link: true          # NEW: Keep Settings link
      show_sign_out: true               # NEW: Keep Sign Out
    research_submenu:
      default_route: "/research/sessions"  # NEW: Primary destination
      show_submenu: true                # NEW: Show Sessions/Panels/Questionnaires
      items: ["sessions", "panels", "questionnaires"]  # NEW: Submenu items

# ---------- Example seed data ----------
seed:
  users:
    - id: "usr_01HZX…"
      employee_id: "E123456"
      primary_email: "alex@clubmed.com"
      display_name: "Alex R."
      current_village_id: "vlg-001"
      consents: ["research_contact", "email_updates"]
  panels:
    - id: "pan_core_reception"
      name: "Reception Core Panel"
      eligibility_rules:
        include_roles: ["USER"]
        include_villages: ["all"]
        required_consents: ["research_contact"]
  questionnaires:
    - id: "qnn_checkin_satisfaction"
      title: "Check-in Satisfaction"
      versioning: "1.0.0"
      questions:
        - { id: "nps", type: "nps", text: { en: "Recommend our check-in?", fr: "Recommanderiez-vous notre check-in ?" }, required: true }
        - { id: "free", type: "text", required: false }
      targeting:
        panels: ["pan_core_reception"]
      delivery:
        mode: ["in-app"]
        start_at: "2025-10-10T09:00:00Z"
        end_at: "2025-11-10T17:00:00Z"
        max_responses: 1000
  features:
    - { id: "feat-checkin-mobile", title: "Mobile Check-in", area: "Check-in", status: "discovery" }
  feedback_examples:
    - id: "fb_01J0…"
      author_id: "usr_01HZX…"
      created_at: "2025-10-02T12:00:00Z"
      visibility: "public"
      source: "app"
      title: "Add passport scan at kiosk"
      body: "Would reduce queue time."
      feature_refs: ["feat-checkin-mobile"]
      moderation: { status: "approved", signals: [] }
  roadmap_examples:
    - id: "rmp_01J0…"
      title: "Faster Arrival Flow"
      stage: "next"
      links:
        features: ["feat-checkin-mobile"]
        canonical_feedback: ["fb_01J0…"]
        jira: ["ODYS-2142"]
      comms:
        cadence: "monthly"
        channels: ["in-app", "email"]
        audience_filters: { villages: ["all"], roles: ["USER"], languages: ["fr", "en"] }
