# PRD-005: File Attachments for Feedback

**Version**: 1.0
**Status**: Draft
**Created**: 2025-10-09
**Author**: Product Team
**Epic**: Feedback System Enhancement

## Executive Summary

Enable users to attach files (images, documents, PDFs) to feedback submissions to provide visual context, supporting evidence, or detailed documentation. This feature enhances feedback quality by allowing users to share screenshots of bugs, mockups of ideas, or documents that clarify their suggestions.

## Current State

- **Feedback Schema**: `attachments` field exists in Prisma schema (JSON array) but is unused
- **DSL Specification**: `attachments: true` declared in `dsl/global.yaml` line 94
- **Current Limitation**: Users can only submit text-based feedback (title + body)
- **Workarounds**: Users paste URLs to external image hosting or describe visuals in text

## Motivation

### Business Value
- **Higher Quality Feedback**: Visual context reduces ambiguity and improves PM understanding
- **Reduced Clarification Cycles**: Screenshots eliminate back-and-forth questions about issues
- **Better Bug Reports**: Users can attach error screenshots, logs, or screen recordings
- **Enhanced Idea Submissions**: Mockups, sketches, or reference images support feature requests
- **Competitive Parity**: Most modern feedback platforms support file attachments

### User Pain Points
- **Bug Reporters**: "I can't show you the error screen without uploading to Imgur first"
- **Feature Requesters**: "Let me sketch what I mean" (currently impossible)
- **PMs/POs**: "I can't visualize what they're describing"
- **Researchers**: Need supporting documents (consent forms, prototypes) attached to feedback

### Risks of Not Implementing
- Incomplete or unclear feedback submissions
- Users abandon feedback when unable to attach necessary files
- PMs waste time interpreting vague descriptions
- Competitive disadvantage vs modern tools (Canny, ProductBoard)

## Goals

### Primary Goals
1. **Enable file uploads** during feedback creation (images, PDFs, documents)
2. **Display attachments** on feedback detail pages with download/preview
3. **Store files securely** with proper validation and access control
4. **Mobile-friendly** drag & drop and click-to-upload interface

### Secondary Goals
5. Support image preview/lightbox for quick viewing
6. Rate limit uploads to prevent abuse (5 files/feedback, 10MB/file)
7. Track attachment metadata (size, type, upload timestamp)

### Non-Goals
- Video uploads (consider in future PRD)
- Collaborative editing of attachments
- Attachment versioning or history
- Cloud storage integration (AWS S3, Azure Blob) - use local storage for MVP
- Image editing/annotation tools
- Virus/malware scanning (add in Phase 2)

## Success Metrics

**Launch Metrics** (First 30 days):
- âœ… 20%+ of feedback submissions include at least 1 attachment
- âœ… Zero security incidents related to file uploads
- âœ… <0.5% upload failure rate
- âœ… Upload time <3 seconds for 5MB file

**Engagement Metrics** (90 days):
- âœ… Feedback with attachments receives 30%+ more votes (hypothesis: clearer feedback)
- âœ… Time-to-triage reduced by 20% for feedback with screenshots
- âœ… User satisfaction: 80%+ find attachment feature "useful" or "very useful"

**Quality Metrics**:
- âœ… 95%+ of uploaded files successfully display in UI
- âœ… No PII leakage via filenames or metadata
- âœ… Zero GDPR compliance violations

## Requirements

### Functional Requirements

#### FR-1: File Upload Interface
**Priority**: P0
**Description**: Users can upload files during feedback creation

**Acceptance Criteria**:
- Drag & drop zone on "New Feedback" page (`/feedback/new`)
- Click-to-browse file picker fallback
- Multi-file selection (up to 5 files per feedback)
- Upload progress indicator (0-100%)
- Remove uploaded file before submission
- File preview thumbnails (images show thumbnail, docs show icon)
- Responsive design (works on mobile, tablet, desktop)

**UI Wireframe**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Title field]                         â”‚
â”‚ [Description textarea]                â”‚
â”‚                                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚  ğŸ“ Attach Files (up to 5)      â”‚  â”‚
â”‚ â”‚  Drag & drop or click to browse â”‚  â”‚
â”‚ â”‚  Max 10MB per file              â”‚  â”‚
â”‚ â”‚                                   â”‚  â”‚
â”‚ â”‚  [screenshot.png] 2.3 MB   [x]  â”‚  â”‚
â”‚ â”‚  [bug-report.pdf] 1.1 MB   [x]  â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                       â”‚
â”‚ [Product Area dropdown]               â”‚
â”‚ [Submit Feedback]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### FR-2: File Validation
**Priority**: P0
**Description**: Enforce file type, size, and count limits

**Acceptance Criteria**:
- **Allowed File Types**:
  - Images: `.jpg`, `.jpeg`, `.png`, `.gif`, `.webp`
  - Documents: `.pdf`, `.docx`, `.xlsx`, `.txt`
- **Max File Size**: 10 MB per file
- **Max Files**: 5 files per feedback submission
- **Total Limit**: 50 MB per feedback (sum of all files)
- **Client-side validation** with error messages:
  - "File type not supported. Use JPG, PNG, PDF, or DOCX"
  - "File exceeds 10MB limit"
  - "Maximum 5 files allowed"
- **Server-side validation** (defense in depth) - reject invalid uploads
- **Filename sanitization**: Remove special characters, limit length to 255 chars

#### FR-3: File Storage
**Priority**: P0
**Description**: Store uploaded files securely on server filesystem

**Acceptance Criteria**:
- Files stored in `/public/uploads/feedback/{feedbackId}/` directory
- Unique filenames using ULID: `{ulid}.{extension}` (e.g., `01HZXABC123.png`)
- Original filename preserved in database metadata (for display/download)
- Directory permissions: `755` (read/execute for public, write for server only)
- Files accessible via `/uploads/feedback/{feedbackId}/{filename}` URL
- Orphan file cleanup: Delete files if feedback creation fails

**Database Schema** (already exists):
```prisma
// Feedback.attachments: JSON array
[
  {
    "id": "01HZXABC123",
    "originalName": "screenshot.png",
    "storedName": "01HZXABC123.png",
    "url": "/uploads/feedback/fb_01HZXDEF/01HZXABC123.png",
    "size": 2345678,  // bytes
    "mimeType": "image/png",
    "uploadedAt": "2025-10-09T14:30:00Z"
  }
]
```

#### FR-4: API Endpoint - File Upload
**Priority**: P0
**Description**: Create API route for handling file uploads

**Route**: `POST /api/feedback/upload`
**Authentication**: Required (logged-in users only)
**Request**: `multipart/form-data`
**Rate Limit**: 10 requests per minute per user

**Request Body**:
```
Content-Type: multipart/form-data

files: File[] (up to 5 files)
```

**Response** (Success):
```json
{
  "success": true,
  "files": [
    {
      "id": "01HZXABC123",
      "originalName": "screenshot.png",
      "storedName": "01HZXABC123.png",
      "url": "/uploads/feedback/temp/01HZXABC123.png",
      "size": 2345678,
      "mimeType": "image/png",
      "uploadedAt": "2025-10-09T14:30:00Z"
    }
  ]
}
```

**Response** (Error):
```json
{
  "success": false,
  "error": "File size exceeds 10MB limit",
  "code": "FILE_TOO_LARGE"
}
```

**Error Codes**:
- `FILE_TOO_LARGE`: File exceeds 10MB
- `INVALID_FILE_TYPE`: Unsupported file extension
- `TOO_MANY_FILES`: More than 5 files uploaded
- `UPLOAD_FAILED`: Server error during file write
- `UNAUTHORIZED`: User not authenticated

#### FR-5: Update Feedback Creation API
**Priority**: P0
**Description**: Accept `attachments` array in feedback creation payload

**Route**: `POST /api/feedback` (update existing)
**Request Body** (new field):
```json
{
  "title": "Add passport scan at kiosk",
  "body": "Would reduce queue time.",
  "productArea": "CheckIn",
  "attachments": [  // NEW FIELD
    {
      "id": "01HZXABC123",
      "originalName": "screenshot.png",
      "storedName": "01HZXABC123.png",
      "url": "/uploads/feedback/temp/01HZXABC123.png",
      "size": 2345678,
      "mimeType": "image/png",
      "uploadedAt": "2025-10-09T14:30:00Z"
    }
  ]
}
```

**Acceptance Criteria**:
- Validate `attachments` array structure
- Move files from `/uploads/feedback/temp/` to `/uploads/feedback/{feedbackId}/`
- Update attachment URLs in database (replace `temp` with `{feedbackId}`)
- Store attachments as JSON in `Feedback.attachments` field
- Delete temporary files if validation fails

#### FR-6: Display Attachments on Feedback Detail Page
**Priority**: P0
**Description**: Show uploaded files on feedback detail page

**Acceptance Criteria**:
- Display attachments section below feedback body
- Image files show thumbnail (max 200px width/height)
- Document files show file icon + filename + size
- Click image â†’ Open in lightbox/modal for full view
- Click document â†’ Download file
- Show file count: "3 attachments" badge/label
- Responsive layout (grid on desktop, stack on mobile)

**UI Mockup**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Feedback Title]                        â”‚
â”‚ [Feedback Body]                         â”‚
â”‚                                         â”‚
â”‚ ğŸ“ Attachments (3)                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ IMG  â”‚ â”‚ IMG  â”‚ â”‚ ğŸ“„ report.pdfâ”‚     â”‚
â”‚ â”‚ 2MB  â”‚ â”‚ 1MB  â”‚ â”‚ 1.1 MB       â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                         â”‚
â”‚ [Vote button] [Share]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### FR-7: Display Attachments on Feedback List/Card
**Priority**: P1
**Description**: Show attachment indicator on feedback cards

**Acceptance Criteria**:
- Show ğŸ“ icon if feedback has attachments
- Display count: "ğŸ“ 3" next to vote count
- No thumbnail preview (keep cards compact)

#### FR-8: Edit Feedback - Manage Attachments
**Priority**: P1
**Description**: Allow users to add/remove attachments within 15-minute edit window

**Acceptance Criteria**:
- Show existing attachments on edit page
- Allow uploading additional files (up to 5 total)
- Allow removing attachments (mark deleted, remove file)
- Apply same validation rules as creation
- Update `Feedback.attachments` JSON on save

### Non-Functional Requirements

#### NFR-1: Performance
- File upload completes in <3 seconds for 5MB file
- Image thumbnail generation <500ms
- Page load with 5 attachments <2 seconds
- No blocking UI during upload (async + progress indicator)

#### NFR-2: Security
- **Authentication**: Only logged-in users can upload files
- **Authorization**: Users can only view attachments on public feedback or feedback they created
- **Filename Sanitization**: Remove `../`, shell injection characters, null bytes
- **MIME Type Validation**: Check file content, not just extension (prevent `.jpg.exe` exploits)
- **Storage Isolation**: Separate directories per feedback (`/uploads/feedback/{feedbackId}/`)
- **No Script Execution**: Files served with `Content-Disposition: attachment` for non-images
- **Rate Limiting**: 10 uploads/minute per user
- **GDPR Compliance**: PII redaction in filenames (e.g., `john.doe@email.com_screenshot.png` â†’ `01HZXABC123.png`)

#### NFR-3: Reliability
- Atomic uploads: Either all files succeed or none stored
- Retry logic on network failures (client-side)
- Graceful degradation: Feedback can be submitted without attachments if upload fails
- Orphan cleanup: Cron job to delete files in `/temp/` older than 1 hour

#### NFR-4: Accessibility
- Keyboard navigation for file picker
- Screen reader announcements for upload progress
- Alt text for image thumbnails (from filename or user-provided caption)
- ARIA labels on upload zone: "Drag files here or click to browse"

#### NFR-5: Mobile Experience
- Touch-friendly drag & drop on iOS/Android
- Camera integration: "Take photo" option on mobile devices
- Compressed uploads on slow networks (auto-resize images >2MB)

#### NFR-6: Storage & Scalability
- **MVP**: Local filesystem storage (`/public/uploads/`)
- **Production Considerations** (Future):
  - CDN for faster delivery (Cloudflare, Vercel Edge)
  - Cloud storage (AWS S3, Azure Blob) for scalability
  - Image optimization (WebP conversion, lazy loading)
  - Total storage monitoring/alerts

## Technical Design

### Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend (React + Next.js)                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚ FileUpload.tsx Component                                 â”‚
â”‚ â”‚ - Drag & drop zone                                       â”‚
â”‚ â”‚ - File validation (client-side)                          â”‚
â”‚ â”‚ - Upload progress UI                                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         â†“ POST /api/feedback/upload         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Backend (Next.js API Routes)                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚ /api/feedback/upload (NEW)                               â”‚
â”‚ â”‚ - Multipart form parsing                                 â”‚
â”‚ â”‚ - File validation (server-side)                          â”‚
â”‚ â”‚ - Save to /public/uploads/feedback/temp/                 â”‚
â”‚ â”‚ - Return file metadata                                   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         â†“ POST /api/feedback                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚ /api/feedback (UPDATED)                                  â”‚
â”‚ â”‚ - Accept attachments array                               â”‚
â”‚ â”‚ - Move files from temp/ to feedback/{id}/                â”‚
â”‚ â”‚ - Store metadata in Feedback.attachments (JSON)          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         â†“                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Database (Prisma + SQLite/PostgreSQL)                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚ Feedback.attachments: JSON                               â”‚
â”‚ â”‚ [{ id, originalName, url, size, mimeType, uploadedAt }] â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File System                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚ /public/uploads/feedback/                                â”‚
â”‚ â”‚   â”œâ”€â”€ temp/               (temporary uploads)            â”‚
â”‚ â”‚   â”œâ”€â”€ fb_01HZXABC/        (feedback attachments)         â”‚
â”‚ â”‚   â”‚   â”œâ”€â”€ 01HZXDEF.png                                   â”‚
â”‚ â”‚   â”‚   â””â”€â”€ 01HZXGHI.pdf                                   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementation Phases

#### Phase 1: File Upload Utility & API (4 hours)
**Files to Create**:
1. `src/lib/file-upload.ts` - File validation, storage logic
2. `src/app/api/feedback/upload/route.ts` - Upload API endpoint

**Key Functions**:
```typescript
// src/lib/file-upload.ts
export async function saveUploadedFile(file: File, tempDir: string): Promise<FileMetadata>
export function validateFile(file: File): ValidationResult
export function sanitizeFilename(filename: string): string
export async function moveFile(from: string, to: string): Promise<void>
export async function deleteFile(path: string): Promise<void>
```

#### Phase 2: Frontend Components (4 hours)
**Files to Create**:
1. `src/components/feedback/FileUpload.tsx` - Upload UI component
2. `src/components/feedback/AttachmentList.tsx` - Display attachments component
3. `src/components/feedback/AttachmentPreview.tsx` - Lightbox/preview modal

**Files to Update**:
1. `src/app/(authenticated)/feedback/new/page.tsx` - Integrate FileUpload
2. `src/app/(authenticated)/feedback/[id]/page.tsx` - Display attachments
3. `src/components/feedback/FeedbackCard.tsx` - Show attachment icon

#### Phase 3: Backend Integration (3 hours)
**Files to Update**:
1. `src/app/api/feedback/route.ts` - Accept attachments in POST
2. `src/types/feedback.ts` - Add `Attachment` type

#### Phase 4: Edit Functionality (2 hours)
**Files to Update**:
1. `src/app/(authenticated)/feedback/[id]/edit/page.tsx` - Manage attachments
2. `src/app/api/feedback/[id]/route.ts` - Update attachments in PATCH

#### Phase 5: Testing & Refinement (3 hours)
- Unit tests for file validation logic
- API integration tests for upload/create flow
- E2E tests for full user journey
- Security audit (filename injection, MIME type spoofing)
- Performance testing (large files, multiple uploads)

### Data Model

**Prisma Schema** (already exists, no migration needed):
```prisma
model Feedback {
  // ... existing fields
  attachments String @default("[]") // JSON array
}
```

**TypeScript Type**:
```typescript
// src/types/feedback.ts
export interface Attachment {
  id: string;                // ULID
  originalName: string;      // User's filename
  storedName: string;        // Server filename
  url: string;               // Public URL
  size: number;              // Bytes
  mimeType: string;          // e.g., "image/png"
  uploadedAt: string;        // ISO datetime
}

export interface CreateFeedbackInput {
  title: string;
  body: string;
  productArea?: ProductArea;
  villageId?: string;
  featureId?: string;
  attachments?: Attachment[]; // NEW FIELD
}
```

### File Upload Flow

**Step-by-Step**:
1. User selects files (drag & drop or file picker)
2. Client validates files (type, size, count)
3. Client uploads files to `POST /api/feedback/upload`
4. Server validates files (defense in depth)
5. Server saves files to `/public/uploads/feedback/temp/{ulid}.{ext}`
6. Server returns file metadata (id, url, size, etc.)
7. Client stores metadata in form state
8. User submits feedback form
9. Client sends `attachments` array in `POST /api/feedback`
10. Server creates feedback in database
11. Server moves files from `temp/` to `feedback/{feedbackId}/`
12. Server updates attachment URLs in database
13. Client redirects to feedback detail page
14. User sees feedback with attachments

**Error Handling**:
- If upload fails (step 3): Show error, allow retry
- If validation fails (step 9): Show error, keep files in form
- If feedback creation fails (step 10): Delete uploaded files (cleanup)
- If file move fails (step 11): Mark feedback as "attachments pending" (background job retry)

### Security Measures

#### 1. File Type Validation
```typescript
// Check MIME type AND file signature (magic bytes)
function validateFileType(file: File, buffer: Buffer): boolean {
  const allowedMimeTypes = [
    'image/jpeg', 'image/png', 'image/gif', 'image/webp',
    'application/pdf',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    'text/plain'
  ];

  // Check declared MIME type
  if (!allowedMimeTypes.includes(file.type)) return false;

  // Check file signature (first few bytes)
  const signatures = {
    jpeg: [0xFF, 0xD8, 0xFF],
    png: [0x89, 0x50, 0x4E, 0x47],
    pdf: [0x25, 0x50, 0x44, 0x46],
    // ... more signatures
  };

  // Match buffer bytes with known signatures
  return matchesSignature(buffer, signatures);
}
```

#### 2. Filename Sanitization
```typescript
function sanitizeFilename(filename: string): string {
  return filename
    .replace(/[^a-zA-Z0-9._-]/g, '_')  // Remove special chars
    .replace(/\.+/g, '.')              // Collapse multiple dots
    .substring(0, 255);                // Limit length
}
```

#### 3. Storage Isolation
- Each feedback has its own directory: `/uploads/feedback/{feedbackId}/`
- Temp uploads use random ULID names: `/uploads/feedback/temp/{ulid}.{ext}`
- No directory traversal: Validate paths before file operations

#### 4. Access Control
```typescript
// Middleware: Only allow authenticated users to upload
if (!session) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });

// Middleware: Only allow users to view attachments on public feedback or their own
const feedback = await prisma.feedback.findUnique({ where: { id } });
if (feedback.visibility !== 'public' && feedback.authorId !== session.user.id) {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
}
```

## Dependencies & Impacts

### Affected Systems
- **Feedback Creation Flow**: Add file upload step
- **Feedback Display**: Add attachments section
- **Storage**: New `/public/uploads/` directory (~5-10GB estimated for first year)
- **API Routes**: New `/api/feedback/upload` endpoint
- **Database**: No schema migration (field already exists)

### Dependency Updates Required
**None** - All functionality built with existing dependencies:
- `next` - Multipart form parsing (built-in)
- `fs/promises` - File system operations (Node.js built-in)
- `ulid` - Unique IDs (already in project)
- `mime-types` - MIME type detection (add if not present)

**Optional Dependencies** (Phase 2):
- `sharp` - Image thumbnail generation (server-side)
- `react-dropzone` - Enhanced drag & drop UX
- `yet-another-react-lightbox` - Image preview modal

### Third-Party Integrations
- **No immediate integrations** (MVP uses local storage)
- **Future**: AWS S3, Azure Blob, Cloudinary for production

## Migration & Rollout Plan

### Phase 1: Feature Flag (Week 1)
- Deploy code behind feature flag: `ENABLE_ATTACHMENTS=false`
- Test internally with PM/PO team (10 users)
- Monitor upload success rate, file storage

### Phase 2: Beta Rollout (Week 2)
- Enable for 20% of users (role-based: PM, RESEARCHER)
- Collect feedback via in-app survey
- Monitor metrics: usage rate, upload failures, storage growth

### Phase 3: General Availability (Week 3)
- Enable for all users
- Announce feature in changelog/email
- Monitor for 7 days: performance, errors, abuse

### Rollback Plan
**Rollback Triggers**:
- Upload failure rate >5%
- Security vulnerability discovered
- Storage exceeds 50GB (quota alert)
- Performance degradation (page load >3s)

**Rollback Steps**:
1. Set `ENABLE_ATTACHMENTS=false` (instant disable)
2. Revert deployment if needed
3. Keep existing attachments (read-only)
4. Communicate issue to users

## Open Questions

1. **Cloud Storage**: Should we plan for AWS S3/Azure Blob from the start, or start with local storage?
   - **Recommendation**: Start local, migrate later (avoid premature optimization)

2. **Image Compression**: Should we auto-compress images on upload to save storage?
   - **Recommendation**: Yes, resize images >2MB to max 1920px width (maintain aspect ratio)

3. **Virus Scanning**: Should we integrate antivirus (ClamAV, VirusTotal API)?
   - **Recommendation**: Add in Phase 2 (post-MVP) if abuse detected

4. **Attachment Retention**: Should we delete attachments when feedback is deleted?
   - **Recommendation**: Yes, cascade delete (follow GDPR principles)

5. **Edit History**: Should we track attachment changes (added/removed) in audit log?
   - **Recommendation**: Yes, log in `AuditLog` table for compliance

6. **Mobile Camera**: Should mobile users be able to take photos directly?
   - **Recommendation**: Yes, use `<input type="file" accept="image/*" capture="camera">`

## Success Criteria Summary

### Must Have (P0)
- âœ… Users can upload 1-5 files per feedback (images, PDFs, docs)
- âœ… Files validated (type, size, count) client & server-side
- âœ… Attachments display on feedback detail page
- âœ… Upload success rate >95%
- âœ… Zero security incidents

### Should Have (P1)
- âœ… Image preview/lightbox functionality
- âœ… Drag & drop upload interface
- âœ… Mobile-friendly (camera integration)
- âœ… Upload progress indicator
- âœ… Edit attachments within 15-minute window

### Nice to Have (P2)
- âœ… Image thumbnail generation (server-side)
- âœ… Auto-compression for large images
- âœ… Attachment search/filter (future)
- âœ… Cloud storage integration (AWS S3)
- âœ… Virus scanning (ClamAV)

## Timeline & Effort Estimate

| Phase | Duration | Owner |
|-------|----------|-------|
| File Upload Utility & API | 4 hours | Backend Engineer |
| Frontend Components | 4 hours | Frontend Engineer |
| Backend Integration | 3 hours | Backend Engineer |
| Edit Functionality | 2 hours | Fullstack Engineer |
| Testing & Security Audit | 3 hours | QA + Security |
| Documentation | 1 hour | Technical Writer |
| Beta Rollout & Monitoring | 1 week | Product Manager |
| **Total Development** | **16 hours** | **~2 days** |
| **Total Launch** | **3 weeks** | **Incl. rollout** |

### Critical Path
1. File Upload API â†’ Frontend Component â†’ Feedback API Integration â†’ Testing â†’ Beta Rollout â†’ GA

### Parallel Work Opportunities
- Frontend components can be built while API is in progress (mock data)
- Documentation during testing phase
- Beta rollout preparation during QA

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Storage quota exceeded | Medium | High | Monitor usage, add alerts at 80%, plan cloud migration |
| Malicious file upload (XSS, malware) | Low | Critical | MIME validation, filename sanitization, virus scanning (Phase 2) |
| Performance degradation (large files) | Medium | Medium | File size limits (10MB), compression, lazy loading |
| GDPR compliance (PII in filenames) | Low | High | Sanitize filenames, use ULID-based storage names |
| Upload failures on slow networks | High | Medium | Retry logic, chunked uploads (future), progress indicator |
| Abuse (spam uploads) | Low | Medium | Rate limiting (10/min), monitoring, user reporting |

## References

- **DSL Specification**: `dsl/global.yaml` (line 94: `attachments: true`)
- **Prisma Schema**: `prisma/schema.prisma` (line 236: `attachments String`)
- **Next.js File Uploads**: https://nextjs.org/docs/app/building-your-application/routing/route-handlers#request-body
- **Secure File Upload Best Practices**: OWASP Unrestricted File Upload

## Approval & Sign-off

| Role | Name | Date | Signature |
|------|------|------|-----------|
| Product Manager | TBD | | |
| Engineering Lead | TBD | | |
| Security Lead | TBD | | |
| Design Lead | TBD | | |

---

**Document History**:
- v1.0 (2025-10-09): Initial draft
