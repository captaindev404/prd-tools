# PRD-009: User Management Enhancements - User Creation

**Version**: 1.0
**Status**: Draft
**Created**: 2025-10-09
**Author**: Product Team
**Epic**: Admin Tools - User Management

## Executive Summary

Enhance the user management system by adding user creation capabilities, enabling administrators to manually add users to the platform without requiring SSO authentication. This fills a critical gap in the admin toolset and enables scenarios like pre-provisioning accounts, adding external consultants, and testing with synthetic users.

The enhancement will add a "Create User" button to the existing `/admin/users` page, a comprehensive creation dialog with validation, and a POST API endpoint to persist new users to the database with proper audit logging.

## Current State

### What Exists Today

- ‚úÖ **User List Page**: `/admin/users` with search, filters, and pagination (src/app/(authenticated)/admin/users/page.tsx)
- ‚úÖ **User Detail Page**: `/admin/users/[userId]` showing individual user information
- ‚úÖ **User Table Component**: Displays users with actions (view, edit role, edit village, deactivate)
- ‚úÖ **User Update API**: PATCH `/api/admin/users` to update role, village, consents
- ‚úÖ **User Fetch API**: GET `/api/admin/users` with filtering and pagination
- ‚úÖ **Edit Dialogs**: EditRoleDialog, EditVillageDialog for inline updates
- ‚úÖ **User Types**: Complete TypeScript definitions in `src/types/admin.ts`

### What's Missing

- ‚ùå **"Create User" Button**: No way to initiate user creation from UI
- ‚ùå **Create User Dialog/Form**: No form to input new user details
- ‚ùå **POST API Endpoint**: No `/api/admin/users` POST route to create users
- ‚ùå **User Creation Validation**: No validation logic for new user data
- ‚ùå **Duplicate Email Check**: No check to prevent duplicate users
- ‚ùå **Employee ID Generation**: No logic to generate unique employee IDs
- ‚ùå **Initial Password Handling**: No password setup workflow (if not using SSO)

### Current User Experience

```
Admin needs to add a new user
  ‚Üì
Opens /admin/users page
  ‚Üì
Looks for "Add User" or "Create User" button
  ‚Üì
Button doesn't exist
  ‚Üì
"How do I add users?"
  ‚Üì
(Blocked - must ask developer to add user manually via database)
```

## Motivation

### Business Value

**1. Self-Service User Management** ($8K+ annual value)
- Admins can add users without developer intervention
- Reduce support requests: "Please add user X to the system"
- Enable rapid onboarding for new employees

**2. Improved Operational Efficiency** (50% faster onboarding)
- User creation: 30 minutes (manual DB insert) ‚Üí 2 minutes (UI form)
- No context switching (Slack ‚Üí database ‚Üí Slack)
- Immediate validation (no "oops, typo in email" errors)

**3. Better Testing & Demos**
- Create test users for QA environments
- Pre-populate demo accounts for product showcases
- Synthetic users for load testing

**4. Support External Users** (Critical for Phase 2)
- Add consultants, contractors, external partners
- Not all users have SSO credentials
- Manual provisioning for special cases

**5. Enhanced Governance**
- Audit trail: Who created which users and when
- Standardized user creation process (no ad-hoc database edits)
- Validation ensures data quality (proper email format, unique IDs)

### User Pain Points

**Administrator**:
- "I need to add a new PM urgently, but I can't do it myself"
- "Creating test users for QA requires asking a developer every time"
- "I accidentally created a duplicate user because I didn't know one existed"

**Developer (Support Burden)**:
- "30% of my Slack DMs are 'Can you add user X with role Y?'"
- "Manual database inserts are error-prone (typos, missing fields)"
- "No audit trail when I add users directly via Prisma Studio"

**Product Manager**:
- "I can't demo new features because test accounts don't exist"
- "Onboarding a new team member takes days (waiting for IT + waiting for developer)"

### Why User Creation is Critical

1. **Incomplete Admin Tool**: User management without creation is like a CMS without "New Post"
2. **Operational Bottleneck**: Developer becomes single point of failure for user provisioning
3. **Poor UX**: Admins expect create/read/update/delete (CRUD) operations‚Äîwe only have RUD
4. **Testing Friction**: QA team blocked waiting for test accounts
5. **Scalability**: Won't scale to 500+ users if every addition requires manual database work

### Risks of Not Implementing

1. **Support Burden**: 20+ support requests/month for user creation
2. **Onboarding Delays**: New employees wait 2-3 days for platform access
3. **Data Quality**: Ad-hoc database insertions lead to inconsistencies (missing fields, bad formats)
4. **No Audit Trail**: Manual DB edits not logged (compliance risk)
5. **User Frustration**: Admins feel system is "incomplete" or "not production-ready"

## Goals

### Primary Goals (P0)

1. **Add "Create User" Button**
   - Prominent button on `/admin/users` page
   - Opens create user dialog (modal)
   - Permission-gated (ADMIN role only)

2. **Create User Dialog**
   - Form fields: Email, Employee ID, Display Name, Role, Village, Preferred Language
   - Validation: Email format, unique email, unique employee ID
   - Optional fields: Bio, Avatar URL
   - "Create User" and "Cancel" buttons

3. **POST API Endpoint**
   - Route: `POST /api/admin/users`
   - Validates input (Zod schema)
   - Checks for duplicate email/employee ID
   - Creates user in database (Prisma)
   - Logs creation event to audit trail
   - Returns created user data

4. **Validation & Error Handling**
   - Client-side validation (instant feedback)
   - Server-side validation (security)
   - Clear error messages: "Email already exists", "Employee ID must be unique"
   - Handle edge cases (empty fields, invalid email format)

5. **Audit Trail**
   - Log event: `admin.user.created`
   - Payload: New user ID, email, role, created by (admin email)
   - Timestamp and admin user ID

### Secondary Goals (P1)

6. **Employee ID Auto-Generation**
   - Option to auto-generate employee ID (e.g., `EMP-001234`)
   - Check box: "Auto-generate Employee ID"
   - Format: `EMP-{6-digit-number}` (e.g., EMP-001234)

7. **Welcome Email** (Optional)
   - Checkbox: "Send welcome email"
   - Email template with login instructions
   - Link to set password (if not using SSO)
   - Integration with SendGrid (if available)

8. **Bulk User Import** (Future Enhancement)
   - Upload CSV with multiple users
   - Validate rows, create in batch
   - Show import summary (X created, Y failed)

### Non-Goals (Out of Scope)

- ‚ùå **Password Management**: Assume SSO (Azure AD/Keycloak) for authentication (no password field)
- ‚ùå **Email Verification**: No email confirmation workflow (assume internal users with verified emails)
- ‚ùå **User Self-Registration**: Only admins can create users (no public signup)
- ‚ùå **LDAP/Active Directory Sync**: Manual creation only (no auto-sync from external systems)
- ‚ùå **Role Hierarchy**: All roles equal for creation (no "ADMIN can't create ADMIN" restriction, except self-demotion)
- ‚ùå **Advanced Permissions**: Simple ADMIN-only access (no granular "can create PM but not ADMIN" rules)
- ‚ùå **User Activation Workflow**: Users active by default (no pending/inactive state)

## Success Metrics

### Adoption Metrics (First 30 Days)
- ‚úÖ **50+ users created via UI**: Down from 0 (all manual)
- ‚úÖ **Zero manual database user insertions**: Admins use UI exclusively
- ‚úÖ **<5 support requests for user creation**: Down from 20+/month

### Efficiency Metrics (90 Days)
- ‚úÖ **<2 minutes average creation time**: User testing benchmark
- ‚úÖ **95%+ first-try success rate**: No validation errors on submission
- ‚úÖ **100% audit compliance**: All creations logged to Event table

### Quality Metrics
- ‚úÖ **Zero duplicate users**: Email/employee ID uniqueness enforced
- ‚úÖ **100% valid email formats**: Client + server validation
- ‚úÖ **Zero data quality issues**: All required fields populated

## Requirements

### Functional Requirements

#### FR-1: Add "Create User" Button
**Priority**: P0
**Description**: Add prominent button to initiate user creation

**Acceptance Criteria**:
- Button location: Top right of `/admin/users` page (next to search/filters)
- Button text: "Create User" (with UserPlus icon)
- Button style: Primary (default Shadcn blue)
- Button disabled if user is not ADMIN
- Tooltip if disabled: "Only administrators can create users"
- Click opens CreateUserDialog modal

**UI Mockup**:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ User Management                   [+ Create User]  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ [üîç Search] [Role Filter] [Village Filter]        ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ [User Table]                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### FR-2: Create User Dialog
**Priority**: P0
**Description**: Modal form to input new user details

**Form Fields**:

1. **Email** (Required)
   - Type: Email input
   - Validation: Valid email format, unique (not already in database)
   - Placeholder: "user@clubmed.com"
   - Error: "Email is required", "Invalid email format", "Email already exists"

2. **Employee ID** (Required)
   - Type: Text input with auto-generate option
   - Validation: Unique (not already in database), alphanumeric, max 50 chars
   - Placeholder: "EMP-001234"
   - Checkbox: "Auto-generate Employee ID"
   - Error: "Employee ID is required", "Employee ID already exists"

3. **Display Name** (Optional)
   - Type: Text input
   - Validation: Max 100 characters
   - Placeholder: "John Doe"

4. **Role** (Required)
   - Type: Select dropdown
   - Options: USER, PM, PO, RESEARCHER, MODERATOR, ADMIN
   - Default: USER
   - Error: "Role is required"

5. **Village** (Optional)
   - Type: Select dropdown (searchable)
   - Options: Fetched from `/api/admin/villages`
   - Placeholder: "Select village..."
   - Can be left empty (user not assigned to village)

6. **Preferred Language** (Required)
   - Type: Select dropdown
   - Options: English (en), French (fr)
   - Default: English
   - Error: "Language is required"

**Advanced Fields** (collapsible section):
7. **Bio** (Optional)
   - Type: Textarea
   - Validation: Max 500 characters
   - Placeholder: "Short bio..."

8. **Avatar URL** (Optional)
   - Type: URL input
   - Validation: Valid URL format
   - Placeholder: "https://example.com/avatar.jpg"

**Actions**:
- "Create User" button (primary)
  - Disabled until form is valid
  - Shows loading spinner when submitting
- "Cancel" button (secondary)
  - Closes dialog without creating user
  - Confirms if form is dirty: "Discard changes?"

**UI Mockup**:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Create New User                            [√ó]     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Email *                                            ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ ‚îÇ user@clubmed.com                             ‚îÇ  ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ Employee ID *          ‚òê Auto-generate             ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ ‚îÇ EMP-001234                                   ‚îÇ  ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ Display Name                                       ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ ‚îÇ John Doe                                     ‚îÇ  ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ Role *                  Preferred Language *       ‚îÇ
‚îÇ [USER ‚ñº]                [English ‚ñº]                ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ Village                                            ‚îÇ
‚îÇ [Select village... ‚ñº]                              ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ [‚ñº Advanced Options]                               ‚îÇ
‚îÇ                                                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ [Cancel]                         [Create User]     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### FR-3: POST API Endpoint
**Priority**: P0
**Description**: Create new user in database

**Route**: `POST /api/admin/users`
**Authentication**: Required (ADMIN only)
**Rate Limit**: 10 requests/minute

**Request Body**:
```json
{
  "email": "john.doe@clubmed.com",
  "employeeId": "EMP-001234",
  "displayName": "John Doe",
  "role": "PM",
  "currentVillageId": "vlg-001",
  "preferredLanguage": "en",
  "bio": "Product Manager for Reservations",
  "avatarUrl": "https://example.com/avatar.jpg"
}
```

**Validation Rules**:
- `email`: Required, valid email format, unique
- `employeeId`: Required, alphanumeric + hyphens, max 50 chars, unique
- `displayName`: Optional, max 100 chars
- `role`: Required, one of: USER, PM, PO, RESEARCHER, MODERATOR, ADMIN
- `currentVillageId`: Optional, must exist in Village table
- `preferredLanguage`: Required, one of: "en", "fr"
- `bio`: Optional, max 500 chars
- `avatarUrl`: Optional, valid URL format

**Response** (201 Created):
```json
{
  "success": true,
  "data": {
    "id": "usr_01HZX...",
    "email": "john.doe@clubmed.com",
    "employeeId": "EMP-001234",
    "displayName": "John Doe",
    "role": "PM",
    "currentVillageId": "vlg-001",
    "preferredLanguage": "en",
    "bio": "Product Manager for Reservations",
    "avatarUrl": "https://example.com/avatar.jpg",
    "createdAt": "2025-10-09T14:30:00Z",
    "updatedAt": "2025-10-09T14:30:00Z"
  },
  "message": "User created successfully"
}
```

**Error Responses**:
- 400: Validation failed
  ```json
  {
    "error": "Validation failed",
    "details": [
      { "field": "email", "message": "Email already exists" },
      { "field": "employeeId", "message": "Employee ID already exists" }
    ]
  }
  ```
- 401: Unauthorized (not logged in)
- 403: Forbidden (not ADMIN role)
- 500: Internal server error

**Database Operations**:
1. Validate input with Zod schema
2. Check email uniqueness: `prisma.user.findUnique({ where: { email } })`
3. Check employee ID uniqueness: `prisma.user.findUnique({ where: { employeeId } })`
4. Generate user ID: `usr_${ulid()}`
5. Create user: `prisma.user.create({ data: {...} })`
6. Log event: `prisma.event.create({ type: 'admin.user.created', ... })`
7. Return created user

**Acceptance Criteria**:
- API accepts valid user data and creates user
- API rejects duplicate email: 400 error "Email already exists"
- API rejects duplicate employee ID: 400 error "Employee ID already exists"
- API logs creation event to Event table
- API returns full user object with timestamps

#### FR-4: Validation Logic
**Priority**: P0
**Description**: Client-side and server-side validation

**Client-Side Validation** (Real-time):
- Email format: Show error immediately on blur
- Employee ID format: Alphanumeric + hyphens only
- Display Name length: Show character count (0/100)
- Bio length: Show character count (0/500)
- Avatar URL format: Must be valid URL
- Required fields: Show error if empty on submit

**Server-Side Validation** (Defense in depth):
```typescript
import { z } from 'zod';

const createUserSchema = z.object({
  email: z.string()
    .email('Invalid email format')
    .max(255, 'Email must not exceed 255 characters'),
  employeeId: z.string()
    .min(1, 'Employee ID is required')
    .max(50, 'Employee ID must not exceed 50 characters')
    .regex(/^[A-Za-z0-9-_]+$/, 'Employee ID must be alphanumeric with hyphens/underscores'),
  displayName: z.string()
    .max(100, 'Display name must not exceed 100 characters')
    .optional(),
  role: z.enum(['USER', 'PM', 'PO', 'RESEARCHER', 'MODERATOR', 'ADMIN'], {
    message: 'Invalid role'
  }),
  currentVillageId: z.string().optional(),
  preferredLanguage: z.enum(['en', 'fr'], {
    message: 'Language must be "en" or "fr"'
  }),
  bio: z.string()
    .max(500, 'Bio must not exceed 500 characters')
    .optional(),
  avatarUrl: z.string()
    .url('Invalid URL format')
    .optional(),
});
```

**Uniqueness Checks** (Database queries):
```typescript
// Check email uniqueness
const existingUser = await prisma.user.findUnique({
  where: { email },
});
if (existingUser) {
  return NextResponse.json(
    { error: 'Validation failed', details: [{ field: 'email', message: 'Email already exists' }] },
    { status: 400 }
  );
}

// Check employee ID uniqueness
const existingEmployeeId = await prisma.user.findUnique({
  where: { employeeId },
});
if (existingEmployeeId) {
  return NextResponse.json(
    { error: 'Validation failed', details: [{ field: 'employeeId', message: 'Employee ID already exists' }] },
    { status: 400 }
  );
}
```

**Acceptance Criteria**:
- Client shows inline errors on blur (email format, length limits)
- Client disables submit until form is valid
- Server validates all fields with Zod
- Server checks email uniqueness before insert
- Server checks employee ID uniqueness before insert
- Errors mapped to specific fields (not generic "validation failed")

#### FR-5: Employee ID Auto-Generation
**Priority**: P1
**Description**: Optional auto-generation of unique employee IDs

**Format**: `EMP-{6-digit-number}` (e.g., `EMP-000001`, `EMP-012345`)

**Logic**:
1. Find highest existing employee ID matching pattern `EMP-\d{6}`
2. Parse number, increment by 1
3. Pad with zeros to 6 digits
4. Return `EMP-{newNumber}`
5. Handle race conditions (use transaction or retry logic)

**Implementation**:
```typescript
async function generateEmployeeId(): Promise<string> {
  // Find all users with EMP-* pattern
  const users = await prisma.user.findMany({
    where: {
      employeeId: {
        startsWith: 'EMP-',
      },
    },
    select: {
      employeeId: true,
    },
    orderBy: {
      employeeId: 'desc',
    },
    take: 1,
  });

  if (users.length === 0) {
    return 'EMP-000001';
  }

  const lastId = users[0].employeeId;
  const match = lastId.match(/^EMP-(\d{6})$/);
  if (!match) {
    return 'EMP-000001';
  }

  const nextNumber = parseInt(match[1], 10) + 1;
  return `EMP-${nextNumber.toString().padStart(6, '0')}`;
}
```

**UI Interaction**:
- Checkbox: "Auto-generate Employee ID"
- When checked: Disable employee ID input field, show loading spinner
- On dialog open (if auto-generate checked): Call API to generate ID
- Display generated ID in disabled field
- User can uncheck to manually enter ID

**Acceptance Criteria**:
- Auto-generated IDs are unique
- IDs follow format `EMP-{6-digit-number}`
- Next ID is always highest + 1
- No collisions (handle race conditions)
- User can opt-out and enter manual ID

#### FR-6: Audit Trail
**Priority**: P0
**Description**: Log all user creation events

**Event Type**: `admin.user.created`

**Payload**:
```json
{
  "newUserId": "usr_01HZX...",
  "newUserEmail": "john.doe@clubmed.com",
  "newUserRole": "PM",
  "newUserEmployeeId": "EMP-001234",
  "createdByUserId": "usr_01HZY...",
  "createdByEmail": "admin@clubmed.com",
  "timestamp": "2025-10-09T14:30:00Z"
}
```

**Implementation**:
```typescript
await prisma.event.create({
  data: {
    type: 'admin.user.created',
    userId: adminUser.id, // Who created the user
    payload: JSON.stringify({
      newUserId: createdUser.id,
      newUserEmail: createdUser.email,
      newUserRole: createdUser.role,
      newUserEmployeeId: createdUser.employeeId,
      createdByUserId: adminUser.id,
      createdByEmail: adminUser.email,
      timestamp: new Date().toISOString(),
    }),
  },
});
```

**Acceptance Criteria**:
- Every user creation logged to Event table
- Event includes admin who created user
- Event includes new user's email, role, employee ID
- Timestamp recorded
- Event queryable for audit reports

#### FR-7: Error Handling & Loading States
**Priority**: P0
**Description**: Graceful handling of errors and async operations

**Loading States**:
- Dialog open: "Loading villages..." (fetch villages API)
- Auto-generate employee ID: Spinner in employee ID field
- Submit: "Creating user..." (disable form, show spinner on button)

**Error States**:
- Network error: "Failed to create user. Please check your connection and try again."
- Validation error: Show field-specific errors (email, employee ID, etc.)
- Duplicate email: "A user with this email already exists. Please use a different email."
- Server error: "An unexpected error occurred. Please try again later."

**Success State**:
- Toast notification: "User created successfully!"
- Auto-close dialog
- Refresh user list (reload page or optimistic update)
- Optionally navigate to new user's detail page: `/admin/users/{newUserId}`

**Acceptance Criteria**:
- Loading spinners shown during async operations
- Errors displayed clearly with actionable messages
- Success state closes dialog and shows confirmation
- User list refreshed after creation

### Non-Functional Requirements

#### NFR-1: Performance
**Acceptance Criteria**:
- Dialog opens in <300ms
- Employee ID generation: <500ms
- User creation: <2 seconds (including validation and logging)
- No UI blocking during async operations

#### NFR-2: Security
**Acceptance Criteria**:
- Authentication required: Only logged-in users access API
- Authorization enforced: Only ADMIN role can create users
- Input sanitization: Prevent XSS (sanitize bio, display name)
- SQL injection prevention: Prisma ORM (parameterized queries)
- Rate limiting: 10 user creations per minute (prevent abuse)
- CSRF protection: Next.js built-in token validation

#### NFR-3: Accessibility (WCAG 2.1 Level AA)
**Acceptance Criteria**:
- Keyboard navigation: Tab through all form fields
- Screen reader support:
  - Form labels ARIA-associated with inputs
  - Error announcements: ARIA live region for validation errors
  - Button states: "Creating user..." announced
- Focus management: Focus first field on dialog open, return focus on close
- Color contrast: 4.5:1 minimum for all text
- Error indicators: Not color-only (use icons + text)

#### NFR-4: Data Integrity
**Acceptance Criteria**:
- Atomic operations: User creation either succeeds completely or rolls back
- Unique constraints: Email and employee ID enforced at database level
- Validation: Client + server validation (defense in depth)
- Audit log: Every creation logged (no silent failures)
- Idempotent: Multiple submits don't create duplicates (disabled button during submit)

## Technical Design

### Component Structure

#### CreateUserDialog Component
**File**: `src/components/admin/create-user-dialog.tsx`

```tsx
'use client';

import { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { useToast } from '@/hooks/use-toast';
import { Loader2, UserPlus } from 'lucide-react';
import { Role } from '@prisma/client';

const createUserSchema = z.object({
  email: z.string().email('Invalid email format'),
  employeeId: z.string().min(1, 'Employee ID is required').max(50),
  displayName: z.string().max(100).optional(),
  role: z.enum(['USER', 'PM', 'PO', 'RESEARCHER', 'MODERATOR', 'ADMIN']),
  currentVillageId: z.string().optional(),
  preferredLanguage: z.enum(['en', 'fr']),
  bio: z.string().max(500).optional(),
  avatarUrl: z.string().url('Invalid URL').optional().or(z.literal('')),
});

type FormValues = z.infer<typeof createUserSchema>;

interface CreateUserDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onSuccess: () => void;
}

export function CreateUserDialog({ open, onOpenChange, onSuccess }: CreateUserDialogProps) {
  const { toast } = useToast();
  const [loading, setLoading] = useState(false);
  const [villages, setVillages] = useState<Array<{ id: string; name: string }>>([]);
  const [autoGenerateId, setAutoGenerateId] = useState(false);
  const [generatingId, setGeneratingId] = useState(false);

  const form = useForm<FormValues>({
    resolver: zodResolver(createUserSchema),
    defaultValues: {
      email: '',
      employeeId: '',
      displayName: '',
      role: 'USER',
      currentVillageId: '',
      preferredLanguage: 'en',
      bio: '',
      avatarUrl: '',
    },
  });

  useEffect(() => {
    if (open) {
      fetchVillages();
    }
  }, [open]);

  useEffect(() => {
    if (autoGenerateId) {
      generateEmployeeId();
    }
  }, [autoGenerateId]);

  const fetchVillages = async () => {
    try {
      const response = await fetch('/api/admin/villages');
      if (!response.ok) throw new Error();
      const data = await response.json();
      setVillages(data);
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to load villages',
        variant: 'destructive',
      });
    }
  };

  const generateEmployeeId = async () => {
    setGeneratingId(true);
    try {
      const response = await fetch('/api/admin/users/generate-employee-id');
      if (!response.ok) throw new Error();
      const data = await response.json();
      form.setValue('employeeId', data.employeeId);
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to generate employee ID',
        variant: 'destructive',
      });
      setAutoGenerateId(false);
    } finally {
      setGeneratingId(false);
    }
  };

  const onSubmit = async (values: FormValues) => {
    setLoading(true);
    try {
      const response = await fetch('/api/admin/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(values),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.details?.[0]?.message || 'Failed to create user');
      }

      toast({
        title: 'Success',
        description: 'User created successfully',
      });

      form.reset();
      onOpenChange(false);
      onSuccess();
    } catch (error) {
      toast({
        title: 'Error',
        description: error instanceof Error ? error.message : 'Failed to create user',
        variant: 'destructive',
      });
    } finally {
      setLoading(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Create New User</DialogTitle>
          <DialogDescription>
            Add a new user to the platform. All fields marked with * are required.
          </DialogDescription>
        </DialogHeader>

        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <FormField
              control={form.control}
              name="email"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Email *</FormLabel>
                  <FormControl>
                    <Input placeholder="user@clubmed.com" {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="employeeId"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Employee ID *</FormLabel>
                  <div className="flex items-center gap-2 mb-2">
                    <Checkbox
                      checked={autoGenerateId}
                      onCheckedChange={(checked) => setAutoGenerateId(!!checked)}
                    />
                    <span className="text-sm">Auto-generate Employee ID</span>
                  </div>
                  <FormControl>
                    <div className="relative">
                      <Input
                        placeholder="EMP-001234"
                        {...field}
                        disabled={autoGenerateId}
                      />
                      {generatingId && (
                        <Loader2 className="absolute right-3 top-2.5 h-4 w-4 animate-spin" />
                      )}
                    </div>
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Additional fields... */}

            <div className="flex justify-end gap-2 pt-4">
              <Button
                type="button"
                variant="outline"
                onClick={() => onOpenChange(false)}
                disabled={loading}
              >
                Cancel
              </Button>
              <Button type="submit" disabled={loading}>
                {loading ? (
                  <>
                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    Creating...
                  </>
                ) : (
                  <>
                    <UserPlus className="mr-2 h-4 w-4" />
                    Create User
                  </>
                )}
              </Button>
            </div>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```

### API Implementation

#### POST /api/admin/users
**File**: `src/app/api/admin/users/route.ts`

Add POST handler:
```typescript
/**
 * POST /api/admin/users
 * Create a new user (ADMIN only)
 */
export async function POST(req: NextRequest) {
  try {
    const user = await getCurrentUser();

    if (!user || !isAdmin(user)) {
      return NextResponse.json(
        { error: 'Unauthorized. Admin access required.' },
        { status: 403 }
      );
    }

    const body = await req.json();

    // Validate with Zod
    const validationResult = createUserSchema.safeParse(body);
    if (!validationResult.success) {
      return NextResponse.json(
        {
          error: 'Validation failed',
          details: validationResult.error.issues.map((issue) => ({
            field: issue.path.join('.'),
            message: issue.message,
          })),
        },
        { status: 400 }
      );
    }

    const data = validationResult.data;

    // Check email uniqueness
    const existingEmail = await prisma.user.findUnique({
      where: { email: data.email },
    });
    if (existingEmail) {
      return NextResponse.json(
        {
          error: 'Validation failed',
          details: [{ field: 'email', message: 'Email already exists' }],
        },
        { status: 400 }
      );
    }

    // Check employee ID uniqueness
    const existingEmployeeId = await prisma.user.findUnique({
      where: { employeeId: data.employeeId },
    });
    if (existingEmployeeId) {
      return NextResponse.json(
        {
          error: 'Validation failed',
          details: [{ field: 'employeeId', message: 'Employee ID already exists' }],
        },
        { status: 400 }
      );
    }

    // Create user
    const newUser = await prisma.user.create({
      data: {
        id: `usr_${ulid()}`,
        email: data.email,
        employeeId: data.employeeId,
        displayName: data.displayName,
        role: data.role,
        currentVillageId: data.currentVillageId || null,
        preferredLanguage: data.preferredLanguage,
        bio: data.bio || null,
        avatarUrl: data.avatarUrl || null,
        consents: '[]', // Empty array
        consentHistory: '[]', // Empty array
        villageHistory: '[]', // Empty array
      },
      include: {
        currentVillage: {
          select: {
            id: true,
            name: true,
          },
        },
      },
    });

    // Log creation event
    await prisma.event.create({
      data: {
        type: 'admin.user.created',
        userId: user.id,
        payload: JSON.stringify({
          newUserId: newUser.id,
          newUserEmail: newUser.email,
          newUserRole: newUser.role,
          newUserEmployeeId: newUser.employeeId,
          createdByUserId: user.id,
          createdByEmail: user.email,
          timestamp: new Date().toISOString(),
        }),
      },
    });

    return NextResponse.json(
      {
        success: true,
        data: newUser,
        message: 'User created successfully',
      },
      { status: 201 }
    );
  } catch (error) {
    console.error('Error creating user:', error);
    return NextResponse.json(
      { error: 'Failed to create user' },
      { status: 500 }
    );
  }
}
```

### Implementation Phases

#### Phase 1: API Endpoint (2 hours)
**Files to Create/Update**:
1. `src/app/api/admin/users/route.ts` - Add POST handler
2. `src/app/api/admin/users/generate-employee-id/route.ts` - Auto-generation endpoint

**Tasks**:
- Implement POST handler with validation
- Add Zod schema for create user
- Check email/employee ID uniqueness
- Generate ULID for user ID
- Log creation event to Event table
- Implement employee ID generation endpoint

#### Phase 2: Create User Dialog (3 hours)
**Files to Create**:
1. `src/components/admin/create-user-dialog.tsx` - Main dialog component

**Tasks**:
- Build form with react-hook-form + Zod
- Add all form fields (email, employee ID, role, etc.)
- Implement auto-generate employee ID checkbox
- Add client-side validation
- Handle form submission (POST to API)
- Success/error handling with toasts

#### Phase 3: Page Integration (1 hour)
**Files to Update**:
1. `src/app/(authenticated)/admin/users/page.tsx` - Add "Create User" button

**Tasks**:
- Import CreateUserDialog component
- Add "Create User" button to page header
- Manage dialog open/close state
- Refresh user list after creation

#### Phase 4: Testing (2 hours)
**Manual Testing Checklist**:
- [ ] Create user with all required fields
- [ ] Create user with optional fields (bio, avatar URL)
- [ ] Auto-generate employee ID works correctly
- [ ] Validation errors display for invalid email
- [ ] Duplicate email shows clear error
- [ ] Duplicate employee ID shows clear error
- [ ] User appears in list after creation
- [ ] Audit log records creation event
- [ ] Non-admin users can't access create dialog
- [ ] Mobile responsive layout works

**Edge Cases**:
- Empty form submission (all required fields empty)
- Invalid email format (test@, @test.com, etc.)
- Very long display name (>100 chars)
- Invalid avatar URL format
- No villages available (village dropdown empty)
- Network failure (timeout, 500 error)
- Rapid double-submit (idempotency)

#### Phase 5: Documentation (1 hour)
**Files to Update**:
1. `docs/API.md` - Document POST /api/admin/users
2. `docs/USER_GUIDE.md` - Add "Creating Users" section
3. `CHANGELOG.md` - Add feature entry

## Dependencies & Impacts

### Affected Systems
- **User Management Page**: Add "Create User" button and dialog
- **User API**: New POST endpoint
- **User Table**: Refresh after creation
- **Audit Logs**: New event type `admin.user.created`
- **Database**: No schema changes (User model already complete)

### No New Dependencies
All functionality built with existing packages.

### Database Impact
**None** - User model schema already supports all fields.

## Migration & Rollout Plan

### Phase 1: Development & Testing (Week 1)
**Goal**: Build and test create user feature

**Tasks**:
1. Implement POST /api/admin/users (Day 1-2)
2. Build CreateUserDialog component (Days 3-4)
3. Integrate with users page (Day 5)
4. Testing and bug fixes (Days 5-7)

**Success Criteria**:
- All tests pass
- No TypeScript errors
- Manual testing completed

### Phase 2: Staging Deployment (Week 2)
**Goal**: Validate with internal admins

**Rollout**:
- Deploy to staging environment
- Test with 2 admins (create 10+ test users)
- Collect feedback: "Is process intuitive?"
- Monitor error logs

**Success Criteria**:
- 2/2 admins successfully create users
- <2 minutes average creation time
- Zero critical bugs

### Phase 3: Production Launch (Week 3)
**Goal**: Roll out to all admins

**Rollout**:
- Deploy to production
- Announce in Slack #admin channel
- Update user guide documentation
- Monitor audit logs (track usage)

**Communication**:
- Slack announcement: "You can now create users from the admin panel!"
- Email to admins: "New feature: Self-service user creation"
- FAQ: "How do I create a user?" ‚Üí Link to user guide

**Success Criteria**:
- 50+ users created in first month
- Zero manual database user insertions
- <5 support tickets

### Rollback Plan

**Rollback Triggers**:
- Critical bug (duplicate users created)
- Security vulnerability (unauthorized access)
- Data corruption (invalid user data)

**Rollback Steps**:
1. **Immediate**: Remove "Create User" button (hide feature)
2. **Communication**: Notify admins in Slack
3. **Fix**: Debug issue in staging, test thoroughly
4. **Redeploy**: Fix in production after validation

**Rollback Complexity**: Low (UI-only change, no database migration)

## Open Questions

1. **Initial Password**: Should we support password-based login in addition to SSO?
   - **Recommendation**: No, assume SSO only for MVP (Azure AD/Keycloak)

2. **Welcome Email**: Should we send welcome emails automatically?
   - **Recommendation**: Phase 2 feature (requires SendGrid integration)

3. **User Activation**: Should users be active immediately or require activation?
   - **Recommendation**: Active by default (trust internal users)

4. **Role Restrictions**: Should ADMINs be able to create other ADMINs?
   - **Recommendation**: Yes, no restriction (assume trust)

5. **Bulk Import**: Should we support CSV upload for bulk user creation?
   - **Recommendation**: Phase 2 feature (after validating single-user workflow)

6. **Avatar Upload**: Should we support direct avatar image upload?
   - **Recommendation**: No, use avatar URL field (assume external hosting)

## Success Criteria Summary

### Must Have (P0)
- ‚úÖ "Create User" button on /admin/users page
- ‚úÖ Create user dialog with validation
- ‚úÖ POST /api/admin/users endpoint
- ‚úÖ Email and employee ID uniqueness checks
- ‚úÖ Audit logging (admin.user.created event)
- ‚úÖ 50+ users created via UI in first month

### Should Have (P1)
- ‚úÖ Employee ID auto-generation
- ‚úÖ Responsive design (works on tablet/mobile)
- ‚úÖ Clear error messages
- ‚úÖ Loading states during async operations
- ‚úÖ User list refresh after creation

### Nice to Have (P2)
- Welcome email on user creation
- Bulk user import (CSV upload)
- Avatar image upload (not just URL)
- User activation workflow (pending ‚Üí active)
- Role hierarchy (ADMIN can't create ADMIN)

## Timeline & Effort Estimate

| Phase | Duration | Owner | Dependencies |
|-------|----------|-------|--------------|
| API Endpoint | 2 hours | Backend Engineer | - |
| Create User Dialog | 3 hours | Frontend Engineer | API endpoint |
| Page Integration | 1 hour | Frontend Engineer | Dialog component |
| Testing | 2 hours | QA Engineer | - |
| Documentation | 1 hour | Technical Writer | - |
| Staging Deployment | 1 week | Product Manager | Code merged |
| **Total Development** | **9 hours** | **~1.5 dev days** | - |
| **Total Launch** | **3 weeks** | **Incl. rollout** | - |

### Critical Path
1. API Endpoint ‚Üí Dialog Component ‚Üí Page Integration ‚Üí Testing ‚Üí Staging ‚Üí Production

### Parallel Work Opportunities
- Documentation during testing phase
- User guide updates during staging deployment
- Admin training materials during testing

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Duplicate users created | Low | High | Unique constraints at database level, server-side validation |
| Unauthorized user creation | Low | Critical | ADMIN-only access enforced at API level, double-check permissions |
| Invalid data (bad email, missing fields) | Medium | Medium | Client + server validation, Zod schema enforcement |
| Race condition (duplicate employee IDs) | Low | Medium | Use database transaction for ID generation, retry logic |
| UI confusing (users don't find button) | Low | Low | Prominent "Create User" button, user testing before launch |
| Performance issues (slow API) | Low | Low | Pagination and indexing already in place, creation is single row insert |

## References

- **User Management Page**: `src/app/(authenticated)/admin/users/page.tsx` - Current list page
- **User API**: `src/app/api/admin/users/route.ts` - GET and PATCH endpoints
- **User Table**: `src/components/admin/user-table.tsx` - Table component with actions
- **User Types**: `src/types/admin.ts` - TypeScript definitions
- **Prisma Schema**: `prisma/schema.prisma` (lines 98-140) - User model
- **Edit Dialogs**: `src/components/admin/edit-role-dialog.tsx`, `edit-village-dialog.tsx` - Reference patterns

## Approval & Sign-off

| Role | Name | Date | Signature |
|------|------|------|-----------|
| Product Manager | TBD | | |
| Engineering Lead | TBD | | |
| UX Designer | TBD | | |
| Security Lead | TBD | | |

---

**Document History**:
- v1.0 (2025-10-09): Initial draft
- v1.1 (TBD): Post-feedback revisions
