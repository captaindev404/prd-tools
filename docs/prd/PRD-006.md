# PRD-006: Questionnaire Creation Interface

**Version**: 1.0
**Status**: Draft
**Created**: 2025-10-09
**Author**: Product Team
**Epic**: Research Tools - Questionnaires

## Executive Summary

Enable researchers, product managers, and administrators to create sophisticated user research questionnaires through an intuitive, no-code interface. This feature removes the technical barrier of API-based questionnaire creation and empowers research teams to gather structured user feedback across the Club Med ecosystem.

The questionnaire builder will support 7 question types (Likert scales, NPS, multiple-choice, text, number, rating), bilingual content (EN/FR), flexible audience targeting (panels, villages, roles), and configurable response settings. This democratizes user research capabilities and accelerates the feedback-to-insight pipeline.

## Current State

### What Exists Today
- ✅ **Backend Infrastructure**:
  - Prisma schema with `Questionnaire` and `QuestionnaireResponse` models (schema.prisma:364-421)
  - POST `/api/questionnaires` endpoint with full validation (src/app/api/questionnaires/route.ts)
  - TypeScript types for all question formats (src/types/questionnaire.ts)
  - Panel management system for audience targeting

- ✅ **Reusable Components**:
  - `QuestionBuilder` - Interactive question editor with drag/drop (src/components/questionnaires/question-builder.tsx)
  - `QuestionnaireEditForm` - Full-featured edit form with tabs (src/components/questionnaires/questionnaire-edit-form.tsx)
  - `QuestionRenderer` - Question display component (src/components/questionnaires/question-renderer.tsx)
  - `TargetingConfig` - Audience selector component

### What's Missing
- ❌ **Creation UI**: The `/research/questionnaires/new` page shows only a placeholder with API documentation
- ❌ **Form Integration**: No client-side form to collect questionnaire data and submit to existing API
- ❌ **User Workflow**: Researchers forced to use Postman/curl to create questionnaires

### Current User Experience
```
Researcher wants to create survey
  ↓
Navigate to /research/questionnaires/new
  ↓
See placeholder: "Use POST /api/questionnaires"
  ↓
Open Postman, craft JSON payload manually
  ↓
Submit API request, hope for no validation errors
  ↓
(Frustration and friction)
```

## Motivation

### Business Value

**1. Self-Service Research Tools** ($10K+ annual value)
- Eliminate dependency on engineering for questionnaire creation
- Reduce research project lead time from days to hours
- Enable rapid iteration based on feedback

**2. Increased Research Velocity** (3x faster)
- Average questionnaire creation: 30 minutes → 5 minutes
- Parallel research streams: Multiple PMs can launch surveys simultaneously
- Faster time-to-insight for product decisions

**3. Higher Quality Research** (20% improvement in response rates)
- Visual builder prevents JSON formatting errors
- Real-time validation catches mistakes before publish
- Preview mode ensures questions render correctly

**4. Team Empowerment**
- Democratize user research: PMs don't need API skills
- Researchers focus on insights, not technical implementation
- ADMIN users can assist with complex questionnaire setup

**5. Competitive Parity**
- Industry-standard feature (Typeform, Google Forms, Qualtrics all GUI-based)
- Matches expectations from Club Med's product team

### User Pain Points

**Researcher (Primary Persona)**:
- "I need to survey users about check-in satisfaction, but I don't know how to format JSON"
- "I made a typo in my API request and got a cryptic validation error"
- "I can't preview my questionnaire before publishing"
- "Bilingual surveys require manual JSON editing for EN/FR text"

**Product Manager**:
- "I want to quickly test 5 feature ideas with our power user panel, but setting up a survey takes 2 hours"
- "I don't have time to learn the API just to ask 3 NPS questions"

**Administrator**:
- "I'm blocking researchers who need questionnaires created urgently"
- "I spend 30% of my time being a 'human API' for the research team"

### Risks of Not Implementing

1. **Research Bottleneck**: Only 2-3 engineers know API format → max 1-2 questionnaires/week
2. **User Frustration**: Researchers abandon planned studies due to technical friction
3. **Competitive Disadvantage**: Other platforms (Canny, ProductBoard, Qualtrics) have intuitive builders
4. **Reduced Feedback Quality**: Rushed API requests lead to poorly structured questions
5. **Missed Insights**: 50% of planned research doesn't happen due to creation overhead

## Goals

### Primary Goals (P0)

1. **Visual Questionnaire Builder**
   - Drag-and-drop question ordering
   - Support all 7 question types from DSL spec (Likert 5/7, NPS, MCQ single/multiple, text, number, rating)
   - Bilingual text fields (English + French) for every question
   - Real-time validation feedback

2. **Audience Targeting**
   - Select research panels (multi-select)
   - Filter by village IDs (specific locations)
   - Filter by user roles (USER, PM, PO, RESEARCHER)
   - "All users" broadcast option

3. **Response Configuration**
   - Anonymous vs. identified responses
   - Response limits (once, daily, weekly, unlimited)
   - Start/end dates for time-bound surveys
   - Maximum response cap (e.g., "Close after 100 responses")

4. **Draft/Publish Workflow**
   - Save as draft (can edit later)
   - Preview mode (see respondent view)
   - Publish to make live (sends to targeted audience)

### Secondary Goals (P1)

5. **Question Templates**
   - Common question presets (NPS, satisfaction, effort score)
   - One-click insertion of standard questions

6. **Validation & Error Handling**
   - Inline validation (e.g., "Question text required")
   - Pre-publish checklist ("✓ At least 1 question", "✓ Targeting configured")
   - Clear error messages on API failures

7. **Accessibility & UX**
   - Keyboard navigation for all actions
   - Screen reader support
   - Mobile-responsive design (works on tablet)

### Non-Goals (Out of Scope)

- ❌ **Question Logic/Branching**: "Skip to Q5 if answer is X" (add in PRD-007)
- ❌ **AI-Generated Questions**: GPT-powered question suggestions (future)
- ❌ **Questionnaire Templates**: Full survey templates (e.g., "NPS Survey", "Onboarding Survey")
- ❌ **Collaboration**: Multiple users editing same questionnaire simultaneously
- ❌ **White-Labeling**: Custom branding per questionnaire
- ❌ **Advanced Analytics**: In-builder response charts (separate analytics PRD)
- ❌ **Email Composer**: Custom invitation emails (use default templates)
- ❌ **Question Bank**: Reusable question library across questionnaires
- ❌ **Multi-Page Surveys**: All questions on single page for MVP

## Success Metrics

### Adoption Metrics (First 30 Days)
- ✅ **80%+ researcher adoption**: 4 out of 5 researchers use UI (not API) for creation
- ✅ **10+ questionnaires created**: At least 2 per week by research team
- ✅ **Zero creation-related support tickets**: No users blocked by UI issues

### Efficiency Metrics (90 Days)
- ✅ **5-minute average creation time**: From blank form to published (down from 30 min with API)
- ✅ **90%+ first-time publish success**: No validation errors on submission
- ✅ **50% reduction in draft-to-publish time**: Faster iteration cycles

### Quality Metrics
- ✅ **95%+ question accuracy**: No reported formatting/display issues
- ✅ **<1% error rate**: API submissions succeed on first try
- ✅ **100% bilingual compliance**: All published questionnaires have EN + FR text

### Engagement Metrics
- ✅ **User satisfaction**: 8/10 average rating for "ease of creation"
- ✅ **Feature utilization**: 70% of questionnaires use 3+ question types
- ✅ **Panel targeting**: 60% of questionnaires target specific panels (not "all users")

## Requirements

### Functional Requirements

#### FR-1: General Information Form
**Priority**: P0
**Description**: Capture questionnaire metadata (title, version, status)

**Acceptance Criteria**:
- Title field (required, 3-200 characters)
- Auto-generated version (starts at v1.0.0)
- Status badge (Draft/Published/Closed) - read-only, set by workflow
- Creator name displayed (from session)
- Created/updated timestamps displayed

**UI Mockup**:
```
┌────────────────────────────────────────┐
│ General Information                    │
├────────────────────────────────────────┤
│ Title *                                │
│ ┌──────────────────────────────────┐  │
│ │ Q4 2024 Guest Experience Survey  │  │
│ └──────────────────────────────────┘  │
│ [180/200 characters]                   │
│                                        │
│ Version: v1.0.0        Status: Draft   │
│ Created by: Marie Dubois (PM)          │
│ Created: 2025-10-09    Updated: Today  │
└────────────────────────────────────────┘
```

#### FR-2: Question Builder Interface
**Priority**: P0
**Description**: Visual editor for creating and managing survey questions

**Acceptance Criteria**:

**Question Types Supported**:
1. **Likert Scale** (5-point or 7-point)
   - Configurable labels (e.g., "Strongly Disagree" to "Strongly Agree")
   - Scale selection dropdown

2. **NPS** (0-10 scale)
   - Standard "Not at all likely" to "Extremely likely" labels
   - Auto-calculated NPS score from responses

3. **Multiple Choice - Single** (radio buttons)
   - Add/remove/reorder options
   - Minimum 2 options required

4. **Multiple Choice - Multiple** (checkboxes)
   - Add/remove/reorder options
   - Optional max selections limit

5. **Text Response** (short or long)
   - Optional max length (default: 500 chars)
   - Multiline toggle

6. **Number Input** (numeric entry)
   - Optional min/max bounds
   - Decimal or integer constraint

7. **Rating** (star rating)
   - Configurable scale (default: 5 stars)
   - Half-star support optional

**Question Management**:
- ✅ Add question button with type selector
- ✅ Duplicate question (copies all settings)
- ✅ Delete question (with confirmation)
- ✅ Reorder via drag-and-drop or up/down arrows
- ✅ Mark question as required (checkbox)
- ✅ Bilingual text fields for question text (EN + FR tabs)
- ✅ Question counter: "Question 1 of 5"

**Validation**:
- At least 1 question required
- Question text required in at least one language (EN or FR)
- MCQ questions must have 2+ options
- Max 50 questions per questionnaire (prevent performance issues)

**UI Mockup**:
```
┌────────────────────────────────────────┐
│ Questions (3)            [+ Add Question] │
├────────────────────────────────────────┤
│ ┌──────────────────────────────────┐  │
│ │ Question 1 - NPS         [↑][↓][×] │  │
│ ├──────────────────────────────────┤  │
│ │ [EN] [FR] *Required □            │  │
│ │ ┌────────────────────────────┐   │  │
│ │ │ How likely are you to      │   │  │
│ │ │ recommend Club Med?        │   │  │
│ │ └────────────────────────────┘   │  │
│ └──────────────────────────────────┘  │
│                                        │
│ ┌──────────────────────────────────┐  │
│ │ Question 2 - MCQ Single  [↑][↓][×]│  │
│ │ ┌────────────────────────────┐   │  │
│ │ │ What is your primary role? │   │  │
│ │ └────────────────────────────┘   │  │
│ │ Options:                         │  │
│ │ • Guest                          │  │
│ │ • GO (Staff)                     │  │
│ │ • Manager              [+ Add]   │  │
│ └──────────────────────────────────┘  │
└────────────────────────────────────────┘
```

#### FR-3: Audience Targeting
**Priority**: P0
**Description**: Define who can see and respond to the questionnaire

**Targeting Types**:

1. **All Users** (default)
   - Broadcast to entire user base
   - No restrictions

2. **Specific Panels**
   - Multi-select from available panels
   - Show panel size (e.g., "Power Users - 45 members")
   - Estimated reach: Sum of panel memberships

3. **Specific Villages**
   - Multi-select from village list
   - Useful for location-specific surveys

4. **By Role**
   - Multi-select: USER, PM, PO, RESEARCHER, ADMIN, MODERATOR
   - Example: Survey only PMs about roadmap priorities

**Acceptance Criteria**:
- Targeting type selector (radio buttons)
- Conditional fields based on selection
- Show estimated audience size before publish
- Save targeting config as JSON in `adHocFilters` or `panelIds` fields
- Validation: If "Specific Panels" selected, at least 1 panel required

**UI Mockup**:
```
┌────────────────────────────────────────┐
│ Audience Targeting                     │
├────────────────────────────────────────┤
│ Who should see this questionnaire?     │
│                                        │
│ ○ All Users                            │
│ ● Specific Panels                      │
│ ○ Specific Villages                    │
│ ○ By Role                              │
│                                        │
│ Select Panels:                         │
│ ☑ Power Users (45 members)             │
│ ☐ Beta Testers (23 members)            │
│ ☑ Mobile App Users (120 members)       │
│                                        │
│ Estimated reach: 165 users             │
└────────────────────────────────────────┘
```

#### FR-4: Response Settings
**Priority**: P0
**Description**: Configure how responses are collected and stored

**Settings**:

1. **Anonymous Responses**
   - Checkbox: "Allow anonymous responses"
   - If enabled: Respondent ID stored but not displayed in exports
   - Default: Off (identified responses)

2. **Response Limit per User**
   - Dropdown: Once / Daily / Weekly / Unlimited
   - Default: Once
   - Prevents survey fatigue

3. **Schedule**
   - Start date/time (optional, default: immediate)
   - End date/time (optional, default: no expiration)
   - Timezone: UTC (displayed in local time)

4. **Maximum Total Responses**
   - Optional number input
   - Auto-close survey after X responses
   - Example: "Close after 100 responses" for quota sampling

**Acceptance Criteria**:
- All settings optional (sensible defaults)
- End date must be after start date (validation)
- Max responses must be positive integer
- Clear help text for each setting
- "Recommended" badge on common configurations

**UI Mockup**:
```
┌────────────────────────────────────────┐
│ Response Settings                      │
├────────────────────────────────────────┤
│ ☐ Allow anonymous responses            │
│                                        │
│ Response Limit per User:               │
│ [Once only ▼]                          │
│                                        │
│ Schedule (optional):                   │
│ Start: [2025-10-10 09:00] [Clear]      │
│ End:   [2025-10-31 23:59] [Clear]      │
│                                        │
│ Max Total Responses (optional):        │
│ [100          ] responses              │
│ ℹ Survey will close automatically      │
└────────────────────────────────────────┘
```

#### FR-5: Save as Draft
**Priority**: P0
**Description**: Save incomplete or unpublished questionnaires for later editing

**Acceptance Criteria**:
- "Save as Draft" button (always enabled)
- Draft saved to database with `status = 'draft'`
- Redirect to questionnaire list after save
- Success toast: "Questionnaire saved as draft"
- Drafts editable at any time (no restrictions)
- Drafts not visible to target audience (only creators/admins)

#### FR-6: Preview Mode
**Priority**: P1
**Description**: View questionnaire as respondents would see it

**Acceptance Criteria**:
- "Preview" button in header
- Opens modal/new tab with read-only question form
- Shows all questions with proper formatting
- Language toggle (EN/FR) functional
- Cannot submit responses in preview mode
- Close preview returns to editor

**UI Mockup**:
```
[Preview Modal]
┌────────────────────────────────────────┐
│ Q4 2024 Guest Experience Survey  [×]   │
├────────────────────────────────────────┤
│ [English ▼]                            │
│                                        │
│ 1. How likely are you to recommend...? │
│    0  1  2  3  4  5  6  7  8  9  10    │
│                                        │
│ 2. What is your primary role?          │
│    ○ Guest                             │
│    ○ GO (Staff)                        │
│    ○ Manager                           │
│                                        │
│ [This is a preview - responses won't   │
│  be saved]                             │
└────────────────────────────────────────┘
```

#### FR-7: Publish Questionnaire
**Priority**: P0
**Description**: Make questionnaire live and visible to target audience

**Acceptance Criteria**:
- "Publish" button enabled only when valid (all required fields)
- Pre-publish validation checklist:
  - ✓ Title provided
  - ✓ At least 1 question
  - ✓ All questions have text in EN or FR
  - ✓ MCQ questions have 2+ options
  - ✓ Targeting configured
- Confirmation dialog: "Are you sure? This will send to X users."
- On publish:
  - Set `status = 'published'`
  - Set `startAt = now()` if not specified
  - Trigger notifications to target audience (if delivery mode includes in-app)
  - Create audit log entry
- Success message: "Questionnaire published! Notifications sent to 165 users."
- Redirect to questionnaire detail page (read-only view)

**Published Questionnaires**:
- Cannot edit questions or targeting (prevents inconsistent responses)
- Can update title, end date, max responses (non-breaking changes)
- Can close early (set `status = 'closed'`)

#### FR-8: Validation & Error Handling
**Priority**: P0
**Description**: Prevent invalid questionnaires from being created

**Client-Side Validation**:
- Inline validation on blur (e.g., "Title required")
- Submit-time validation (check all rules)
- Scroll to first error + focus field

**Server-Side Validation** (defense in depth):
- API returns 400 with `details` array
- Display errors above form: "Please fix the following issues:"
- Map API errors to form fields (highlight in red)

**Common Errors**:
- "Title must be between 3 and 200 characters"
- "Question 3 text is required in at least one language"
- "Question 5 (MCQ) must have at least 2 options"
- "At least 1 panel must be selected"
- "End date must be after start date"

#### FR-9: Responsive Design
**Priority**: P1
**Description**: Builder works on desktop, tablet, and mobile

**Acceptance Criteria**:
- Desktop (1280px+): Full 3-tab layout
- Tablet (768-1279px): Stacked tabs, vertical scrolling
- Mobile (320-767px): Single-column, accordion questions
- Touch-friendly: Drag handles, large tap targets (44x44px min)
- Keyboard navigation: Tab through all fields, Enter to save

### Non-Functional Requirements

#### NFR-1: Performance
**Acceptance Criteria**:
- Page load time: <1.5 seconds
- Form submission: <2 seconds (API call + redirect)
- Add/remove question: <100ms (optimistic UI)
- Preview render: <500ms
- Handle 50 questions without UI lag

#### NFR-2: Accessibility (WCAG 2.1 Level AA)
**Acceptance Criteria**:
- Keyboard navigation: All actions accessible via Tab/Enter/Space
- Screen reader support: ARIA labels on all controls
- Color contrast: 4.5:1 minimum for text
- Focus indicators: Visible outline on focused elements
- Error announcements: Screen reader alerts on validation errors
- Form labels: Every input has associated <label>

#### NFR-3: Internationalization (i18n)
**Acceptance Criteria**:
- UI language: English (default), French (toggle in header)
- Bilingual content: All questions support EN + FR text
- Date/time formatting: Locale-aware (EN: MM/DD/YYYY, FR: DD/MM/YYYY)
- Character sets: Full Unicode support (accented characters, emoji)

#### NFR-4: Security
**Acceptance Criteria**:
- Authentication required: Only logged-in users can create
- Role-based access: RESEARCHER, PM, ADMIN only (403 for USER)
- CSRF protection: Next.js built-in token validation
- XSS prevention: Sanitize question text (no <script> tags)
- Rate limiting: 10 requests/minute per user

#### NFR-5: Data Integrity
**Acceptance Criteria**:
- Atomic saves: Either all data saved or none (transaction)
- Optimistic UI: Show success immediately, rollback on error
- Autosave drafts: Every 30 seconds (background save)
- Version control: Track questionnaire version (v1.0.0, v1.1.0)

## Technical Design

### Architecture Overview

```
┌─────────────────────────────────────────────────────────────┐
│ Frontend (React + Next.js)                                  │
│ ┌──────────────────────────────────────────────────────────┤
│ │ /research/questionnaires/new                             │
│ │ [Server Component]                                       │
│ │ - Authenticate user (RESEARCHER/PM/ADMIN)                │
│ │ - Fetch available panels from Prisma                     │
│ │ - Render <QuestionnaireCreateForm>                       │
│ └──────────────────────────────────────────────────────────┤
│                         ↓ props (panels)                    │
│ ┌──────────────────────────────────────────────────────────┤
│ │ QuestionnaireCreateForm.tsx                              │
│ │ [Client Component]                                       │
│ │ - Form state: title, questions[], targeting, settings   │
│ │ - Tabs: General | Questions | Targeting & Settings      │
│ │ - Validation: Zod schema or inline checks                │
│ │ - Submit: POST /api/questionnaires                       │
│ └──────────────────────────────────────────────────────────┤
│                         ↓ uses component                    │
│ ┌──────────────────────────────────────────────────────────┤
│ │ QuestionBuilder.tsx [REUSED]                             │
│ │ - Add/edit/remove/reorder questions                      │
│ │ - Bilingual text inputs (EN/FR tabs)                     │
│ │ - Type-specific config (scale, options, etc.)            │
│ └──────────────────────────────────────────────────────────┤
│                         ↓ POST /api/questionnaires          │
├─────────────────────────────────────────────────────────────┤
│ Backend (Next.js API Routes) [EXISTING]                     │
│ ┌──────────────────────────────────────────────────────────┤
│ │ /api/questionnaires (POST) [route.ts:166-345]           │
│ │ - Authenticate user                                      │
│ │ - Validate input (title, questions, targeting)           │
│ │ - Generate ULID: qnn_${ulid()}                           │
│ │ - Insert into Prisma (status: draft)                     │
│ │ - Log event: questionnaire.created                       │
│ │ - Return 201 with questionnaire data                     │
│ └──────────────────────────────────────────────────────────┤
│                         ↓                                    │
├─────────────────────────────────────────────────────────────┤
│ Database (Prisma + SQLite/PostgreSQL)                       │
│ ┌──────────────────────────────────────────────────────────┤
│ │ Questionnaire model [schema.prisma:364-404]             │
│ │ - id: qnn_${ulid}                                        │
│ │ - title, version, status                                 │
│ │ - questions: JSON (array of question objects)            │
│ │ - panelIds: JSON (array of panel IDs)                    │
│ │ - adHocFilters: JSON (villages, roles)                   │
│ │ - anonymous, responseLimit, startAt, endAt, maxResponses │
│ │ - createdById, createdAt, updatedAt                      │
│ └──────────────────────────────────────────────────────────┤
└─────────────────────────────────────────────────────────────┘
```

### Implementation Phases

#### Phase 1: Create QuestionnaireCreateForm Component (3 hours)
**File**: `src/components/questionnaires/questionnaire-create-form.tsx`

**Description**: Client component for questionnaire creation form

**Tasks**:
1. Set up form state (React hooks)
   ```typescript
   const [title, setTitle] = useState('');
   const [questions, setQuestions] = useState<Question[]>([]);
   const [targetingType, setTargetingType] = useState('all_users');
   const [selectedPanels, setSelectedPanels] = useState<string[]>([]);
   const [anonymous, setAnonymous] = useState(false);
   const [responseLimit, setResponseLimit] = useState('once');
   const [endAt, setEndAt] = useState('');
   const [maxResponses, setMaxResponses] = useState<number | null>(null);
   ```

2. Build 3-tab layout using shadcn Tabs component
   - Tab 1: General Info (title input, metadata display)
   - Tab 2: Questions (integrate `<QuestionBuilder>`)
   - Tab 3: Targeting & Settings (targeting + response config)

3. Implement validation logic
   ```typescript
   const validate = (): string[] => {
     const errors: string[] = [];
     if (!title.trim()) errors.push('Title is required');
     if (questions.length === 0) errors.push('At least one question required');
     // ... more checks
     return errors;
   };
   ```

4. Handle form submission
   ```typescript
   const handleSubmit = async (e: React.FormEvent) => {
     e.preventDefault();
     const errors = validate();
     if (errors.length > 0) {
       setError(errors.join('; '));
       return;
     }

     setIsSubmitting(true);
     try {
       const response = await fetch('/api/questionnaires', {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({
           title,
           questions,
           targeting: {
             type: targetingType,
             panelIds: targetingType === 'specific_panels' ? selectedPanels : [],
             // ... other fields
           },
           anonymous,
           responseLimit,
           endAt,
           maxResponses,
         }),
       });

       if (!response.ok) throw new Error('Failed to create');
       const data = await response.json();
       router.push(`/research/questionnaires/${data.data.id}`);
     } catch (err) {
       setError(err.message);
     } finally {
       setIsSubmitting(false);
     }
   };
   ```

5. Add "Save as Draft" and "Publish" buttons
   - Both submit to same endpoint (status set on server)
   - Different button labels/colors

**Component Structure** (similar to QuestionnaireEditForm):
```tsx
export function QuestionnaireCreateForm({ availablePanels }: Props) {
  // State hooks
  // Handlers
  return (
    <form onSubmit={handleSubmit}>
      <Tabs defaultValue="general">
        <TabsList>
          <TabsTrigger value="general">General Info</TabsTrigger>
          <TabsTrigger value="questions">Questions</TabsTrigger>
          <TabsTrigger value="targeting">Targeting & Settings</TabsTrigger>
        </TabsList>

        <TabsContent value="general">
          {/* Title input, creator info */}
        </TabsContent>

        <TabsContent value="questions">
          <QuestionBuilder questions={questions} onChange={setQuestions} />
        </TabsContent>

        <TabsContent value="targeting">
          {/* Targeting selector, response settings */}
        </TabsContent>
      </Tabs>

      <div className="flex justify-end gap-2 mt-6">
        <Button type="submit" disabled={isSubmitting}>
          {isSubmitting ? 'Creating...' : 'Create Questionnaire'}
        </Button>
      </div>
    </form>
  );
}
```

#### Phase 2: Update New Questionnaire Page (1 hour)
**File**: `src/app/(authenticated)/research/questionnaires/new/page.tsx`

**Tasks**:
1. Replace placeholder UI with form integration
2. Fetch available panels from database
3. Pass panels as props to `QuestionnaireCreateForm`
4. Add breadcrumb navigation

**Implementation**:
```tsx
import { auth } from '@/auth';
import { prisma } from '@/lib/prisma';
import { redirect } from 'next/navigation';
import { QuestionnaireCreateForm } from '@/components/questionnaires/questionnaire-create-form';

export default async function NewQuestionnairePage() {
  const session = await auth();
  if (!session?.user) {
    redirect('/api/auth/signin');
  }

  const user = session.user;
  const isResearcher = ['RESEARCHER', 'PM', 'ADMIN'].includes(user.role || '');
  if (!isResearcher) {
    redirect('/research/my-questionnaires');
  }

  // Fetch available panels
  const panels = await prisma.panel.findMany({
    where: { archived: false },
    orderBy: { name: 'asc' },
    include: {
      _count: { select: { memberships: true } },
    },
  });

  return (
    <div className="container mx-auto py-8 space-y-6">
      <div className="flex items-center gap-4">
        <Button variant="ghost" size="icon" asChild>
          <Link href="/research/questionnaires">
            <ArrowLeft className="h-4 w-4" />
          </Link>
        </Button>
        <div>
          <h1 className="text-3xl font-bold tracking-tight">
            Create New Questionnaire
          </h1>
          <p className="text-muted-foreground mt-1">
            Build a user research survey with multiple question types
          </p>
        </div>
      </div>

      <QuestionnaireCreateForm availablePanels={panels} />
    </div>
  );
}
```

#### Phase 3: Testing & Refinement (2 hours)

**Manual Testing Checklist**:
- [ ] Create questionnaire with all 7 question types
- [ ] Add bilingual text (EN + FR) to questions
- [ ] Configure targeting (panels, villages, roles, all users)
- [ ] Set response limits (once, daily, weekly, unlimited)
- [ ] Set start/end dates
- [ ] Save as draft → Edit → Publish workflow
- [ ] Validation errors display correctly
- [ ] Mobile responsive layout
- [ ] Keyboard navigation works
- [ ] Screen reader announces errors

**Edge Cases to Test**:
- Empty form submission (should show validation errors)
- Extremely long title (200+ chars, should truncate)
- 50 questions (max limit, should handle without lag)
- No panels available (should show message)
- API failure (should show error, allow retry)
- Network timeout (should show loading state)

**Browser Testing**:
- Chrome (primary)
- Firefox
- Safari
- Mobile Safari (iOS)
- Chrome Mobile (Android)

### Data Model (Already Exists)

**Prisma Schema** (no changes needed):
```prisma
model Questionnaire {
  id          String   @id // qnn_${ulid}
  title       String
  version     String   @default("1.0.0")
  status      String   @default("draft") // draft | published | closed
  questions   String   @default("[]") // JSON array of question objects
  panelIds    String   @default("[]") // JSON array of panel IDs
  adHocFilters String  @default("{}") // JSON object with villages, roles
  deliveryMode   String    @default("[]") // ["in-app", "email"]
  startAt        DateTime?
  endAt          DateTime?
  maxResponses   Int?
  anonymous      Boolean   @default(false)
  responseLimit  Int       @default(1)
  aggregateExports String  @default("[]")
  piiIncluded      Boolean @default(false)
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  responses   QuestionnaireResponse[]
  @@index([status])
  @@index([createdById])
}
```

**TypeScript Types** (already exist in `src/types/questionnaire.ts`):
```typescript
export interface CreateQuestionnaireInput {
  title: string;
  questions: Question[];
  targeting: QuestionnaireTargeting;
  anonymous?: boolean;
  responseLimit?: number;
  startAt?: string | null;
  endAt?: string | null;
  maxResponses?: number | null;
}

export interface Question {
  id: string;
  type: QuestionType;
  text: { en: string; fr: string };
  required: boolean;
  config?: {
    scale?: number; // Likert 5 or 7
    options?: string[]; // MCQ
    min?: number; // Number
    max?: number; // Number
    maxLength?: number; // Text
  };
}
```

### API Integration (Already Exists)

**Endpoint**: `POST /api/questionnaires`
**Auth**: Required (RESEARCHER/PM/ADMIN)
**Rate Limit**: 10 requests/minute

**Request Body**:
```json
{
  "title": "Q4 2024 Guest Experience Survey",
  "questions": [
    {
      "id": "01HZX...",
      "type": "nps",
      "text": {
        "en": "How likely are you to recommend Club Med?",
        "fr": "Quelle est la probabilité que vous recommandiez Club Med?"
      },
      "required": true
    },
    {
      "id": "01HZY...",
      "type": "mcq_single",
      "text": {
        "en": "What is your primary role?",
        "fr": "Quel est votre rôle principal?"
      },
      "required": true,
      "config": {
        "options": ["Guest", "GO (Staff)", "Manager"]
      }
    }
  ],
  "targeting": {
    "type": "specific_panels",
    "panelIds": ["pan_01HZX...", "pan_01HZY..."]
  },
  "anonymous": false,
  "responseLimit": 1,
  "endAt": "2025-10-31T23:59:59Z",
  "maxResponses": 100
}
```

**Response** (201 Created):
```json
{
  "success": true,
  "data": {
    "id": "qnn_01HZX...",
    "title": "Q4 2024 Guest Experience Survey",
    "version": "1.0.0",
    "status": "draft",
    "questions": [...],
    "createdBy": {
      "id": "usr_...",
      "displayName": "Marie Dubois",
      "role": "PM"
    },
    "createdAt": "2025-10-09T14:30:00Z"
  },
  "message": "Questionnaire created successfully"
}
```

**Error Responses**:
- 400: Validation failed (with `details` array)
- 401: Unauthorized (not logged in)
- 403: Forbidden (wrong role)
- 500: Internal server error

## Dependencies & Impacts

### Affected Systems
- **Research Workflow**: New primary path for questionnaire creation
- **Panel Management**: Dependency on panels API for targeting
- **User Notifications**: Published questionnaires trigger in-app notifications
- **Analytics Dashboard**: New questionnaires appear in research metrics

### Required Dependencies (Already in Project)
- `next` (v15.5) - Framework
- `react` (v18) - UI library
- `prisma` - Database ORM
- `ulid` - ID generation
- `@radix-ui/*` (shadcn) - UI components
- `lucide-react` - Icons

### Third-Party Integrations
- **None required** - All functionality uses existing APIs

### Database Migrations
- **None required** - Schema already exists

## Migration & Rollout Plan

### Phase 1: Internal Beta (Week 1)
**Goal**: Validate UX with research team

**Rollout**:
- Deploy to staging environment
- Enable for 3 researchers + 1 PM (early adopters)
- Collect feedback via feedback form (eat our own dog food!)
- Track metrics: Creation time, error rate, drop-off points

**Success Criteria**:
- 3/4 users successfully create questionnaire in <10 minutes
- No blocking bugs reported
- 8/10+ satisfaction score

### Phase 2: Soft Launch (Week 2)
**Goal**: Open to all researchers/PMs

**Rollout**:
- Deploy to production behind feature flag: `ENABLE_QUESTIONNAIRE_BUILDER=true`
- Announce in Slack #research-team channel
- Create tutorial video (2-minute walkthrough)
- Office hours: 1-hour Zoom session for Q&A

**Monitoring**:
- Track daily creation count (target: 2+ per day)
- Monitor error logs (Sentry/console errors)
- Response time metrics (form submission latency)

**Support**:
- Dedicated Slack thread for questions
- Update FAQ with common issues

### Phase 3: General Availability (Week 3)
**Goal**: Full launch with documentation

**Rollout**:
- Remove feature flag (always-on)
- Publish user guide in `/docs/USER_GUIDE.md`
- Add in-app onboarding tooltip ("New! Create surveys with our visual builder")
- Email announcement to all PM/Researcher users

**Post-Launch**:
- Weekly check-in with research lead
- Collect feedback via NPS survey (ironic!)
- Prioritize improvements for v2 (based on feedback)

### Rollback Plan

**Rollback Triggers**:
- Critical bug preventing creation (error rate >10%)
- Data corruption (questionnaires saved incorrectly)
- Security vulnerability discovered
- Widespread user complaints (>3 negative reports)

**Rollback Steps**:
1. **Immediate**: Revert to placeholder page with "Under maintenance" message
2. **Short-term**: Hotfix bug in 4 hours, redeploy
3. **Communication**: Email users, post in Slack
4. **Long-term**: If unfixable, keep API-only creation, improve documentation

**Data Safety**:
- Existing drafts/published questionnaires unaffected
- Users can still respond to published questionnaires
- Rollback only affects new creations

## Open Questions

1. **Question Templates**: Should we provide preset questions (e.g., "Standard NPS", "5-point satisfaction")?
   - **Recommendation**: Add in v2 after observing common patterns

2. **Autosave Frequency**: How often should drafts autosave (30s, 1min, 5min)?
   - **Recommendation**: 30 seconds (balance between UX and server load)

3. **Duplicate Questionnaire**: Should users be able to clone existing questionnaires?
   - **Recommendation**: Yes, add "Duplicate" button in v1.1 (easy win)

4. **Question Limit**: Is 50 questions too many? Should we enforce lower limit?
   - **Recommendation**: Keep 50, warn at 25 ("Long surveys reduce completion rates")

5. **Preview Mode**: Should preview be modal, new tab, or inline toggle?
   - **Recommendation**: Modal (keeps context, no navigation)

6. **Validation Timing**: Validate on blur, on submit, or both?
   - **Recommendation**: Both (blur for immediate feedback, submit for final check)

7. **Mobile Creation**: Should we fully support mobile questionnaire creation?
   - **Recommendation**: Yes, but recommend desktop for complex surveys (20+ questions)

8. **Collaboration**: Should multiple users be able to edit same draft?
   - **Recommendation**: No (out of scope), but log "Last edited by X" for visibility

## Success Criteria Summary

### Must Have (P0)
- ✅ Users can create questionnaires with 7 question types via visual builder
- ✅ Bilingual support (EN + FR) for all questions
- ✅ Targeting configuration (panels, villages, roles, all users)
- ✅ Response settings (anonymous, limits, schedule)
- ✅ Save as draft and publish workflow
- ✅ Form validation with clear error messages
- ✅ 80%+ researcher adoption within 30 days
- ✅ <5-minute average creation time

### Should Have (P1)
- ✅ Preview mode before publish
- ✅ Responsive design (desktop, tablet, mobile)
- ✅ Keyboard navigation and screen reader support
- ✅ Autosave drafts every 30 seconds
- ✅ Estimated audience size display
- ✅ Pre-publish validation checklist

### Nice to Have (P2)
- Question templates (common presets)
- Duplicate questionnaire feature
- Inline help tooltips
- Progress indicator (1/3 tabs completed)
- "Recently used panels" quick-select
- Export questionnaire as PDF/JSON

## Timeline & Effort Estimate

| Phase | Duration | Owner | Dependencies |
|-------|----------|-------|--------------|
| Component Development | 3 hours | Frontend Engineer | QuestionBuilder (reuse) |
| Page Integration | 1 hour | Frontend Engineer | Auth, Panels API |
| Testing & QA | 2 hours | QA Engineer | - |
| Documentation | 1 hour | Technical Writer | - |
| Internal Beta | 1 week | Product Manager | Staging deploy |
| Soft Launch | 1 week | Product Manager | Prod deploy |
| **Total Development** | **6 hours** | **~1 dev day** | - |
| **Total Launch** | **3 weeks** | **Incl. rollout** | - |

### Critical Path
1. Component Development → Page Integration → Testing → Internal Beta → Soft Launch → GA

### Parallel Work Opportunities
- Documentation during testing phase
- Tutorial video during internal beta
- Announcement email draft during soft launch

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Complex UX confuses users | Medium | High | User testing with 3 researchers, iterate based on feedback |
| Question type mismatch with DSL spec | Low | Critical | Reference types/questionnaire.ts, validate against schema |
| Performance issues with 50 questions | Low | Medium | Load test with 50 questions, optimize rendering |
| API validation errors not mapped to UI | Medium | Medium | Build error mapping layer, test all validation scenarios |
| Bilingual text overlooked (publish without FR) | Medium | Low | Add pre-publish check: "Missing FR text on 3 questions. Continue?" |
| Users ignore response limits (create spam) | Low | Low | Rate limiting (10 creations/hour), monitor abuse patterns |
| Mobile UX subpar (too small) | Medium | Medium | Responsive testing on iPhone SE, iPad Mini, Android |

## References

- **DSL Specification**: `dsl/global.yaml` (lines 153-215) - Questionnaire requirements
- **Prisma Schema**: `prisma/schema.prisma` (lines 364-404) - Questionnaire model
- **API Endpoint**: `src/app/api/questionnaires/route.ts` (lines 166-345) - POST handler
- **TypeScript Types**: `src/types/questionnaire.ts` - All question/questionnaire interfaces
- **Existing Components**:
  - `src/components/questionnaires/question-builder.tsx` - Reusable question editor
  - `src/components/questionnaires/questionnaire-edit-form.tsx` - Reference implementation
- **User Guide**: `docs/USER_GUIDE.md` - Researcher workflows

## Approval & Sign-off

| Role | Name | Date | Signature |
|------|------|------|-----------|
| Product Manager | TBD | | |
| Engineering Lead | TBD | | |
| UX Designer | TBD | | |
| Research Lead | TBD | | |

---

**Document History**:
- v1.0 (2025-10-09): Initial draft
- v1.1 (TBD): Post-beta revisions
