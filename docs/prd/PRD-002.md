# Product Requirements Document (PRD-002)
# Navigation System, Feedback Fix, and Home Page Improvements

**Project**: Gentil Feedback Platform Enhancement
**Version**: 0.5.1
**Date**: 2025-10-03
**Status**: Approved for Implementation
**Related**: PRD v0.5.0 (docs/PRD.md)

---

## 1. Executive Summary

This PRD defines three critical improvements to the Gentil Feedback platform to enhance usability, fix core functionality, and implement comprehensive navigation:

1. **Complete Navigation System**: Implement a role-based, responsive navigation using shadcn/ui with sidebar and top bar
2. **Feedback Saving Fix**: Enable real API integration for feedback submission (currently using mock data)
3. **Home Page Improvements**: Merge and enhance home/dashboard experience with personalized content

### 1.1 Success Metrics
- Navigation accessible on 100% of authenticated pages
- Feedback submission success rate >95%
- User session time increases by 20% (easier navigation)
- Mobile navigation usability score >4.5/5
- WCAG 2.1 AA compliance score: 100%

---

## 2. Problem Statement

### 2.1 Current Pain Points

**Navigation**:
- ❌ No global navigation system
- ❌ Each page has isolated navigation
- ❌ Users cannot easily move between sections (Feedback → Roadmap → Research)
- ❌ No visual indication of current location (breadcrumbs)
- ❌ Role-based features not discoverable (RESEARCHER doesn't know Research section exists)
- ❌ Mobile navigation is non-existent

**Feedback Saving**:
- ❌ Feedback form uses mock implementation (lines 126-144 in `feedback/new/page.tsx`)
- ❌ Real API endpoint exists but is not connected
- ❌ Users cannot actually save feedback to database
- ❌ PII redaction, moderation, and rate limiting features are bypassed

**Home Page**:
- ❌ Landing page (/) and dashboard (/dashboard) have redundant content
- ❌ Dashboard shows "Coming Soon" placeholders instead of real data
- ❌ No personalized experience based on user role
- ❌ Authenticated users see generic landing page first

---

## 3. Solution Overview

### 3.1 Navigation System Architecture

**Approach**: **Collapsible Sidebar + Top Bar (Hybrid)**

**Rationale**:
- Supports 40+ pages across 7+ domains (Feedback, Roadmap, Features, Research, Moderation, Analytics, Admin)
- Vertical space allows logical grouping of navigation sections
- Role-based visibility without cluttering interface
- Progressive disclosure (collapsible sidebar)
- Mobile adaptable (converts to drawer)
- Enterprise desktop-first tool pattern

**Components**:

```
┌─────────────────────────────────────────────────────────────────┐
│  [Sidebar]  │  Top Bar: Logo | Breadcrumbs | Search | 🔔 | Avatar│
│             ├───────────────────────────────────────────────────┤
│  📍 Home    │  Main Content Area                                │
│  📋 Feedback│  Page-specific content here                       │
│  🗺️ Roadmap │                                                   │
│  🏷️ Features│                                                   │
│  🔬 Research│  (Research section only visible to RESEARCHER/PM) │
│  🛡️ Moderate│  (Moderation only visible to MODERATOR/PM/PO)    │
│  📊 Analytics│  (Analytics only visible to PM/PO/ADMIN)         │
│  ⚙️ Settings│                                                   │
│  🔧 Admin   │  (Admin only visible to ADMIN role)               │
└─────────────────────────────────────────────────────────────────┘
```

**Mobile Behavior**:
- Sidebar converts to Sheet (slide-out drawer)
- Hamburger menu in top bar
- Same navigation items, responsive layout

---

### 3.2 Feedback Saving Fix

**Current State**:
```typescript
// src/app/feedback/new/page.tsx (lines 126-144)
// TODO: Replace with real API call
// const response = await fetch('/api/feedback', {...});

// Mock implementation
await new Promise(resolve => setTimeout(resolve, 1000));
const mockId = 'fb_new_' + Date.now();
```

**Solution**:
1. Uncomment real API call (lines 126-133)
2. Remove mock implementation (lines 135-144)
3. Handle API response properly (success/error states)
4. Map form fields to API schema:
   - `title` → `title`
   - `body` → `body`
   - `productArea` → `featureId` (requires lookup)
   - `villageContext` → `villageId`

**Benefits**:
- ✅ Feedback persists to database
- ✅ PII redaction active
- ✅ Auto-moderation screening
- ✅ Rate limiting enforced (10/day)
- ✅ Vote tracking enabled
- ✅ Edit window (15 min) enforced

---

### 3.3 Home Page Improvements

**Decision**: Keep separate public landing + enhanced dashboard

**Public Landing Page** (`/`):
- Purpose: Marketing for unauthenticated visitors
- Content: Value proposition, feature highlights, Sign In CTA
- Behavior: Redirect authenticated users to `/dashboard`

**Authenticated Dashboard** (`/dashboard`):
- Purpose: Personalized home base for authenticated users
- Content:
  - Welcome message with user context
  - Quick actions (Submit Feedback, View Roadmap)
  - Role-specific sections:
    - **USER**: My Feedback, Pending Questionnaires
    - **PM/PO**: Moderation Queue (count badge), Top Voted Feedback, Analytics Summary
    - **RESEARCHER**: Active Studies, Recruitment Status
    - **MODERATOR**: Items Requiring Review (SLA countdown)
    - **ADMIN**: System Health, Recent Activity
  - Activity feed (recent feedback, roadmap updates)
  - Trending feedback (top 5 by weighted votes)

**Route Mapping**:
```
/              → Public landing (or redirect if authenticated)
/auth/signin   → Auth entry point
/dashboard     → Default post-login destination (personalized)
```

---

## 4. Technical Specification

### 4.1 Navigation System Components

#### 4.1.1 File Structure

```
src/components/layout/
├── navigation-config.ts        # Nav items with role filtering
├── nav-link.tsx                # Client: Active link detection
├── main-nav.tsx                # Server: Desktop navigation
├── mobile-nav.tsx              # Client: Mobile Sheet navigation
├── user-nav.tsx                # Client: User dropdown menu
├── app-header.tsx              # Server: Top bar composition
└── breadcrumbs.tsx             # Server: Breadcrumb navigation

src/app/
├── layout.tsx                  # Root (providers only, no changes)
├── page.tsx                    # Public landing (add redirect logic)
├── (authenticated)/            # NEW: Route group
│   ├── layout.tsx              # NEW: Main app layout with navigation
│   ├── dashboard/page.tsx      # Enhanced dashboard
│   ├── feedback/...            # Move from app/feedback
│   ├── roadmap/...             # Move from app/roadmap
│   ├── features/...            # Move from app/features
│   ├── research/...            # Move from app/research
│   ├── moderation/...          # Move from app/moderation
│   ├── analytics/...           # Move from app/analytics
│   ├── settings/...            # Move from app/settings
│   └── admin/...               # Move from app/admin
└── auth/                       # Unchanged
```

#### 4.1.2 Navigation Configuration

```typescript
// components/layout/navigation-config.ts
import { Role } from '@prisma/client';
import {
  LayoutDashboard, MessageSquare, Map, Box,
  FlaskConical, Shield, BarChart3, Settings, Settings2
} from 'lucide-react';

export type NavItem = {
  title: string;
  href: string;
  icon: React.ComponentType<{ className?: string }>;
  roles?: Role[];  // If undefined, visible to all authenticated users
  exactMatch?: boolean;
  badge?: boolean; // For notification counts (e.g., moderation queue)
};

export const navigationItems: NavItem[] = [
  {
    title: 'Dashboard',
    href: '/dashboard',
    icon: LayoutDashboard,
    exactMatch: true,
  },
  {
    title: 'Feedback',
    href: '/feedback',
    icon: MessageSquare,
  },
  {
    title: 'Roadmap',
    href: '/roadmap',
    icon: Map,
  },
  {
    title: 'Features',
    href: '/features',
    icon: Box,
  },
  {
    title: 'Research',
    href: '/research',
    icon: FlaskConical,
    roles: ['RESEARCHER', 'PM', 'ADMIN'],
  },
  {
    title: 'Moderation',
    href: '/moderation',
    icon: Shield,
    roles: ['MODERATOR', 'PM', 'PO', 'ADMIN'],
    badge: true, // Show count of pending items
  },
  {
    title: 'Analytics',
    href: '/analytics',
    icon: BarChart3,
    roles: ['PM', 'PO', 'RESEARCHER', 'ADMIN'],
  },
  {
    title: 'Settings',
    href: '/settings',
    icon: Settings,
  },
  {
    title: 'Admin',
    href: '/admin',
    icon: Settings2,
    roles: ['ADMIN'],
  },
];

export function filterNavByRole(items: NavItem[], role?: Role): NavItem[] {
  return items.filter(item =>
    !item.roles || (role && item.roles.includes(role))
  );
}
```

#### 4.1.3 Role-Based Visibility Matrix

| Section | USER | PM | PO | RESEARCHER | MODERATOR | ADMIN |
|---------|------|----|----|------------|-----------|-------|
| Dashboard | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| Feedback | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| Roadmap | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| Features | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| Research | - | ✓ | - | ✓ | - | ✓ |
| Moderation | - | ✓ | ✓ | - | ✓ | ✓ |
| Analytics | - | ✓ | ✓ | ✓ | - | ✓ |
| Settings | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| Admin | - | - | - | - | - | ✓ |

#### 4.1.4 Component Implementation Pattern

**Server Component** (Default):
```tsx
// components/layout/app-header.tsx
import { getSession } from '@/lib/session';
import { MainNav } from './main-nav';
import { UserNav } from './user-nav';
import { NotificationBell } from '@/components/notifications/notification-bell';
import { MobileNav } from './mobile-nav';

export async function AppHeader() {
  const session = await getSession();

  return (
    <header className="sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
      <div className="container flex h-16 items-center">
        {/* Logo */}
        <Link href="/dashboard" className="mr-6 flex items-center space-x-2">
          <span className="hidden font-bold sm:inline-block">
            Gentil Feedback
          </span>
        </Link>

        {/* Desktop Navigation */}
        <nav className="hidden lg:flex flex-1">
          <MainNav role={session?.user.role} />
        </nav>

        {/* Mobile Navigation */}
        <div className="lg:hidden">
          <MobileNav role={session?.user.role} />
        </div>

        {/* Right side (always visible) */}
        <div className="ml-auto flex items-center space-x-4">
          <NotificationBell />
          <UserNav user={session?.user} />
        </div>
      </div>
    </header>
  );
}
```

**Client Component** (Interactive):
```tsx
// components/layout/nav-link.tsx
'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { cn } from '@/lib/utils';
import type { NavItem } from './navigation-config';

interface NavLinkProps {
  item: NavItem;
}

export function NavLink({ item }: NavLinkProps) {
  const pathname = usePathname();

  const isActive = item.exactMatch
    ? pathname === item.href
    : pathname.startsWith(item.href);

  return (
    <Link
      href={item.href}
      className={cn(
        "flex items-center gap-2 text-sm font-medium transition-colors hover:text-primary",
        isActive
          ? "text-foreground"
          : "text-muted-foreground"
      )}
    >
      <item.icon className="h-4 w-4" />
      <span>{item.title}</span>
    </Link>
  );
}
```

#### 4.1.5 Mobile Responsiveness

**Breakpoints**:
- **Mobile** (`< 1024px`): Hamburger menu with Sheet drawer
- **Desktop** (`>= 1024px`): Persistent horizontal navigation

```tsx
// components/layout/mobile-nav.tsx
'use client';

import { Menu } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Sheet, SheetContent, SheetTrigger } from '@/components/ui/sheet';
import { navigationItems, filterNavByRole } from './navigation-config';
import { NavLink } from './nav-link';
import type { Role } from '@prisma/client';

interface MobileNavProps {
  role?: Role;
}

export function MobileNav({ role }: MobileNavProps) {
  const visibleItems = filterNavByRole(navigationItems, role);

  return (
    <Sheet>
      <SheetTrigger asChild>
        <Button variant="ghost" size="icon" className="lg:hidden">
          <Menu className="h-5 w-5" />
          <span className="sr-only">Toggle navigation menu</span>
        </Button>
      </SheetTrigger>
      <SheetContent side="left" className="w-[280px] sm:w-[320px]">
        <nav className="flex flex-col space-y-4 mt-6">
          {visibleItems.map(item => (
            <NavLink key={item.href} item={item} />
          ))}
        </nav>
      </SheetContent>
    </Sheet>
  );
}
```

#### 4.1.6 Breadcrumb Navigation

```tsx
// components/layout/breadcrumbs.tsx
import Link from 'next/link';
import { ChevronRight } from 'lucide-react';

interface BreadcrumbItem {
  title: string;
  href?: string;
}

interface BreadcrumbsProps {
  items: BreadcrumbItem[];
}

export function Breadcrumbs({ items }: BreadcrumbsProps) {
  return (
    <nav className="flex items-center space-x-1 text-sm text-muted-foreground" aria-label="Breadcrumb">
      <Link href="/dashboard" className="hover:text-foreground transition-colors">
        Home
      </Link>
      {items.map((item, index) => (
        <div key={index} className="flex items-center space-x-1">
          <ChevronRight className="h-4 w-4" />
          {item.href ? (
            <Link href={item.href} className="hover:text-foreground transition-colors">
              {item.title}
            </Link>
          ) : (
            <span className="font-medium text-foreground">{item.title}</span>
          )}
        </div>
      ))}
    </nav>
  );
}

// Usage example in page:
// <Breadcrumbs items={[
//   { title: 'Feedback', href: '/feedback' },
//   { title: feedback.title },
// ]} />
```

---

### 4.2 Feedback Saving Implementation

#### 4.2.1 API Schema Mapping

**Form Fields → API Payload**:

```typescript
// Current form schema
const formSchema = z.object({
  title: z.string().min(8).max(120),
  body: z.string().min(20).max(5000),
  productArea: z.string().optional(),      // Product area name
  villageContext: z.string().optional(),   // Village name
});

// API expects
interface CreateFeedbackInput {
  title: string;
  body: string;
  featureId?: string;       // Feature ID (not product area)
  villageId?: string;       // Village ID (not name)
  source?: 'app' | 'web' | 'kiosk' | 'support' | 'import';
  visibility?: 'public' | 'internal';
}
```

**Mapping Strategy**:
1. **productArea → featureId**:
   - Option A: Create a lookup function to find feature by area
   - Option B: Remove productArea field, add feature selector (better UX)
   - **Recommended**: Remove productArea, it's not needed for MVP

2. **villageContext → villageId**:
   - Option A: Lookup village by name
   - Option B: Auto-use user's current village (`session.user.currentVillageId`)
   - **Recommended**: Use user's current village, remove manual input

#### 4.2.2 Code Changes

```typescript
// src/app/feedback/new/page.tsx (lines 121-154)

const onSubmit = async (values: FormValues) => {
  setIsSubmitting(true);

  try {
    // Real API call
    const response = await fetch('/api/feedback', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title: values.title,
        body: values.body,
        source: 'app',
        visibility: 'public',
      }),
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || 'Failed to create feedback');
    }

    const data = await response.json();

    toast({
      title: 'Feedback submitted',
      description: 'Thank you for sharing your feedback!',
    });

    // Redirect to actual feedback page
    router.push(`/feedback/${data.data.id}`);
  } catch (err) {
    toast({
      title: 'Error',
      description: err instanceof Error ? err.message : 'Failed to submit feedback',
      variant: 'destructive',
    });
  } finally {
    setIsSubmitting(false);
  }
};
```

**Additional Changes**:
- Remove `productArea` and `villageContext` fields from form (not used in API)
- Add feature linking after feedback creation (separate step or optional)
- Display validation errors from API properly

---

### 4.3 Home Page & Dashboard Enhancement

#### 4.3.1 Public Landing Page

```tsx
// src/app/page.tsx
import { getSession } from '@/lib/session';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { Button } from '@/components/ui/button';

export default async function HomePage() {
  const session = await getSession();

  // Redirect authenticated users to dashboard
  if (session) {
    redirect('/dashboard');
  }

  return (
    <main className="flex min-h-screen flex-col items-center justify-center p-24">
      <div className="z-10 w-full max-w-5xl">
        <h1 className="text-4xl font-bold mb-4">Gentil Feedback</h1>
        <p className="text-xl mb-8 text-muted-foreground">
          Product feedback and user research platform for Club Med
        </p>

        <Button asChild size="lg">
          <Link href="/auth/signin">Sign In to Get Started</Link>
        </Button>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-12">
          <div className="p-6 border rounded-lg">
            <h2 className="text-2xl font-semibold mb-2">📋 Feedback</h2>
            <p className="text-muted-foreground">
              Collect and vote on product feedback from your team
            </p>
          </div>
          <div className="p-6 border rounded-lg">
            <h2 className="text-2xl font-semibold mb-2">🗺️ Roadmap</h2>
            <p className="text-muted-foreground">
              Share your product roadmap and communicate progress
            </p>
          </div>
          <div className="p-6 border rounded-lg">
            <h2 className="text-2xl font-semibold mb-2">🔬 Research</h2>
            <p className="text-muted-foreground">
              Conduct user research, surveys, and usability testing
            </p>
          </div>
        </div>
      </div>
    </main>
  );
}
```

#### 4.3.2 Enhanced Dashboard

```tsx
// src/app/(authenticated)/dashboard/page.tsx
import { requireAuth } from '@/lib/session';
import { prisma } from '@/lib/prisma';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import { MessageSquarePlus, Map, TrendingUp } from 'lucide-react';

export default async function DashboardPage() {
  const session = await requireAuth();

  // Fetch user-specific data
  const [myFeedbackCount, pendingModerationCount, trendingFeedback] = await Promise.all([
    // Count user's feedback
    prisma.feedback.count({
      where: { authorId: session.user.id },
    }),

    // Count pending moderation (if MODERATOR/PM/PO)
    ['MODERATOR', 'PM', 'PO', 'ADMIN'].includes(session.user.role)
      ? prisma.feedback.count({ where: { moderationStatus: 'pending_review' } })
      : Promise.resolve(0),

    // Top 5 trending feedback by weighted votes
    prisma.feedback.findMany({
      take: 5,
      where: { state: { in: ['new', 'triaged'] } },
      orderBy: { createdAt: 'desc' }, // TODO: Sort by vote weight
      include: {
        author: { select: { displayName: true } },
        _count: { select: { votes: true } },
      },
    }),
  ]);

  return (
    <div className="space-y-8">
      {/* Welcome Section */}
      <div>
        <h1 className="text-3xl font-bold tracking-tight">
          Welcome back, {session.user.displayName || session.user.email}! 👋
        </h1>
        <p className="text-muted-foreground">
          Here's what's happening with Gentil Feedback today
        </p>
      </div>

      {/* Quick Actions */}
      <div className="flex gap-4">
        <Button asChild>
          <Link href="/feedback/new">
            <MessageSquarePlus className="mr-2 h-4 w-4" />
            Submit Feedback
          </Link>
        </Button>
        <Button asChild variant="outline">
          <Link href="/roadmap">
            <Map className="mr-2 h-4 w-4" />
            View Roadmap
          </Link>
        </Button>
      </div>

      {/* Activity Summary */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">My Feedback</CardTitle>
            <MessageSquare className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{myFeedbackCount}</div>
            <p className="text-xs text-muted-foreground">
              Total feedback items submitted
            </p>
          </CardContent>
        </Card>

        {/* Show moderation queue for MODERATOR/PM/PO */}
        {['MODERATOR', 'PM', 'PO', 'ADMIN'].includes(session.user.role) && (
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Pending Review</CardTitle>
              <Shield className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{pendingModerationCount}</div>
              <p className="text-xs text-muted-foreground">
                Items awaiting moderation
              </p>
              {pendingModerationCount > 0 && (
                <Button asChild variant="link" className="px-0 mt-2">
                  <Link href="/moderation">Review Queue →</Link>
                </Button>
              )}
            </CardContent>
          </Card>
        )}
      </div>

      {/* Trending Feedback */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <TrendingUp className="h-5 w-5" />
            Trending Feedback
          </CardTitle>
          <CardDescription>Most recent feedback from the community</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            {trendingFeedback.map(feedback => (
              <Link
                key={feedback.id}
                href={`/feedback/${feedback.id}`}
                className="flex items-start justify-between p-3 rounded-lg border hover:bg-accent transition-colors"
              >
                <div className="flex-1">
                  <p className="font-medium">{feedback.title}</p>
                  <p className="text-sm text-muted-foreground">
                    by {feedback.author.displayName} • {feedback._count.votes} votes
                  </p>
                </div>
                <Badge variant="secondary">{feedback.state}</Badge>
              </Link>
            ))}
          </div>
          <Button asChild variant="outline" className="w-full mt-4">
            <Link href="/feedback">View All Feedback →</Link>
          </Button>
        </CardContent>
      </Card>
    </div>
  );
}
```

---

### 4.4 DSL Updates

Add navigation-specific UI hints to `dsl/global.yaml`:

```yaml
# ---------- UI Hints (optional) ----------
ui_hints:
  feedback:
    show_duplicate_suggestions: true
    editor:
      min_title_chars: 8
      min_body_chars: 20
  roadmap:
    group_by: "stage"
    show_vote_counts_on_linked_feedback: true
  research:
    badge_consent_status: true

  # NEW: Navigation hints
  navigation:
    layout: "sidebar_top_bar"          # sidebar_top_bar | top_bar_only | sidebar_only
    sidebar:
      default_state: "expanded"         # expanded | collapsed
      persist_state: true               # Remember user preference
      collapsible: true                 # Allow user to collapse
      mobile_behavior: "drawer"         # drawer | bottom_sheet
    breadcrumbs:
      enabled: true
      show_icons: false                 # Show icons in breadcrumbs
      max_items: 4                      # Truncate long paths
    mobile:
      breakpoint: "lg"                  # sm | md | lg | xl
      hamburger_position: "left"        # left | right
```

**Rationale**: These UI hints provide frontend guidance without changing core domain logic. They can be consumed by the navigation components to adjust behavior.

---

## 5. User Stories

### 5.1 Navigation System

**US-NAV-001**: As a **USER**, I want to see a navigation menu on every page so I can easily move between Feedback, Roadmap, and Settings without using the back button.

**Acceptance Criteria**:
- [x] Navigation visible on all authenticated pages
- [x] Active link highlighted
- [x] Keyboard accessible (Tab, Enter)
- [x] Mobile responsive (Sheet drawer)

**US-NAV-002**: As a **RESEARCHER**, I want to see the Research section in navigation (hidden from regular users) so I can access Panels, Questionnaires, and Sessions quickly.

**Acceptance Criteria**:
- [x] Research link only visible to RESEARCHER, PM, ADMIN
- [x] USER role does not see Research link
- [x] Navigation updates immediately after role change

**US-NAV-003**: As a **MODERATOR**, I want to see a badge with the count of pending items in the Moderation nav link so I know how many items need review at a glance.

**Acceptance Criteria**:
- [x] Badge shows count of `moderationStatus: 'pending_review'`
- [x] Badge updates in real-time (or on page refresh)
- [x] Badge only visible to MODERATOR, PM, PO, ADMIN

**US-NAV-004**: As a **mobile USER**, I want to access navigation via a hamburger menu so I can navigate on my phone or tablet.

**Acceptance Criteria**:
- [x] Hamburger icon visible on screens < 1024px
- [x] Sheet drawer opens from left
- [x] Same navigation items as desktop
- [x] Drawer closes when link is clicked

---

### 5.2 Feedback Saving

**US-FEED-FIX-001**: As a **USER**, I want my feedback to be saved to the database when I submit it so I can view it later and others can vote on it.

**Acceptance Criteria**:
- [x] Submitting feedback creates a record in the database
- [x] Feedback ID is a ULID (e.g., `fb_01HZX...`)
- [x] Success toast shows after submission
- [x] User is redirected to `/feedback/{id}` page
- [x] PII is automatically redacted
- [x] Moderation screening runs (toxicity, spam, PII)
- [x] Rate limit enforced (10 submissions per day)

**US-FEED-FIX-002**: As a **USER**, I want to see clear error messages if my feedback submission fails so I can fix issues and try again.

**Acceptance Criteria**:
- [x] Validation errors displayed inline (e.g., "Title too short")
- [x] API errors shown in toast (e.g., "Rate limit exceeded")
- [x] Form remains filled if submission fails
- [x] Submit button disabled during submission

---

### 5.3 Home Page & Dashboard

**US-DASH-001**: As a **USER**, I want to see a personalized dashboard after login so I know what's happening with my feedback and what I should do next.

**Acceptance Criteria**:
- [x] Dashboard shows user's name and role
- [x] Quick actions: Submit Feedback, View Roadmap
- [x] Activity summary: My Feedback count
- [x] Trending feedback section (top 5)
- [x] No "Coming Soon" placeholders

**US-DASH-002**: As a **MODERATOR**, I want to see the count of pending moderation items on my dashboard so I can prioritize my work.

**Acceptance Criteria**:
- [x] Card shows count of `moderationStatus: 'pending_review'`
- [x] Link to moderation queue if count > 0
- [x] Only visible to MODERATOR, PM, PO, ADMIN

**US-DASH-003**: As an **unauthenticated visitor**, I want to see a landing page explaining Gentil Feedback so I understand what it is before signing in.

**Acceptance Criteria**:
- [x] Landing page accessible at `/`
- [x] Shows value proposition and feature highlights
- [x] "Sign In" CTA button
- [x] Redirects to `/dashboard` if already authenticated

---

## 6. Accessibility Requirements

### 6.1 WCAG 2.1 AA Compliance

**Keyboard Navigation**:
- [x] All nav items accessible via Tab key
- [x] Enter key activates links
- [x] Escape key closes mobile Sheet
- [x] Skip to main content link (for screen readers)

**Screen Reader Support**:
- [x] Semantic HTML (`<nav>`, `<header>`, `<main>`)
- [x] ARIA labels for icon-only buttons (e.g., hamburger)
- [x] `aria-current="page"` for active links
- [x] Live region announcements for notifications

**Color Contrast**:
- [x] Minimum 4.5:1 for text
- [x] Minimum 3:1 for UI components
- [x] Active link indicators use both color and border (non-color indicator)

**Focus Indicators**:
- [x] Visible focus ring on all interactive elements
- [x] Focus trap in mobile Sheet (Tab cycles within)
- [x] Logical tab order (left to right, top to bottom)

---

## 7. Implementation Plan

### 7.1 Phase 1: Core Navigation (Days 1-2)

**Day 1: Foundation**
1. Install shadcn Sheet component: `npx shadcn-ui@latest add sheet`
2. Create `components/layout/navigation-config.ts` with nav items
3. Create `components/layout/nav-link.tsx` (client component)
4. Create `components/layout/main-nav.tsx` (server component)

**Day 2: Header & Mobile**
5. Create `components/layout/user-nav.tsx` (client component with DropdownMenu)
6. Create `components/layout/mobile-nav.tsx` (client component with Sheet)
7. Create `components/layout/app-header.tsx` (server component composing all)
8. Create `components/layout/breadcrumbs.tsx` (server component)

### 7.2 Phase 2: Route Group Migration (Day 3)

**Day 3: Layout Structure**
9. Create `src/app/(authenticated)/` folder
10. Create `src/app/(authenticated)/layout.tsx` with AppHeader
11. Move all authenticated pages to `(authenticated)/` route group:
    - dashboard/
    - feedback/
    - roadmap/
    - features/
    - research/
    - moderation/
    - analytics/
    - settings/
    - admin/
12. Test routing (URLs should be unchanged)

### 7.3 Phase 3: Feedback Fix & Dashboard (Day 4)

**Day 4: Functionality**
13. Update `src/app/feedback/new/page.tsx`:
    - Uncomment real API call
    - Remove mock implementation
    - Remove productArea and villageContext fields
14. Update `src/app/page.tsx` with redirect logic
15. Enhance `src/app/(authenticated)/dashboard/page.tsx`:
    - Add activity summary cards
    - Add trending feedback section
    - Add role-specific content
16. Update `dsl/global.yaml` with navigation UI hints

### 7.4 Phase 4: Testing & Polish (Day 5)

**Day 5: QA**
17. Test navigation on all pages
18. Test role-based visibility (login as USER, PM, RESEARCHER, MODERATOR, ADMIN)
19. Test mobile responsiveness (Sheet drawer)
20. Test feedback submission (real API integration)
21. Test breadcrumbs on detail pages
22. Run accessibility audit (Lighthouse, axe DevTools)
23. Fix any bugs or issues
24. Document completion in task tracker

---

## 8. Testing Strategy

### 8.1 Manual Testing Checklist

**Navigation**:
- [ ] Navigation visible on all authenticated pages (Dashboard, Feedback, Roadmap, Features, Research, Moderation, Analytics, Settings, Admin)
- [ ] Active link highlighted correctly (blue text + border)
- [ ] Role-based filtering works:
  - [ ] USER: Cannot see Research, Moderation, Analytics, Admin
  - [ ] PM: Can see Research, Moderation, Analytics (not Admin)
  - [ ] RESEARCHER: Can see Research, Analytics (not Moderation, Admin)
  - [ ] MODERATOR: Can see Moderation (not Research, Analytics, Admin)
  - [ ] ADMIN: Can see all sections
- [ ] Mobile Sheet drawer:
  - [ ] Opens on hamburger click
  - [ ] Shows all navigation items
  - [ ] Closes on link click
  - [ ] Closes on Escape key
  - [ ] Focus trap works (Tab cycles within drawer)
- [ ] User dropdown menu:
  - [ ] Shows user name, email, role badge
  - [ ] Shows current village (if set)
  - [ ] Settings link works
  - [ ] Sign Out button works

**Feedback Saving**:
- [ ] Feedback submission creates database record
- [ ] Success toast appears
- [ ] Redirect to `/feedback/{id}` page
- [ ] PII redaction works (test with phone number, email)
- [ ] Moderation screening works (test with profanity)
- [ ] Rate limit enforced (submit 11 items in a day → error)
- [ ] Validation errors displayed (title too short, body too short)
- [ ] API error handling (disconnect network → error toast)

**Dashboard**:
- [ ] Dashboard shows personalized welcome
- [ ] Quick actions visible (Submit Feedback, View Roadmap)
- [ ] My Feedback count accurate
- [ ] Pending moderation count accurate (MODERATOR/PM/PO only)
- [ ] Trending feedback section shows 5 items
- [ ] Links work correctly
- [ ] Unauthenticated users redirected to landing page

**Accessibility**:
- [ ] Keyboard navigation works (Tab, Enter, Escape)
- [ ] Screen reader announces navigation (test with VoiceOver or NVDA)
- [ ] Focus indicators visible (ring on focused links)
- [ ] Color contrast passes (use browser DevTools contrast checker)
- [ ] Lighthouse Accessibility score >= 95

### 8.2 Automated Testing (Future)

```typescript
// Example: Navigation role filtering test
describe('Navigation', () => {
  it('shows Research link only to RESEARCHER, PM, ADMIN', () => {
    const userNav = filterNavByRole(navigationItems, 'USER');
    expect(userNav.find(item => item.href === '/research')).toBeUndefined();

    const researcherNav = filterNavByRole(navigationItems, 'RESEARCHER');
    expect(researcherNav.find(item => item.href === '/research')).toBeDefined();
  });
});

// Example: Feedback submission test
describe('Feedback Submission', () => {
  it('creates feedback with real API', async () => {
    const response = await fetch('/api/feedback', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title: 'Test feedback item',
        body: 'This is a test feedback description.',
      }),
    });

    expect(response.status).toBe(201);
    const data = await response.json();
    expect(data.success).toBe(true);
    expect(data.data.id).toMatch(/^fb_/);
  });
});
```

---

## 9. Success Metrics (Post-Launch)

| Metric | Target | Measurement |
|--------|--------|-------------|
| Navigation Accessibility | 100% of pages | Manual audit |
| Role Filtering Accuracy | 100% correct | Test with all 6 roles |
| Mobile Navigation Usability | >4.5/5 | User survey |
| Feedback Submission Success Rate | >95% | Database logs vs form submits |
| Lighthouse Accessibility Score | >=95 | Automated Lighthouse CI |
| User Session Time | +20% vs pre-navigation | Google Analytics |
| Feedback Submission Volume | +30% vs mock implementation | Database query |
| Dashboard Engagement | >60% click on quick actions | Event tracking |

---

## 10. Risks & Mitigation

### 10.1 Technical Risks

**Risk 1**: Route group migration breaks existing links
- **Impact**: High (users get 404 errors)
- **Likelihood**: Low (route groups don't change URLs)
- **Mitigation**: Test all routes after migration, keep URL structure identical

**Risk 2**: Role-based filtering bypassed on client-side
- **Impact**: High (security vulnerability)
- **Likelihood**: Low (server-side filtering)
- **Mitigation**: Always filter on server, never trust client-side filtering alone

**Risk 3**: Mobile Sheet drawer performance issues on older devices
- **Impact**: Medium (poor UX on low-end devices)
- **Likelihood**: Low (shadcn Sheet is well-optimized)
- **Mitigation**: Test on real devices, use React.lazy if needed

### 10.2 UX Risks

**Risk 4**: Users don't notice new navigation (change blindness)
- **Impact**: Medium (low adoption of new features)
- **Likelihood**: Medium
- **Mitigation**: Show onboarding tour on first login after update, announce in changelog

**Risk 5**: Breadcrumbs clutter on mobile
- **Impact**: Low (slightly worse mobile UX)
- **Likelihood**: Medium (breadcrumbs take vertical space)
- **Mitigation**: Hide breadcrumbs on very small screens (<640px), keep on tablets

---

## 11. Dependencies

### 11.1 External Dependencies

- **shadcn/ui Sheet component**: `npx shadcn-ui@latest add sheet`
  - Used for mobile navigation drawer
  - Dependency: Radix UI Dialog primitive

### 11.2 Internal Dependencies

- `lib/session.ts`: Session management utilities (existing)
- `components/notifications/notification-bell.tsx`: Notification icon (existing)
- `components/auth/sign-out-button.tsx`: Sign out button (existing)
- API endpoint `/api/feedback`: Feedback creation (existing)

### 11.3 Browser Support

- **Modern browsers**: Chrome, Firefox, Safari, Edge (latest 2 versions)
- **Mobile browsers**: iOS Safari 14+, Chrome Android 90+
- **No IE11 support** (Next.js 14 requirement)

---

## 12. Out of Scope (Future Enhancements)

**Deferred to Future PRDs**:
- [ ] Command palette (Cmd+K search) for global navigation
- [ ] Recently viewed items in navigation
- [ ] Favorites/bookmarks feature
- [ ] Customizable sidebar (drag-and-drop reordering)
- [ ] Dark mode toggle in user menu
- [ ] Multi-language navigation (i18n)
- [ ] Village switcher for users with multiple villages
- [ ] Contextual help tooltips on first use
- [ ] Advanced dashboard widgets (charts, graphs)

---

## 13. Documentation Requirements

### 13.1 User-Facing Documentation

Update `docs/USER_GUIDE.md`:
- [ ] Section on using navigation (desktop and mobile)
- [ ] Explanation of role-based visibility
- [ ] How to use breadcrumbs for deep navigation
- [ ] Dashboard overview and quick actions

### 13.2 Developer Documentation

Create `docs/NAVIGATION.md`:
- [ ] Navigation architecture explanation
- [ ] How to add new navigation items
- [ ] Role-based filtering guide
- [ ] Component API reference
- [ ] Testing navigation components

Update `CLAUDE.md`:
- [ ] Add navigation component patterns
- [ ] Update layout structure diagram
- [ ] Document route group pattern

---

## 14. Rollout Plan

### 14.1 Pre-Launch Checklist

- [ ] All components created and tested
- [ ] Route group migration completed
- [ ] Feedback API integration tested
- [ ] Dashboard enhancements deployed
- [ ] DSL updated
- [ ] Accessibility audit passed
- [ ] Manual testing checklist completed
- [ ] Documentation updated
- [ ] Stakeholder demo completed

### 14.2 Launch

- [ ] Deploy to production
- [ ] Monitor error logs for 24 hours
- [ ] Send announcement email to users
- [ ] Update changelog
- [ ] Create GitHub release (v0.5.1)

### 14.3 Post-Launch

- [ ] Collect user feedback (survey after 1 week)
- [ ] Monitor analytics (session time, feedback submissions)
- [ ] Address bug reports within 48 hours
- [ ] Plan next iteration based on feedback

---

## 15. Appendix

### 15.1 Wireframes

**Desktop Navigation**:
```
┌─────────────────────────────────────────────────────────────────┐
│  Gentil Feedback    Feedback | Roadmap | Features | Research   │
│                                              [🔔] [Avatar ▼]     │
├─────────────────────────────────────────────────────────────────┤
│  Home > Feedback > FB_01J0X                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Page Content Here                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Mobile Navigation**:
```
┌─────────────────────────────────┐
│  [☰]  Gentil  [🔔] [Avatar ▼] │
├─────────────────────────────────┤
│                                 │
│  Page Content                   │
│                                 │
└─────────────────────────────────┘

[☰ tapped]
┌─────────────────────┐
│  Navigation         │
│                     │
│  📍 Dashboard       │
│  📋 Feedback        │
│  🗺️ Roadmap         │
│  🏷️ Features        │
│  🔬 Research        │  ← Only if RESEARCHER
│  🛡️ Moderation      │  ← Only if MODERATOR
│  ⚙️ Settings        │
└─────────────────────┘
```

### 15.2 Color Palette for Navigation

```css
/* Active link */
--nav-active-bg: hsl(var(--accent));
--nav-active-text: hsl(var(--accent-foreground));
--nav-active-border: hsl(var(--primary));

/* Hover */
--nav-hover-bg: hsl(var(--accent) / 0.5);

/* Inactive */
--nav-inactive-text: hsl(var(--muted-foreground));
```

### 15.3 Icon Reference

Icons from `lucide-react`:
- Dashboard: `LayoutDashboard`
- Feedback: `MessageSquare`
- Roadmap: `Map`
- Features: `Box`
- Research: `FlaskConical`
- Moderation: `Shield`
- Analytics: `BarChart3`
- Settings: `Settings`
- Admin: `Settings2`
- Menu (hamburger): `Menu`
- Breadcrumb separator: `ChevronRight`
- User dropdown: `User`, `LogOut`, `MapPin`

---

**Document Version**: 1.0
**Author**: Product Team
**Approvers**: PO, Engineering Lead, UX Lead
**Next Review**: After implementation completion