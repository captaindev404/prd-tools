# PRD-004: Next.js 15.5 Upgrade

**Version**: 1.0
**Status**: Draft
**Created**: 2025-10-06
**Author**: Engineering Team
**Epic**: Platform Modernization

## Executive Summary

Upgrade Gentil Feedback platform from Next.js 14.2.16 to Next.js 15.5 to leverage performance improvements, Turbopack production builds (beta), stable Node.js middleware, enhanced TypeScript support, and maintain framework currency for security patches and future compatibility.

## Current State

- **Current Version**: Next.js 14.2.16
- **Target Version**: Next.js 15.5
- **React Version**: 18.3.1 (compatible)
- **Next-Auth Version**: 5.0.0-beta.29 (needs verification)
- **Node.js Version**: Compatible with Next.js 15.5 (18.18.0+ required)

## Motivation

### Business Value
- **Performance**: Turbopack builds offer up to 10x faster compilation vs Webpack
- **Developer Experience**: Faster local development and build times reduce iteration cycles
- **Security**: Access to latest security patches and framework updates
- **Future-Proofing**: Next.js 16 deprecation warnings addressed early
- **Stability**: Node.js middleware runtime now stable (used in our auth flow)

### Technical Debt
- Next.js 14 will eventually enter maintenance mode
- Risk of dependency incompatibility with future packages
- Missing optimization features (partial prerendering, improved caching)

### Risks of Not Upgrading
- Security vulnerabilities in older versions
- Incompatibility with newer React/TypeScript features
- Degraded performance vs modern alternatives
- Increased technical debt accumulation

## Goals

### Primary Goals
1. Successfully upgrade to Next.js 15.5 with zero downtime
2. Maintain all existing functionality (auth, API routes, server components)
3. Validate performance improvements in development and production
4. Update documentation and developer workflows

### Non-Goals
- Rewrite existing App Router code to new patterns
- Migrate to experimental features (Turbopack for builds in production)
- Change authentication provider or architecture

## Success Metrics

- ✅ All existing tests pass post-upgrade
- ✅ Build time reduction: Target 20%+ improvement
- ✅ Development server startup: Target 30%+ improvement
- ✅ Zero production incidents related to upgrade
- ✅ All API routes return correct responses
- ✅ Authentication flow works identically
- ✅ TypeScript compilation successful with no new errors

## Requirements

### Functional Requirements

#### FR-1: Package Updates
**Priority**: P0
**Description**: Update all Next.js-related dependencies to compatible versions

**Acceptance Criteria**:
- Next.js upgraded from 14.2.16 → 15.5
- React/React-DOM remain at 18.3.1 (verify compatibility)
- ESLint config updated: `eslint-config-next` 14.2.16 → 15.5
- Next-Auth compatibility verified (5.0.0-beta.29 or upgraded)
- All Radix UI components tested for compatibility
- `@tanstack/react-query` validated (currently 5.90.2)

#### FR-2: Breaking Changes Audit
**Priority**: P0
**Description**: Identify and address all breaking changes from Next.js 14 → 15

**Key Breaking Changes**:
1. **Async Request APIs** (Pages Router only - not applicable to our App Router setup)
2. **Runtime Config Changes**: Verify no usage of `publicRuntimeConfig` or `serverRuntimeConfig`
3. **Fetch Caching**: Default fetch caching behavior changed (now `cache: 'no-store'` by default)
4. **Route Handlers**: Check for dynamic route params usage
5. **Middleware**: Node.js runtime now stable (currently in beta in v14)

**Acceptance Criteria**:
- Fetch calls explicitly define cache behavior: `{ cache: 'force-cache' }` or `{ cache: 'no-store' }`
- All route handlers using `params` updated to await destructured params
- Middleware configuration validated for Node.js runtime
- No deprecated Next.js APIs in codebase

#### FR-3: TypeScript Configuration
**Priority**: P1
**Description**: Leverage Next.js 15.5 TypeScript improvements

**New Features**:
- Typed routes validation
- Route export validation
- Route types helpers

**Acceptance Criteria**:
- `tsconfig.json` updated with recommended Next.js 15 settings
- Type errors from stricter route validation resolved
- All route handlers have correct export signatures

#### FR-4: Build Configuration
**Priority**: P1
**Description**: Optimize build configuration for Next.js 15.5

**Acceptance Criteria**:
- Production builds succeed with `next build`
- Optional: Test Turbopack builds with `next build --turbopack` (beta)
- Build output size compared vs v14 baseline
- Static/dynamic route split validated
- Edge runtime compatibility checked (if used)

#### FR-5: Authentication Flow Validation
**Priority**: P0
**Description**: Ensure NextAuth.js v5 works seamlessly with Next.js 15.5

**Acceptance Criteria**:
- Azure AD authentication flow successful
- Session handling works correctly
- Middleware auth checks function identically
- Protected routes redirect as expected
- User session persistence validated

### Non-Functional Requirements

#### NFR-1: Performance
- Development server starts in <5s (current baseline: ~7s)
- Production build completes in <3min (current baseline: ~4min)
- First Contentful Paint (FCP) unchanged or improved
- Time to Interactive (TTI) unchanged or improved

#### NFR-2: Compatibility
- Node.js 18.18.0+ or 20.x+ required
- All existing browser support maintained
- SQLite/Prisma integration unaffected
- Redis/IORedis compatibility verified

#### NFR-3: Developer Experience
- Hot Module Replacement (HMR) faster or equal
- TypeScript IntelliSense improvements leveraged
- Error messages clearer (Next.js 15 improvement)
- Build logs more informative

## Technical Design

### Phase 1: Preparation (2 hours)

#### 1.1 Backup & Branch
```bash
git checkout -b upgrade/nextjs-15.5
git push -u origin upgrade/nextjs-15.5
```

#### 1.2 Dependency Audit
- Run `npm outdated` to identify other stale packages
- Check Next-Auth v5 compatibility: https://authjs.dev/getting-started/migrating-to-v5
- Verify Prisma, Radix UI, TanStack Query release notes

#### 1.3 Test Baseline
```bash
npm run build                  # Record build time
npm run test                   # Ensure all tests pass
npm run lint                   # Record lint warnings
```

### Phase 2: Package Upgrade (1 hour)

#### 2.1 Update package.json
```json
{
  "dependencies": {
    "next": "15.5.0",
    "next-auth": "^5.0.0-beta.29"  // Verify latest beta
  },
  "devDependencies": {
    "eslint-config-next": "15.5.0"
  }
}
```

#### 2.2 Install Dependencies
```bash
rm -rf node_modules package-lock.json
npm install
```

#### 2.3 Update Prisma Client
```bash
npm run db:generate
```

### Phase 3: Code Migration (4 hours)

#### 3.1 Fetch API Migration
**Impact**: API routes, server components, server actions

**Before (Next.js 14)**:
```typescript
// Default: cache: 'force-cache'
const data = await fetch('https://api.example.com/data');
```

**After (Next.js 15)**:
```typescript
// Explicitly opt into caching
const data = await fetch('https://api.example.com/data', {
  cache: 'force-cache'
});

// Or opt out (new default behavior)
const data = await fetch('https://api.example.com/data', {
  cache: 'no-store'
});
```

**Files to Update**:
- `src/app/api/**/*.ts` - All API route handlers
- `src/app/**/page.tsx` - Server components with fetch calls
- `src/lib/*.ts` - Utility functions making HTTP requests

#### 3.2 Route Handler Params Migration
**Impact**: Dynamic API routes with `[id]` or `[slug]` params

**Before (Next.js 14)**:
```typescript
export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  const id = params.id;
}
```

**After (Next.js 15)**:
```typescript
export async function GET(
  request: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
}
```

**Files to Update**:
- `src/app/api/feedback/[id]/route.ts`
- `src/app/api/research/panels/[id]/route.ts`
- All dynamic API routes in `src/app/api/`

#### 3.3 Middleware Updates
**Current**: Uses Edge runtime (default in v14)
**Next.js 15**: Node.js runtime now stable

**File**: `src/middleware.ts`

```typescript
// Add explicit runtime config if needed
export const config = {
  matcher: [
    '/((?!api|_next/static|_next/image|favicon.ico).*)',
  ],
  // Optional: Use Node.js runtime for middleware
  runtime: 'nodejs', // or 'edge' (default)
};
```

#### 3.4 TypeScript Config Updates
**File**: `tsconfig.json`

```json
{
  "compilerOptions": {
    "strict": true,
    "skipLibCheck": true,
    "noUncheckedIndexedAccess": true,  // Recommended for Next.js 15
    "plugins": [
      {
        "name": "next"
      }
    ]
  }
}
```

#### 3.5 Next.js Config Updates
**File**: `next.config.js` or `next.config.mjs`

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  // Remove deprecated options (if any)
  // reactStrictMode: true, // Keep this

  // Optional: Enable Turbopack for dev (default in v15)
  // turbo: {},

  // Optional: Enable experimental features
  experimental: {
    // typedRoutes: true,  // Enable typed routes
  },
};

export default nextConfig;
```

### Phase 4: Testing (3 hours)

#### 4.1 Unit Tests
```bash
npm run test:unit
```
**Expected**: All tests pass with no new failures

#### 4.2 Build Validation
```bash
npm run build
```
**Verify**:
- No build errors
- Build time improvement recorded
- Static/dynamic routes correctly classified

#### 4.3 Local Development Testing
```bash
npm run dev
```
**Manual Test Checklist**:
- [ ] Homepage loads
- [ ] Sign in with Azure AD
- [ ] Create feedback item
- [ ] Vote on feedback
- [ ] View roadmap
- [ ] Access research panels
- [ ] Settings page loads
- [ ] Admin panel (if role=ADMIN)
- [ ] API routes return JSON

#### 4.4 E2E Tests
```bash
npm run test:e2e
```
**Expected**: All Playwright tests pass

#### 4.5 Accessibility Tests
- Run Lighthouse audit
- Verify no new accessibility regressions

### Phase 5: Documentation (1 hour)

#### 5.1 Update README.md
- Update Next.js version badge
- Update installation requirements
- Add Node.js version requirement (18.18.0+)

#### 5.2 Update CLAUDE.md
```diff
### Core Framework
- **Next.js 14** - React framework with App Router (server components)
+ **Next.js 15.5** - React framework with App Router, Turbopack dev
```

#### 5.3 Create Migration Guide
**File**: `docs/NEXTJS_15_MIGRATION.md`
- Document breaking changes encountered
- List all code changes made
- Provide rollback instructions
- Add troubleshooting section

#### 5.4 Update API Documentation
- Verify all API examples still work
- Update any code samples referencing Next.js features

### Phase 6: Deployment (1 hour)

#### 6.1 Staging Deployment
- Deploy to staging environment
- Run smoke tests
- Validate analytics/logging

#### 6.2 Production Deployment
- Create deployment checklist
- Monitor error rates post-deployment
- Have rollback plan ready

#### 6.3 Post-Deployment Monitoring
- Check application logs for errors
- Monitor performance metrics
- Verify authentication success rates

## Migration Checklist

### Pre-Migration
- [ ] Create backup branch
- [ ] Document current build metrics
- [ ] Run full test suite (baseline)
- [ ] Audit Next-Auth v5 compatibility
- [ ] Review Next.js 15 release notes
- [ ] Check community issues on GitHub

### Migration Tasks
- [ ] Update `package.json` dependencies
- [ ] Clear `node_modules` and reinstall
- [ ] Update all `fetch()` calls with explicit cache options
- [ ] Migrate dynamic route params to `await params`
- [ ] Update middleware config (if needed)
- [ ] Update `tsconfig.json` settings
- [ ] Review and update `next.config.js`
- [ ] Fix TypeScript errors from stricter checking
- [ ] Update imports if path aliases changed

### Testing
- [ ] Unit tests pass
- [ ] Build succeeds with no errors
- [ ] Dev server starts successfully
- [ ] Authentication flow works
- [ ] All API routes return correct data
- [ ] E2E tests pass
- [ ] Performance benchmarks meet targets
- [ ] Accessibility audit passes

### Documentation
- [ ] Update README.md
- [ ] Update CLAUDE.md
- [ ] Create NEXTJS_15_MIGRATION.md
- [ ] Update API docs (if needed)
- [ ] Update deployment guide

### Deployment
- [ ] Deploy to staging
- [ ] Staging smoke tests pass
- [ ] Create production deployment plan
- [ ] Deploy to production
- [ ] Monitor error rates (first 24h)
- [ ] Verify analytics data collection

## Dependencies & Impacts

### Affected Systems
- **Authentication**: NextAuth.js middleware, session handling
- **API Routes**: All routes in `src/app/api/`
- **Server Components**: Pages with fetch calls
- **Database**: Prisma client (regenerate required)
- **Build Pipeline**: CI/CD scripts may need updates
- **Development Environment**: Node.js version requirements

### Dependency Updates Required

#### Critical Dependencies
```json
{
  "next": "14.2.16" → "15.5.0",
  "eslint-config-next": "14.2.16" → "15.5.0",
  "next-auth": "^5.0.0-beta.29" → "^5.0.0-beta.30+" // Verify
}
```

#### Verification Needed
- `@auth/prisma-adapter`: 2.10.0 (check compatibility)
- `@tanstack/react-query`: 5.90.2 (check compatibility)
- All Radix UI components (likely compatible)
- `prisma`: 6.16.3 (check compatibility)

### Third-Party Integrations
- **Vercel Deployment**: Automatic Next.js 15 support
- **SendGrid**: No impact
- **Redis/IORedis**: No impact
- **Azure AD**: Verify NextAuth adapter compatibility

## Rollback Plan

### Rollback Triggers
- Authentication completely broken
- Build failures in production
- >5% increase in error rates
- Critical functionality unavailable
- Performance degradation >20%

### Rollback Steps
1. **Git Revert**:
   ```bash
   git revert <merge-commit-sha>
   git push origin main
   ```

2. **Package Restore**:
   ```bash
   git checkout main -- package.json package-lock.json
   npm ci
   npm run build
   ```

3. **Deployment**:
   - Trigger production deployment of previous version
   - Verify rollback success

4. **Communication**:
   - Notify stakeholders of rollback
   - Document failure reasons
   - Plan remediation steps

## Timeline & Effort Estimate

| Phase | Duration | Owner |
|-------|----------|-------|
| Preparation | 2 hours | Engineering |
| Package Upgrade | 1 hour | Engineering |
| Code Migration | 4 hours | Engineering |
| Testing | 3 hours | Engineering + QA |
| Documentation | 1 hour | Engineering |
| Deployment | 1 hour | DevOps + Engineering |
| **Total** | **12 hours** | **~1.5 days** |

### Critical Path
1. Package updates → Code migration → Build validation → Testing → Deployment

### Parallel Work Opportunities
- Documentation can be written during testing
- Staging deployment during final test validation

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Breaking changes in fetch API | High | High | Explicit cache directives, thorough testing |
| Next-Auth incompatibility | Medium | Critical | Verify beta version, test auth flow extensively |
| Performance regression | Low | Medium | Benchmark before/after, rollback if needed |
| Build failures in production | Low | Critical | Staging validation, gradual rollout |
| TypeScript compilation errors | Medium | Medium | Fix incrementally, use `@ts-expect-error` temporarily |
| Third-party package conflicts | Low | High | Audit dependencies, check GitHub issues |

## Open Questions

1. **Next-Auth Version**: Should we upgrade to latest beta (post-beta.29) or wait for stable v5?
2. **Turbopack Production**: Should we enable `--turbopack` for production builds (beta)?
3. **Node.js Runtime**: Should middleware use Node.js runtime or remain on Edge?
4. **Typed Routes**: Should we enable experimental `typedRoutes` feature?
5. **Deployment Strategy**: Blue/green deployment or rolling update?

## Success Criteria Summary

### Must Have (P0)
- ✅ All existing functionality works identically
- ✅ Authentication flow successful
- ✅ Zero production errors from upgrade
- ✅ Build succeeds without errors

### Should Have (P1)
- ✅ 20%+ build time improvement
- ✅ 30%+ dev server startup improvement
- ✅ All tests pass
- ✅ Documentation updated

### Nice to Have (P2)
- ✅ TypeScript typed routes enabled
- ✅ Turbopack dev mode faster HMR
- ✅ Improved error messages visible to devs

## References

- [Next.js 15.5 Release Notes](https://nextjs.org/blog/next-15-5)
- [Next.js 15 Upgrade Guide](https://nextjs.org/docs/app/building-your-application/upgrading/version-15)
- [Next.js Breaking Changes](https://nextjs.org/docs/app/building-your-application/upgrading/version-15#breaking-changes)
- [NextAuth.js v5 Migration](https://authjs.dev/getting-started/migrating-to-v5)
- [Turbopack Documentation](https://nextjs.org/docs/app/api-reference/turbopack)

## Approval & Sign-off

| Role | Name | Date | Signature |
|------|------|------|-----------|
| Engineering Lead | TBD | | |
| Product Manager | TBD | | |
| DevOps Lead | TBD | | |

---

**Document History**:
- v1.0 (2025-10-06): Initial draft
