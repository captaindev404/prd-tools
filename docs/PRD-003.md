# Product Requirements Document (PRD-003)
# Sidebar Navigation, Research Features, and Feedback Enhancements

**Project**: Odyssey Feedback Platform Enhancement
**Version**: 0.6.0
**Date**: 2025-10-03
**Status**: Draft - Pending Approval
**Related**: PRD v0.5.0 (docs/PRD.md), PRD-002 (docs/PRD-002.md)

---

## 1. Executive Summary

This PRD defines a comprehensive set of improvements to the Odyssey Feedback platform, focusing on:

1. **Sidebar Navigation System**: Transform horizontal top navigation to a collapsible shadcn sidebar with role-based filtering
2. **Research Panels Feature**: Complete implementation of eligibility-based user cohorts for research studies
3. **Questionnaires Feature**: Full questionnaire builder with multi-language support, analytics, and exports
4. **Feedback Form Enhancement**: Restore `villageContext` and `productArea` fields for better categorization

### 1.1 Success Metrics

- Sidebar navigation accessible on 100% of authenticated pages
- Panel creation success rate >90% (with eligibility preview)
- Questionnaire response rate >60% (for targeted panels)
- Feedback categorization accuracy +40% (with productArea field)
- Mobile navigation usability score >4.5/5
- WCAG 2.1 AA compliance score: 100%
- Research feature adoption by 80% of RESEARCHER users within 4 weeks

---

## 2. Problem Statement

### 2.1 Current Pain Points

**Navigation**:
- ❌ Horizontal navigation doesn't scale to 40+ pages
- ❌ No clear visual hierarchy for 7+ domain sections
- ❌ Profile link in user dropdown is redundant with Settings
- ❌ Research link points to generic `/research` instead of primary destination `/research/sessions`
- ❌ Dashboard page has unnecessary sub-header causing visual clutter

**Research Features**:
- ❌ Research panels exist in schema but have incomplete UI/UX
- ❌ No visual eligibility rules builder (manual JSON editing required)
- ❌ Questionnaires lack comprehensive question builder
- ❌ No analytics dashboard for questionnaire responses
- ❌ Missing export functionality (CSV/Parquet)
- ❌ Multi-language support (EN/FR) incomplete

**Feedback Categorization**:
- ❌ `villageContext` and `productArea` fields removed in PRD-002 implementation
- ❌ Feedback lacks product taxonomy context
- ❌ Cannot filter feedback by product area (Reservations, Check-in, etc.)
- ❌ Village context lost for multi-village deployments

---

## 3. Solution Overview

### 3.1 Sidebar Navigation Architecture

**Approach**: **Collapsible Sidebar + Top Bar (Hybrid)**

**Components**:

```
┌─────────────────────────────────────────────────────────────────┐
│  [Logo] Breadcrumbs                 [🔔] [Avatar ▼]  │ Top Bar (64px)
├────────┬────────────────────────────────────────────────────────┤
│        │                                                         │
│ Dash   │                                                         │
│ ━━━━   │                                                         │
│ PRODUCT│         Main Content Area                              │
│ Feed   │                                                         │
│ Feat   │                                                         │
│ Road   │                                                         │
│ ━━━━   │                                                         │
│ INSIGHTS                                                         │
│ Rese ▼ │                                                         │
│  ·Sess │                                                         │
│  ·Panel│                                                         │
│  ·Quest│                                                         │
│ Anal   │                                                         │
│ ━━━━   │                                                         │
│ ADMIN  │                                                         │
│ Mode   │                                                         │
│ Admin  │                                                         │
│        │                                                         │
│ [<]    │                                                         │ Collapse toggle
└────────┴────────────────────────────────────────────────────────┘
  240px (expanded) / 64px (collapsed)
```

**Key Changes**:
1. Remove Profile link from user dropdown (keep Settings and Sign Out)
2. Change Research link from `/research` → `/research/sessions`
3. Remove sub-header from dashboard page
4. Add collapsible sidebar with three sections: PRODUCT, INSIGHTS, ADMIN
5. Make Research expandable with sub-items (Sessions, Panels, Questionnaires)

**Mobile Behavior** (<768px):
- Sidebar converts to drawer (Sheet component)
- Hamburger menu in top bar
- Overlay backdrop with swipe-to-close
- Same navigation hierarchy

---

### 3.2 Research Panels Feature

**Complete Implementation**:

**3.2.1 Panel Management**

Pages:
- `/research/panels` - List all panels with filters (search, creator, archived)
- `/research/panels/new` - Create panel wizard with eligibility builder
- `/research/panels/[id]` - Panel details with member list
- `/research/panels/[id]/edit` - Edit panel configuration
- `/research/panels/[id]/members` - Member management interface

**3.2.2 Eligibility Rules Builder** (Visual UI)

Interactive component for building complex rules:

```typescript
interface EligibilityRules {
  include_roles: Role[];
  include_villages: string[]; // ["vlg-001"] or ["all"]
  attributes_predicates: Array<{
    key: string;      // "department", "job_title"
    op: "in" | "eq" | "contains";
    value: string | string[];
  }>;
  required_consents: Array<"research_contact" | "usage_analytics" | "email_updates">;
}
```

**UI Features**:
- Section 1: Role checkboxes (USER, PM, PO, RESEARCHER)
- Section 2: Village selector (all or specific)
- Section 3: Advanced attribute filters (+ Add Rule button)
- Section 4: Required consent checkboxes
- Preview button → Shows estimated user count

**3.2.3 Member Management**

Features:
- Bulk invite users with eligibility checking
- Manual override for ADMIN (skip eligibility)
- Quota tracking (e.g., 50% Reception, 30% FOH, 20% Housekeeping)
- Remove members with confirmation
- Member list with pagination and search
- Consent status indicators

**3.2.4 API Enhancements**

New Endpoints:
- `PATCH /api/panels/[id]` - Update panel configuration
- `DELETE /api/panels/[id]` - Soft delete (archive)
- `POST /api/panels/[id]/members` - Bulk invite with validation
- `GET /api/panels/[id]/eligibility-preview` - Preview matching users

---

### 3.3 Questionnaires Feature

**Complete Implementation**:

**3.3.1 Questionnaire Management**

Pages:
- `/research/questionnaires` - List with status filters (draft/published/closed)
- `/research/questionnaires/new` - Multi-step creation wizard
- `/research/questionnaires/[id]` - Response form for users (if eligible)
- `/research/questionnaires/[id]/edit` - Edit draft questionnaires
- `/research/questionnaires/[id]/analytics` - Analytics dashboard
- `/research/questionnaires/[id]/responses` - All responses (RESEARCHER only)

**3.3.2 Question Builder** (Visual UI)

Support for 6 question types:

1. **Likert Scale**: 1-5 rating (configurable scale)
2. **NPS**: 0-10 scale (fixed for NPS)
3. **MCQ Single**: Single choice from options
4. **MCQ Multiple**: Multiple choices allowed
5. **Free Text**: Open-ended text response
6. **Number**: Numeric input with min/max

**Multi-Language Support**:
```typescript
{
  text: {
    en: "How satisfied are you with check-in?",
    fr: "Êtes-vous satisfait du check-in ?"
  }
}
```

**UI Features**:
- Add/remove/reorder questions (drag-and-drop or ↑↓ buttons)
- Toggle between EN/FR preview
- Required field checkbox
- Type-specific configuration (scale range, MCQ options, text limits)
- Duplicate question button
- Question ID auto-generation

**3.3.3 Targeting Configuration**

Options:
- **Panel-based**: Select one or more panels
- **Ad-hoc filters**: Village, role, feature interactions
- **Hybrid**: Combine panel + filters

**Delivery Settings**:
- Mode: in-app, email, or both
- Schedule: Start/end dates (optional)
- Max responses: Limit total responses
- Response limit per user: Default 1

**3.3.4 Analytics Dashboard**

**Overview Cards**:
- Total responses
- Completion rate (responses / audience)
- Average NPS (if NPS question present)

**Per-Question Analytics**:

Likert/Scale:
- Distribution chart (bar chart showing count per score)
- Mean, median, mode
- Standard deviation

NPS:
- NPS score calculation: (promoters% - detractors%) × 100
- Promoters (9-10), Passives (7-8), Detractors (0-6) counts
- Pie chart visualization

MCQ:
- Bar chart showing option distribution
- Percentage breakdown

Free Text:
- Response count
- Sample responses (first 10)
- Word cloud (future enhancement)

**Segmentation**:
- By village
- By role
- By panel membership

**3.3.5 Export Functionality**

Formats:
- **CSV**: Standard spreadsheet format
- **JSON**: Structured data for analysis
- **Parquet**: Future enhancement for big data tools

Options:
- Include PII: Yes/No (RESEARCHER only)
- Segment by: None, Village, Role, Panel

**CSV Structure**:
```csv
respondent_id,email,completed_at,village_id,role,q1_score,q2_score,q3_text
usr_01J0X...,user@example.com,2025-10-03T10:00:00Z,vlg-001,USER,4,9,"Great experience"
```

**3.3.6 API Enhancements**

New/Enhanced Endpoints:
- `PATCH /api/questionnaires/[id]` - Update draft questionnaires
- `POST /api/questionnaires/[id]/publish` - Enhanced with validation
- `GET /api/questionnaires/[id]/analytics` - Comprehensive analytics
- `GET /api/questionnaires/[id]/export` - CSV/JSON export with PII options

---

### 3.4 Feedback Form Enhancement

**Restore Removed Fields**:

**3.4.1 Village Context**

Field: `villageContext` (select dropdown)

Purpose:
- Allow users to specify village context for feedback
- Useful for multi-village deployments
- Auto-populate with user's current village as default
- Optional field (not all feedback is village-specific)

UI:
```tsx
<Select id="villageContext" value={formData.villageContext}>
  <option value="">No specific village</option>
  <option value="vlg-001">La Rosière</option>
  <option value="vlg-002">Val Thorens</option>
  {/* ... */}
</Select>
```

**3.4.2 Product Area**

Field: `productArea` (select dropdown)

Values (from DSL):
- Reservations
- Check-in
- Payments
- Housekeeping
- Backoffice

Purpose:
- Categorize feedback by product domain
- Enable filtering in feedback list
- Help PMs route feedback to correct teams
- Improve analytics segmentation

UI:
```tsx
<Select id="productArea" value={formData.productArea}>
  <option value="">No specific area</option>
  <option value="Reservations">Reservations</option>
  <option value="CheckIn">Check-in</option>
  <option value="Payments">Payments</option>
  <option value="Housekeeping">Housekeeping</option>
  <option value="Backoffice">Backoffice</option>
</Select>
```

**3.4.3 API Changes**

Backend Mapping:
```typescript
// POST /api/feedback
const feedback = await prisma.feedback.create({
  data: {
    title: body.title,
    body: body.body,
    villageId: body.villageContext || user.currentVillageId,
    productArea: body.productArea, // NEW
    // ... rest
  }
});
```

---

## 4. Technical Specification

### 4.1 Sidebar Navigation Implementation

**4.1.1 shadcn Components Required**

```bash
npx shadcn@latest add sidebar
npx shadcn@latest add avatar
npx shadcn@latest add dropdown-menu
npx shadcn@latest add separator
npx shadcn@latest add tooltip
npx shadcn@latest add scroll-area
```

**4.1.2 File Structure**

```
src/components/layout/
├── app-sidebar.tsx              # Main sidebar component
├── app-header.tsx               # Top bar (breadcrumbs, notifications, user)
├── app-layout.tsx               # Root layout wrapper with SidebarProvider
└── nav-user.tsx                 # User profile footer in sidebar
```

**4.1.3 Component Architecture**

**Server vs Client Strategy**:
- `app/(authenticated)/layout.tsx` - Server Component (fetches session)
- `app-layout.tsx` - Client Component (handles collapse state)
- `app-sidebar.tsx` - Client Component (active state, role filtering)
- `app-header.tsx` - Client Component (breadcrumbs from pathname)
- `nav-user.tsx` - Client Component (dropdown menu)

**State Management**:
```typescript
// Persist collapsed state in localStorage
const [collapsed, setCollapsed] = useState(false);

useEffect(() => {
  const stored = localStorage.getItem('sidebar-collapsed');
  if (stored) setCollapsed(JSON.parse(stored));
}, []);

const handleCollapsedChange = (value: boolean) => {
  setCollapsed(value);
  localStorage.setItem('sidebar-collapsed', JSON.stringify(value));
};
```

**4.1.4 Navigation Configuration**

```typescript
const navigationItems = [
  { title: 'Dashboard', href: '/dashboard', icon: LayoutDashboard },

  // PRODUCT Section
  { section: 'PRODUCT' },
  { title: 'Feedback', href: '/feedback', icon: MessageSquare },
  { title: 'Features', href: '/features', icon: Grid3x3 },
  { title: 'Roadmap', href: '/roadmap', icon: Map },

  // INSIGHTS Section
  { section: 'INSIGHTS' },
  {
    title: 'Research',
    href: '/research/sessions',  // Changed from /research
    icon: FlaskConical,
    allowedRoles: ['RESEARCHER', 'PM', 'ADMIN'],
    expandable: true,
    children: [
      { title: 'Sessions', href: '/research/sessions' },
      { title: 'Panels', href: '/research/panels' },
      { title: 'Questionnaires', href: '/research/questionnaires' },
    ]
  },
  { title: 'Analytics', href: '/analytics', icon: BarChart3, allowedRoles: ['PM', 'PO', 'ADMIN'] },

  // ADMIN Section
  { section: 'ADMIN' },
  { title: 'Moderation', href: '/moderation', icon: Shield, allowedRoles: ['MODERATOR', 'ADMIN'] },
  { title: 'Admin', href: '/admin', icon: Settings2, allowedRoles: ['ADMIN'] },
];
```

**4.1.5 User Dropdown Changes**

Remove:
- ~~Profile~~ (redundant with Settings)

Keep:
- Settings → `/settings`
- Sign Out → `signOut()` action

**4.1.6 Dashboard Page Change**

Remove sub-header:
```tsx
// BEFORE
<div className="sub-header">
  <NotificationBell />
  <UserNav />
</div>

// AFTER (moved to AppHeader)
// Dashboard page only shows main content
```

---

### 4.2 Research Panels Implementation

**4.2.1 Data Model Enhancement**

Prisma Schema Changes:
```prisma
model Panel {
  // ... existing fields
  description       String?  // NEW
  createdById       String   // NEW
  createdBy         User     @relation("PanelCreator", fields: [createdById], references: [id])
  archived          Boolean  @default(false) // NEW

  @@index([createdById])
  @@index([archived])
}

model User {
  // ... existing fields
  createdPanels     Panel[] @relation("PanelCreator")
}
```

**4.2.2 API Endpoints**

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/api/panels` | List panels with filters | Authenticated |
| POST | `/api/panels` | Create panel | RESEARCHER/PM/ADMIN |
| GET | `/api/panels/[id]` | Get panel details | Authenticated |
| PATCH | `/api/panels/[id]` | Update panel | Creator/RESEARCHER/PM/ADMIN |
| DELETE | `/api/panels/[id]` | Archive panel | Creator/ADMIN |
| GET | `/api/panels/[id]/members` | List members | RESEARCHER/PM/ADMIN |
| POST | `/api/panels/[id]/members` | Invite members | RESEARCHER/PM/ADMIN |
| DELETE | `/api/panels/[id]/members/[userId]` | Remove member | RESEARCHER/PM/ADMIN |
| GET | `/api/panels/[id]/eligibility-preview` | Preview eligible users | RESEARCHER/PM/ADMIN |

**4.2.3 Key Components**

| Component | Type | Purpose |
|-----------|------|---------|
| `PanelList` | Client | List with filters, search, pagination |
| `PanelCard` | Server | Summary card in list view |
| `PanelForm` | Client | Create/edit form |
| `EligibilityRulesBuilder` | Client | Visual rule builder ⭐ |
| `QuotaManager` | Client | Quota configuration |
| `MemberList` | Client | Member table with actions |
| `InviteMembersDialog` | Client | Bulk invite modal |
| `EligibilityPreview` | Client | Preview matching users |

**4.2.4 Permission Model**

```typescript
// Create: RESEARCHER, PM, ADMIN
canCreatePanel(user: SessionUser): boolean

// Edit: Creator OR RESEARCHER/PM/ADMIN
canEditPanel(user: SessionUser, panel: Panel): boolean

// Delete: Creator OR ADMIN
canDeletePanel(user: SessionUser, panel: Panel): boolean

// Invite: RESEARCHER, PM, ADMIN
canInviteToPanel(user: SessionUser): boolean
```

---

### 4.3 Questionnaires Implementation

**4.3.1 Data Model (No Changes Required)**

Existing schema is sufficient:
```prisma
model Questionnaire {
  id            String   @id // qnn_${ulid}
  title         String
  questions     String   // JSON: Question[]
  panelIds      String   @default("[]") // JSON: string[]
  adHocFilters  String   @default("{}") // JSON: object
  status        QuestionnaireStatus
  startAt       DateTime?
  endAt         DateTime?
  maxResponses  Int?
  // ... existing fields
}
```

**4.3.2 API Endpoints**

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/api/questionnaires` | List questionnaires | Authenticated |
| POST | `/api/questionnaires` | Create questionnaire | RESEARCHER/PM/ADMIN |
| GET | `/api/questionnaires/[id]` | Get questionnaire | Authenticated |
| PATCH | `/api/questionnaires/[id]` | Update draft | Creator/RESEARCHER/PM/ADMIN |
| POST | `/api/questionnaires/[id]/publish` | Publish | Creator/RESEARCHER/PM/ADMIN |
| POST | `/api/questionnaires/[id]/responses` | Submit response | Eligible users |
| GET | `/api/questionnaires/[id]/analytics` | Get analytics | RESEARCHER/PM/PO/ADMIN |
| GET | `/api/questionnaires/[id]/export` | Export responses | RESEARCHER/PM/ADMIN |

**4.3.3 Key Components**

| Component | Type | Purpose |
|-----------|------|---------|
| `QuestionnaireList` | Client | List with status filters |
| `QuestionnaireCard` | Server | Summary card |
| `QuestionnaireForm` | Client | Create/edit form |
| `QuestionBuilder` | Client | Visual question builder ⭐ |
| `QuestionRenderer` | Client | Render question for response |
| `TargetingConfig` | Client | Panel + ad-hoc filters |
| `AnalyticsDashboard` | Client | Charts and metrics ⭐ |
| `ExportDialog` | Client | Export options modal |

**4.3.4 Question Types Configuration**

```typescript
interface Question {
  id: string;
  type: 'likert' | 'nps' | 'mcq_single' | 'mcq_multiple' | 'text' | 'number';
  text: { en: string; fr: string };
  required: boolean;

  // Type-specific
  scale?: { min: number; max: number }; // Likert, Number
  options?: Array<{ id: string; label: { en: string; fr: string } }>; // MCQ
  minLength?: number; // Text
  maxLength?: number; // Text
  min?: number; // Number
  max?: number; // Number
}
```

**4.3.5 Analytics Computation**

Service: `/src/lib/questionnaire-analytics.ts`

**NPS Calculation**:
```typescript
const promoters = scores.filter(s => s >= 9).length;
const detractors = scores.filter(s => s < 7).length;
const npsScore = ((promoters - detractors) / scores.length) * 100;
```

**Likert Distribution**:
```typescript
const distribution: Record<number, number> = {};
scores.forEach(score => {
  distribution[score] = (distribution[score] || 0) + 1;
});
```

**Segmentation**:
```typescript
// Group by village
const byVillage = responses.reduce((acc, r) => {
  const village = r.respondent.currentVillageId;
  if (!acc[village]) acc[village] = [];
  acc[village].push(r);
  return acc;
}, {});
```

**4.3.6 Export Implementation**

CSV Format:
```csv
respondent_id,email,completed_at,village_id,role,q1,q2,q3_text
usr_01J...,user@example.com,2025-10-03T10:00:00Z,vlg-001,USER,4,9,"Good"
```

Privacy:
- `includePII=false`: Omit email, hash respondent_id
- `includePII=true`: Include email (RESEARCHER only, requires consent)

---

### 4.4 Feedback Form Enhancement

**4.4.1 Schema Update**

```prisma
model Feedback {
  // ... existing fields
  villageId        String?        // Already exists - ensure proper usage
  productArea      ProductArea?   // NEW ENUM
  // ... rest
}

enum ProductArea {
  Reservations
  CheckIn      // Maps to "Check-in"
  Payments
  Housekeeping
  Backoffice
}
```

**4.4.2 Form Component Update**

File: `/src/app/(authenticated)/feedback/new/page.tsx`

Add Fields:
```tsx
// Village Context
<FormField name="villageContext">
  <Label>Village Context (Optional)</Label>
  <Select
    value={formData.villageContext}
    defaultValue={session.user.currentVillageId}
  >
    <option value="">No specific village</option>
    {villages.map(v => <option value={v.id}>{v.name}</option>)}
  </Select>
  <FormDescription>
    Select if this feedback is specific to a village
  </FormDescription>
</FormField>

// Product Area
<FormField name="productArea">
  <Label>Product Area (Optional)</Label>
  <Select value={formData.productArea}>
    <option value="">No specific area</option>
    <option value="Reservations">Reservations</option>
    <option value="CheckIn">Check-in</option>
    <option value="Payments">Payments</option>
    <option value="Housekeeping">Housekeeping</option>
    <option value="Backoffice">Backoffice</option>
  </Select>
  <FormDescription>
    Which product area does this feedback relate to?
  </FormDescription>
</FormField>
```

**4.4.3 API Update**

```typescript
// POST /api/feedback
const feedback = await prisma.feedback.create({
  data: {
    title: body.title,
    body: body.body,
    villageId: body.villageContext || user.currentVillageId || null,
    productArea: body.productArea || null, // NEW
    source: body.source,
    visibility: body.visibility,
    authorId: user.id,
    // ... rest
  }
});
```

**4.4.4 Feedback List Filtering**

Add Filter:
```tsx
<Select value={productAreaFilter}>
  <option value="">All Product Areas</option>
  <option value="Reservations">Reservations</option>
  <option value="CheckIn">Check-in</option>
  {/* ... */}
</Select>
```

Query:
```typescript
// GET /api/feedback?productArea=CheckIn
const where = {
  productArea: productAreaFilter || undefined,
  // ... other filters
};
```

---

### 4.5 DSL Updates

**File**: `dsl/global.yaml`

**4.5.1 Add Sidebar Navigation Hints**

```yaml
ui_hints:
  navigation:
    layout: "sidebar_top_bar"
    sidebar:
      default_state: "expanded"
      persist_state: true
      collapsible: true
      mobile_behavior: "drawer"
      width_expanded: "240px"
      width_collapsed: "64px"
    breadcrumbs:
      enabled: true
      show_icons: false
      max_items: 4
      separator: "chevron"
    mobile:
      breakpoint: "lg"
      hamburger_position: "left"
    active_link:
      indicator: "border_and_color"
      show_icon_highlight: true
    user_menu:
      show_profile_link: false  # NEW: Removed
      show_settings_link: true
      show_sign_out: true
    research_submenu:
      default_route: "/research/sessions"  # NEW
      show_submenu: true
      items: ["sessions", "panels", "questionnaires"]
```

**4.5.2 Enhance Research Specifications**

```yaml
research:
  panels:
    schema:
      # ... existing fields
      description: "string"           # NEW
      created_by_id: "usr_${ulid}"    # NEW
      archived: "boolean"             # NEW
    ui_hints:
      show_eligibility_preview: true  # NEW
      preview_sample_size: 10
      quota_visualization: "progress_bars"

  questionnaires:
    schema:
      # ... existing fields
      question_types:
        - "likert"
        - "nps"
        - "mcq_single"
        - "mcq_multiple"
        - "text"
        - "number"
    analytics:
      compute_nps: true               # NEW
      segmentation: ["village", "role", "panel"]  # NEW
      export_formats: ["csv", "json", "parquet"]
    ui_hints:
      show_language_toggle: true      # NEW
      default_language: "en"
      require_both_translations: true
```

**4.5.3 Restore Feedback Fields**

```yaml
feedback:
  schema:
    # ... existing fields
    village_context: "vlg_* | null"   # Clarify usage
    product_area: "Reservations | CheckIn | Payments | Housekeeping | Backoffice | null"  # NEW
  ui_hints:
    show_village_selector: true       # NEW
    show_product_area_selector: true  # NEW
    auto_populate_village: true       # Use currentVillageId
```

---

## 5. User Stories

### 5.1 Sidebar Navigation

**US-NAV-005**: As a **USER**, I want a collapsible sidebar so I can maximize content space when reviewing long feedback threads.

**Acceptance Criteria**:
- [x] Sidebar collapses to icon-only mode (64px width)
- [x] Collapse state persists in localStorage
- [x] Tooltips show on hover in collapsed mode
- [x] Keyboard shortcut (Ctrl+B) toggles sidebar

**US-NAV-006**: As a **RESEARCHER**, I want the Research nav item to expand to show Sessions, Panels, and Questionnaires so I can quickly navigate to my primary tasks.

**Acceptance Criteria**:
- [x] Research item shows chevron icon indicating expandable state
- [x] Clicking Research navigates to `/research/sessions`
- [x] Expanded state shows 3 sub-items with indentation
- [x] Sub-items highlight when active
- [x] Expanded state persists in localStorage

**US-NAV-007**: As a **power user**, I want the sidebar to remember my collapsed state across sessions so I don't have to collapse it every time I log in.

**Acceptance Criteria**:
- [x] Collapsed state saved to localStorage on toggle
- [x] Page load restores previous state
- [x] State is user-specific (not global)
- [x] Mobile always uses drawer (no persistence needed)

---

### 5.2 Research Panels

**US-PANEL-001**: As a **RESEARCHER**, I want a visual eligibility rules builder so I can create panels without manually editing JSON.

**Acceptance Criteria**:
- [x] Visual UI with 4 sections (Roles, Villages, Attributes, Consents)
- [x] Role checkboxes for all 6 roles
- [x] Village selector (all or multi-select)
- [x] Add/remove attribute predicates dynamically
- [x] Required consent checkboxes
- [x] Preview button shows estimated user count
- [x] Validation prevents saving invalid rules

**US-PANEL-002**: As a **RESEARCHER**, I want to preview how many users match my eligibility criteria before creating a panel so I know if I'll meet my target size.

**Acceptance Criteria**:
- [x] Preview button fetches count from API
- [x] Shows sample user list (first 10)
- [x] Displays quota projections (e.g., 40% Reception, 60% FOH)
- [x] Updates dynamically when rules change
- [x] Loading state while fetching

**US-PANEL-003**: As a **RESEARCHER**, I want to invite users to my panel in bulk so I don't have to invite them one by one.

**Acceptance Criteria**:
- [x] Bulk invite dialog with user search
- [x] Multi-select from eligible users
- [x] Eligibility validation before adding
- [x] Consent checking (skip users without required consents)
- [x] Summary shows added/skipped with reasons
- [x] Quota progress updates after invite

---

### 5.3 Questionnaires

**US-QUEST-001**: As a **RESEARCHER**, I want a visual question builder so I can create multi-language questionnaires without manual JSON editing.

**Acceptance Criteria**:
- [x] Add/remove/reorder questions
- [x] Support 6 question types (Likert, NPS, MCQ, Text, Number)
- [x] EN/FR translation fields for each question
- [x] Type-specific configuration (scale, options, limits)
- [x] Required checkbox per question
- [x] Language toggle to preview EN/FR versions
- [x] Validation requires both translations before publish

**US-QUEST-002**: As a **RESEARCHER**, I want to see NPS scores and distribution charts for my questionnaire responses so I can analyze results visually.

**Acceptance Criteria**:
- [x] Analytics page shows overview (total responses, completion rate)
- [x] NPS questions display: NPS score, promoters/passives/detractors counts, pie chart
- [x] Likert questions display: distribution bar chart, mean, median
- [x] MCQ questions display: option distribution bar chart
- [x] Text questions display: response count, sample responses (first 10)
- [x] Segmentation by village, role, panel

**US-QUEST-003**: As a **PM**, I want to export questionnaire responses as CSV with PII so I can do deeper analysis in Excel.

**Acceptance Criteria**:
- [x] Export button on analytics page
- [x] Format options: CSV, JSON
- [x] PII toggle (only for RESEARCHER/ADMIN)
- [x] Segment filter (all, by village, by role, by panel)
- [x] CSV includes headers: respondent_id, email, completed_at, village_id, role, q1, q2, ...
- [x] Download triggers immediately (no email link)

**US-QUEST-004**: As a **USER**, I want to respond to questionnaires in my preferred language (French) so I can understand questions clearly.

**Acceptance Criteria**:
- [x] Questionnaire response page detects user's preferredLanguage from session
- [x] Questions display in user's language (EN or FR)
- [x] Language toggle allows switching mid-response
- [x] Responses saved language-agnostic (just values)

---

### 5.4 Feedback Enhancement

**US-FEED-002**: As a **USER**, I want to specify which product area my feedback relates to so PMs can route it correctly.

**Acceptance Criteria**:
- [x] Product Area dropdown on feedback form
- [x] Options: Reservations, Check-in, Payments, Housekeeping, Backoffice
- [x] Optional field (can submit without selecting)
- [x] Feedback list page shows product area filter
- [x] Feedback detail page displays product area badge

**US-FEED-003**: As a **USER**, I want the village context field to auto-populate with my current village so I don't have to select it manually.

**Acceptance Criteria**:
- [x] Village dropdown pre-fills with user's currentVillageId
- [x] User can change to different village or "No specific village"
- [x] Optional field (can submit without village)
- [x] Feedback list page shows village filter
- [x] Feedback detail page displays village name

**US-FEED-004**: As a **PM**, I want to filter feedback by product area so I can review only feedback relevant to my domain.

**Acceptance Criteria**:
- [x] Feedback list page has product area filter dropdown
- [x] Filter updates URL query parameter (?productArea=CheckIn)
- [x] Results update without page reload
- [x] Filter persists across page navigation
- [x] Can combine with other filters (state, village, search)

---

## 6. Accessibility Requirements

### 6.1 Sidebar Navigation Accessibility

**Keyboard Navigation**:
- Tab: Navigate through sidebar items
- Enter/Space: Activate links
- Arrow keys: Navigate within Research submenu
- Escape: Close mobile drawer
- Ctrl+B: Toggle sidebar collapse

**Screen Reader Support**:
- `<aside aria-label="Main navigation">`
- `<nav role="navigation">`
- Active link: `aria-current="page"`
- Expandable item: `aria-expanded="true/false"`
- Collapse toggle: `aria-label="Collapse sidebar"` / `aria-label="Expand sidebar"`
- Tooltips: `role="tooltip"` with `aria-describedby`

**Focus Management**:
- Visible focus ring (2px, ring-primary)
- Focus trap in mobile drawer
- Focus return after closing drawer
- Skip link: "Skip to main content"

**Color Contrast**:
- Active link: 4.5:1 minimum (text + left border indicator)
- Hover state: 4.5:1 minimum
- Icons: Same contrast as text

### 6.2 Research Forms Accessibility

**EligibilityRulesBuilder**:
- Fieldset/legend for each section
- Checkbox labels properly associated
- Aria-live region for preview results
- Error messages with `aria-describedby`

**QuestionBuilder**:
- Drag-and-drop alternative: ↑↓ buttons
- Language toggle: Clear visual indicator
- Required fields: `aria-required="true"`
- Dynamic fields: Announce additions/removals

**Analytics Dashboard**:
- Charts: Text alternatives for screen readers
- Data tables: Proper headers and scope
- Export button: Clear loading state

---

## 7. Implementation Plan

### 7.1 Phase 1: Sidebar Navigation (Week 1)

**Day 1-2: Core Sidebar**
1. Install shadcn sidebar component
2. Create `app-sidebar.tsx` with role filtering
3. Create `app-header.tsx` with breadcrumbs
4. Create `app-layout.tsx` with SidebarProvider
5. Update `(authenticated)/layout.tsx` to use AppLayout

**Day 3: Research Submenu**
6. Make Research expandable with 3 sub-items
7. Change Research link to `/research/sessions`
8. Add localStorage persistence for expanded state
9. Test navigation across all pages

**Day 4: Mobile & Polish**
10. Test mobile drawer behavior
11. Remove Profile link from user dropdown
12. Remove dashboard sub-header
13. Add keyboard shortcuts (Ctrl+B)
14. Accessibility audit

**Day 5: Testing**
15. Test with all 6 roles (USER, PM, PO, RESEARCHER, MODERATOR, ADMIN)
16. Test responsive breakpoints
17. Test state persistence
18. Fix bugs

---

### 7.2 Phase 2: Research Panels (Week 2-3)

**Week 2: Data & API**
1. Update Prisma schema (description, createdById, archived)
2. Run migration
3. Implement PATCH /api/panels/[id]
4. Implement DELETE /api/panels/[id]
5. Implement POST /api/panels/[id]/members (bulk invite)
6. Implement GET /api/panels/[id]/eligibility-preview
7. Write API tests

**Week 3: UI Components**
8. Build EligibilityRulesBuilder component ⭐
9. Build EligibilityPreview modal
10. Build InviteMembersDialog
11. Build QuotaManager component
12. Update PanelForm with new components
13. Update PanelList with search/filters
14. Add panel archive functionality
15. E2E tests

---

### 7.3 Phase 3: Questionnaires (Week 4-5)

**Week 4: Question Builder & Analytics**
1. Build QuestionBuilder component ⭐
2. Add language toggle (EN/FR)
3. Support all 6 question types
4. Build TargetingConfig component
5. Implement PATCH /api/questionnaires/[id]
6. Enhance POST /api/questionnaires/[id]/publish
7. Implement analytics computation service
8. Build AnalyticsDashboard component ⭐
9. Add NPS/Likert/MCQ charts

**Week 5: Export & Polish**
10. Implement GET /api/questionnaires/[id]/export
11. Build ExportDialog component
12. Add CSV generation
13. Add PII handling
14. Add segmentation (village, role, panel)
15. Multi-language response rendering
16. E2E tests

---

### 7.4 Phase 4: Feedback Enhancement (Week 6)

**Day 1-2: Schema & API**
1. Add ProductArea enum to Prisma schema
2. Run migration
3. Update POST /api/feedback to accept productArea
4. Update GET /api/feedback to filter by productArea
5. API tests

**Day 3-4: UI**
6. Add villageContext dropdown to feedback form
7. Add productArea dropdown to feedback form
8. Auto-populate villageContext with currentVillageId
9. Add productArea filter to feedback list
10. Display productArea badge on feedback cards

**Day 5: Testing**
11. Test form submission with new fields
12. Test filtering
13. Test with/without optional fields
14. Accessibility audit

---

### 7.5 Phase 5: Testing & Documentation (Week 7)

1. Complete accessibility audit (WCAG 2.1 AA)
2. Performance testing (Lighthouse)
3. Cross-browser testing (Chrome, Firefox, Safari, Edge)
4. Mobile testing (iOS Safari, Android Chrome)
5. Load testing (100+ concurrent users)
6. Write user documentation
7. Write developer documentation
8. Update CLAUDE.md
9. Record demo videos
10. UAT with stakeholders

---

## 8. Testing Strategy

### 8.1 Unit Tests

**Eligibility Logic**:
```typescript
describe('Panel Eligibility', () => {
  it('should match user with correct role and consent', () => {
    const rules = {
      include_roles: ['USER'],
      required_consents: ['research_contact']
    };
    const user = { role: 'USER', consents: ['research_contact'] };
    expect(checkEligibility(user, rules)).toBe(true);
  });
});
```

**Analytics Computation**:
```typescript
describe('NPS Calculation', () => {
  it('should calculate NPS correctly', () => {
    const scores = [9, 10, 10, 7, 8, 5, 3, 2, 9, 10];
    const result = computeNPS(scores);
    expect(result.npsScore).toBe(20); // (5 promoters - 3 detractors) / 10 * 100
  });
});
```

### 8.2 Integration Tests

**API Tests**:
```typescript
describe('POST /api/panels', () => {
  it('should create panel with valid eligibility rules', async () => {
    const response = await POST(request);
    expect(response.status).toBe(201);
    expect(response.data.name).toBe('Test Panel');
  });

  it('should reject without RESEARCHER role', async () => {
    // Mock USER role
    const response = await POST(request);
    expect(response.status).toBe(403);
  });
});
```

### 8.3 E2E Tests

**Playwright**:
```typescript
test('RESEARCHER can create panel with eligibility preview', async ({ page }) => {
  await page.goto('/research/panels/new');
  await page.fill('#name', 'Reception Panel');
  await page.check('#role-USER');
  await page.click('text=Preview Eligible Users');
  await expect(page.locator('text=45 users match')).toBeVisible();
  await page.click('text=Create Panel');
  await expect(page).toHaveURL(/\/research\/panels\/pan_/);
});
```

---

## 9. Success Metrics (Post-Launch)

| Metric | Target | Measurement |
|--------|--------|-------------|
| **Navigation** |
| Sidebar adoption | 100% of pages | Page analytics |
| Collapse feature usage | >40% of users | localStorage stats |
| Mobile drawer usability | >4.5/5 | User survey |
| **Research Panels** |
| Panel creation success rate | >90% | Backend logs |
| Eligibility preview usage | >70% of panels | Event tracking |
| Average panel size | 100-200 members | Database query |
| **Questionnaires** |
| Questionnaire creation success | >85% | Backend logs |
| Response rate (panel-targeted) | >60% | Responses / audience |
| Analytics page views | >80% of questionnaires | Page analytics |
| Export usage | >30% of questionnaires | API logs |
| **Feedback** |
| ProductArea completion rate | >70% | Field population stats |
| VillageContext completion rate | >60% | Field population stats |
| Filtering usage | +30% filter clicks | Event tracking |
| **Overall** |
| WCAG 2.1 AA compliance | 100% | Lighthouse audit |
| Lighthouse Performance | ≥90 | Lighthouse CI |
| User satisfaction | ≥4.2/5 | Post-deployment survey |

---

## 10. Risks & Mitigation

### 10.1 Technical Risks

**Risk 1**: Sidebar state hydration mismatch (SSR vs client)
- **Impact**: High (layout shift on page load)
- **Likelihood**: Medium
- **Mitigation**: Use `mounted` flag, render skeleton until hydrated

**Risk 2**: Complex eligibility rules cause performance issues
- **Impact**: Medium (slow panel creation)
- **Likelihood**: Low
- **Mitigation**: Optimize eligibility query with proper indexes, add pagination to preview

**Risk 3**: Multi-language support increases form complexity
- **Impact**: Medium (harder to validate)
- **Likelihood**: Medium
- **Mitigation**: Clear validation messages, require both translations before publish

### 10.2 UX Risks

**Risk 4**: Users don't discover Research submenu
- **Impact**: Medium (low feature adoption)
- **Likelihood**: Low (chevron icon indicates expandable)
- **Mitigation**: Default to expanded on first visit, show tooltip

**Risk 5**: Question builder is too complex for non-technical researchers
- **Impact**: High (low questionnaire creation)
- **Likelihood**: Medium
- **Mitigation**: Add templates, contextual help, example questions

---

## 11. Dependencies

### 11.1 External Dependencies

```bash
# shadcn components (add if not present)
npx shadcn@latest add sidebar
npx shadcn@latest add avatar
npx shadcn@latest add dropdown-menu
npx shadcn@latest add tooltip
npx shadcn@latest add scroll-area

# Chart library for analytics
npm install recharts
```

### 11.2 Internal Dependencies

- Prisma schema updates (Panel, Feedback)
- Authentication system (session, roles)
- Existing API patterns (/api/feedback, /api/panels, /api/questionnaires)

---

## 12. Out of Scope (Future Enhancements)

**Deferred to Future PRDs**:
- [ ] Real-time collaboration on questionnaires
- [ ] Advanced text analytics (sentiment analysis, word clouds)
- [ ] Questionnaire templates library
- [ ] Panel recruitment automation (auto-invite based on rules)
- [ ] Multi-wave questionnaires (longitudinal studies)
- [ ] Integration with external survey tools (Qualtrics, SurveyMonkey)
- [ ] Panel member communication center
- [ ] Gamification for panel participation
- [ ] Advanced quota management (stratified sampling)
- [ ] A/B testing for questionnaire variations

---

## 13. Documentation Requirements

### 13.1 User-Facing Documentation

**User Guide Updates**:
- Navigation: How to use sidebar, collapse/expand, mobile drawer
- Research Panels: Creating panels, setting eligibility, inviting members
- Questionnaires: Building questions, publishing, viewing analytics, exporting
- Feedback: Using productArea and villageContext fields

### 13.2 Developer Documentation

**Technical Docs**:
- `docs/SIDEBAR-NAVIGATION.md` - Architecture and customization
- `docs/RESEARCH-FEATURES.md` - API reference and component guide
- `docs/ANALYTICS-COMPUTATION.md` - Analytics algorithms and formulas
- Update `CLAUDE.md` with new patterns

---

## 14. Rollout Plan

### 14.1 Pre-Launch Checklist

- [ ] All features implemented and tested
- [ ] Accessibility audit passed (WCAG 2.1 AA)
- [ ] Performance audit passed (Lighthouse ≥90)
- [ ] Cross-browser testing completed
- [ ] Mobile testing completed
- [ ] Documentation updated
- [ ] Demo videos recorded
- [ ] Stakeholder approval received

### 14.2 Launch

**Phased Rollout**:
1. **Week 1**: Internal testing with PM team (5 users)
2. **Week 2**: Beta with RESEARCHER role users (20 users)
3. **Week 3**: Full rollout to all users

**Monitoring**:
- Error tracking (Sentry or similar)
- Performance monitoring (Lighthouse CI)
- User feedback collection (in-app survey)
- Analytics tracking (feature usage)

### 14.3 Post-Launch

- [ ] Monitor error logs for 48 hours
- [ ] Collect user feedback (survey after 1 week)
- [ ] Address critical bugs within 24 hours
- [ ] Plan iteration based on feedback
- [ ] Update changelog
- [ ] Create GitHub release (v0.6.0)

---

## 15. Appendix

### 15.1 Sidebar Navigation Wireframes

**Desktop (Expanded)**:
```
┌──────────────────────────────────────────────────┐
│ [Odyssey] Breadcrumbs        [🔔] [JD ▼]        │
├─────────┬────────────────────────────────────────┤
│ 📊 Dash │                                        │
│ ━━━━━━━ │                                        │
│ PRODUCT │         Main Content                   │
│ 💬 Feed │                                        │
│ 🏷️ Feat │                                        │
│ 🗺️ Road │                                        │
│ ━━━━━━━ │                                        │
│ INSIGHTS│                                        │
│ 🔬 Rese▼│                                        │
│  · Sess │                                        │
│  · Pane │                                        │
│  · Ques │                                        │
│ 📊 Anal │                                        │
│ [<]     │                                        │
└─────────┴────────────────────────────────────────┘
```

**Desktop (Collapsed)**:
```
┌──────────────────────────────────────────────────┐
│ [📱] Breadcrumbs             [🔔] [JD ▼]        │
├───┬──────────────────────────────────────────────┤
│ 📊│                                              │
│━━━│                                              │
│ 💬│         Main Content                         │
│ 🏷️│         (More space)                        │
│ 🗺️│                                              │
│━━━│                                              │
│ 🔬│                                              │
│ 📊│                                              │
│[>]│                                              │
└───┴──────────────────────────────────────────────┘
```

**Mobile**:
```
┌────────────────────────────────────┐
│ [☰] Page Title      [🔔] [JD ▼]   │
├────────────────────────────────────┤
│                                    │
│         Main Content               │
│         (Full Width)               │
│                                    │
└────────────────────────────────────┘

[☰ tapped]
┌──────────────┬─────────────────────┐
│ Odyssey [×] │                     │
│━━━━━━━━━━━━━│   (Backdrop)        │
│ Dashboard    │                     │
│ PRODUCT      │                     │
│ Feedback     │                     │
│ Features     │                     │
│ Roadmap      │                     │
│ INSIGHTS     │                     │
│ Research     │                     │
│ Analytics    │                     │
└──────────────┴─────────────────────┘
```

### 15.2 Component Hierarchy

```
app/(authenticated)/
├── layout.tsx (Server - fetches session)
│   └── <AppLayout> (Client - sidebar state)
│       ├── <AppSidebar> (Client)
│       │   ├── <SidebarHeader> (logo)
│       │   ├── <SidebarContent>
│       │   │   ├── Dashboard
│       │   │   ├── PRODUCT section
│       │   │   │   ├── Feedback
│       │   │   │   ├── Features
│       │   │   │   └── Roadmap
│       │   │   ├── INSIGHTS section
│       │   │   │   ├── Research (expandable)
│       │   │   │   │   ├── Sessions
│       │   │   │   │   ├── Panels
│       │   │   │   │   └── Questionnaires
│       │   │   │   └── Analytics
│       │   │   └── ADMIN section
│       │   │       ├── Moderation
│       │   │       └── Admin
│       │   └── <SidebarFooter>
│       │       └── <NavUser>
│       ├── <SidebarInset>
│       │   ├── <AppHeader>
│       │   │   ├── <SidebarTrigger>
│       │   │   ├── Breadcrumbs
│       │   │   └── <NotificationBell>
│       │   └── <main>{children}</main>
```

---

**Document Version**: 1.0
**Author**: Product Team
**Approvers**: PO, Engineering Lead, UX Lead, RESEARCHER Lead
**Next Review**: After stakeholder approval

---

## Changelog

**v1.0** (2025-10-03):
- Initial draft
- Added all 4 improvement areas
- Included technical specifications from agent consultations
- Added comprehensive user stories and acceptance criteria
