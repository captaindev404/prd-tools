// This is your Prisma schema file for Infinite Stories Backend API
// Based on SwiftData models from the iOS app

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model (from Better Auth)
model User {
  id String @id @default(cuid())
  email String @unique
  emailVerified Boolean @default(false)
  name String?
  image String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  heroes Hero[]
  customEvents CustomStoryEvent[]
  sessions Session[]
  accounts Account[]

  // Usage tracking
  totalStoriesGenerated Int @default(0)
  totalAudioGenerated Int @default(0)
  totalIllustrationsGenerated Int @default(0)
  lastStoryGeneratedAt DateTime?

  @@index([email])
}

// Better Auth Session model
model Session {
  id String @id @default(cuid())
  expiresAt DateTime
  token String @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// Better Auth Account model
model Account {
  id String @id @default(cuid())
  accountId String
  providerId String
  userId String
  accessToken String?
  refreshToken String?
  idToken String?
  accessTokenExpiresAt DateTime?
  refreshTokenExpiresAt DateTime?
  scope String?
  password String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

// Better Auth Verification model
model Verification {
  id String @id @default(cuid())
  identifier String
  value String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([identifier, value])
}

// Hero (Character) model
model Hero {
  id String @id @default(cuid())
  name String
  age Int
  userId String

  // Physical traits
  hairColor String?
  eyeColor String?
  skinTone String?
  height String?

  // Personality traits (JSON array)
  traits Json // Array of trait enum values

  // Special abilities
  specialAbilities Json? // Array of abilities

  // Free-form appearance description
  appearance String? @db.Text

  // Avatar
  avatarUrl String?
  avatarPrompt String?
  avatarGenerationId String? // For multi-turn consistency

  // Visual profile for consistency
  visualProfileId String? @unique
  visualProfile HeroVisualProfile?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  stories Story[]

  @@index([userId])
  @@index([name])
}

// Hero Visual Profile for character consistency
model HeroVisualProfile {
  id String @id @default(cuid())
  heroId String @unique

  // Detailed visual characteristics
  hairStyle String?
  hairColor String?
  hairTexture String?
  eyeColor String?
  eyeShape String?
  skinTone String?
  facialFeatures String?
  bodyType String?
  height String?
  age Int?

  // Clothing and style
  typicalClothing String?
  colorPalette Json? // Array of colors
  accessories String?

  // Art style
  artStyle String?
  visualKeywords Json? // Array of style keywords

  // Prompts
  canonicalPrompt String? @db.Text
  simplifiedPrompt String? @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  hero Hero @relation(fields: [heroId], references: [id], onDelete: Cascade)

  @@index([heroId])
}

// Story model
model Story {
  id String @id @default(cuid())
  heroId String
  userId String

  // Content
  title String
  content String @db.Text
  language String @default("en")

  // Event context
  eventType String? // Built-in event type
  customEventId String? // Custom event reference

  // Audio
  audioUrl String?
  audioGenerationStatus String @default("pending") // pending, processing, completed, failed
  audioGenerationError String? @db.Text
  audioDuration Float? // in seconds

  // Illustrations
  illustrationStatus String @default("none") // none, pending, processing, completed, partial, failed
  illustrationCount Int @default(0)

  // Metadata
  isFavorite Boolean @default(false)
  lastPlayedAt DateTime?
  playCount Int @default(0)
  generationMetadata Json? // Stores generation parameters

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  hero Hero @relation(fields: [heroId], references: [id], onDelete: Cascade)
  customEvent CustomStoryEvent? @relation(fields: [customEventId], references: [id], onDelete: SetNull)
  illustrations StoryIllustration[]

  @@index([heroId])
  @@index([userId])
  @@index([customEventId])
  @@index([createdAt])
  @@index([isFavorite])
}

// Story Illustration model
model StoryIllustration {
  id String @id @default(cuid())
  storyId String

  // Content
  imageUrl String
  imagePrompt String @db.Text
  sceneDescription String @db.Text
  displayOrder Int

  // Audio synchronization
  audioTimestamp Float // in seconds
  audioDuration Float? // duration of this scene

  // Generation metadata
  generationId String? // For multi-turn consistency
  previousGenerationId String? // References previous image in multi-turn chain
  generationStatus String @default("pending") // pending, processing, completed, failed
  generationError String? @db.Text
  retryCount Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([storyId])
  @@index([displayOrder])
  @@index([audioTimestamp])
}

// Custom Story Event model
model CustomStoryEvent {
  id String @id @default(cuid())
  userId String

  // Content
  title String
  description String @db.Text
  promptSeed String @db.Text

  // Categorization
  category String @default("general")
  ageRange String? // e.g., "3-5", "6-8", "9-12"
  tone String @default("cheerful")

  // Visual representation
  pictogramEmoji String?
  pictogramSymbols Json? // Array of emoji/symbols

  // AI Enhancement
  aiEnhanced Boolean @default(false)
  aiEnhancementMetadata Json?
  keywords Json? // Array of keywords

  // Usage tracking
  usageCount Int @default(0)
  isFavorite Boolean @default(false)
  lastUsedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  stories Story[]

  @@index([userId])
  @@index([category])
  @@index([usageCount])
  @@index([isFavorite])
}

// API Usage Tracking model
model ApiUsage {
  id String @id @default(cuid())
  userId String

  // Operation details
  operation String // story_generation, audio_generation, avatar_generation, illustration_generation
  model String // gpt-4o, gpt-4o-mini-tts, dall-e-3, etc.

  // Tokens and costs
  tokensUsed Int?
  estimatedCost Float? // in USD

  // Request metadata
  requestDuration Int? // in milliseconds
  success Boolean @default(true)
  errorMessage String? @db.Text

  // Timestamp
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([operation])
  @@index([createdAt])
}

// Background Job model (for async processing)
model BackgroundJob {
  id String @id @default(cuid())
  type String // audio_generation, illustration_generation, etc.
  status String @default("pending") // pending, processing, completed, failed

  // Job data
  payload Json
  result Json?
  error String? @db.Text

  // Processing metadata
  attempts Int @default(0)
  maxAttempts Int @default(3)
  processingStartedAt DateTime?
  processingCompletedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([createdAt])
}

// Listening Session model (for Reading Journey analytics)
model ListeningSession {
  id String @id @default(cuid())
  userId String
  storyId String

  // Session timing
  startedAt DateTime @default(now())
  endedAt DateTime?
  duration Int? // in seconds, capped at 1.5x story audioDuration

  // Completion tracking
  completed Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([storyId])
  @@index([startedAt])
  @@index([completed])
}

// User Analytics Cache model (for pre-computed reading journey stats)
model UserAnalyticsCache {
  id String @id @default(cuid())
  userId String @unique

  // Story listening stats
  totalStoriesListened Int @default(0)
  totalListeningTimeSeconds Int @default(0) // total seconds of audio listened

  // Streak tracking
  currentStreak Int @default(0) // consecutive days with listening activity
  longestStreak Int @default(0) // all-time longest streak
  lastListeningDate DateTime? // last date user listened to a story (date only, no time)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([lastListeningDate])
}

// User Milestone model (for achievement tracking)
model UserMilestone {
  id String @id @default(cuid())
  userId String
  milestoneId String // e.g., "FIRST_STORY", "STORIES_5", "LISTENING_1H"

  // Unlock tracking
  unlockedAt DateTime @default(now())

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, milestoneId])
  @@index([userId])
  @@index([milestoneId])
  @@index([unlockedAt])
}
